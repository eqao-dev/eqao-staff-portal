<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²å½“ | EQAO Staff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      color: #333;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: #111;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #aaa;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .header-divider {
      width: 1px;
      height: 20px;
      background: #444;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .user-menu {
      position: relative;
    }

    .user-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .user-name {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .page-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: #111;
    }

    .month-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-selector select {
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    .month-selector select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #111;
    }

    .stat-value.warning {
      color: #f59e0b;
    }

    .stat-value.success {
      color: #10b981;
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #667eea;
    }

    .filter-btn.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-container {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      overflow: hidden;
    }

    .table-scroll {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    th,
    td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: #f8f9fa;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      font-size: 14px;
    }

    tr:hover {
      background: #fafafa;
    }

    .student-name {
      font-weight: 600;
      color: #111;
    }

    .instructor-tag {
      display: inline-block;
      padding: 4px 10px;
      background: #fef3c7;
      color: #92400e;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .instructor-tag.designated {
      background: #fee2e2;
      color: #dc2626;
    }

    .lessons-cell {
      text-align: center;
    }

    .lessons-assigned {
      font-weight: 600;
      color: #667eea;
    }

    .lessons-remaining {
      color: #ef4444;
      font-weight: 600;
    }

    .lessons-remaining.done {
      color: #10b981;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.unassigned {
      background: #f1f5f9;
      color: #64748b;
    }

    .status-badge.in-progress {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.completed {
      background: #d1fae5;
      color: #065f46;
    }

    .edit-btn {
      padding: 6px 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-btn:hover {
      background: #5a6fd6;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: all 0.3s;
    }

    .modal-overlay.show .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: #f1f5f9;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #e2e8f0;
    }

    .modal-body {
      padding: 24px;
    }

    .student-info {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .student-info-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .student-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .student-info-label {
      font-size: 12px;
      color: #64748b;
    }

    .student-info-value {
      font-size: 14px;
      font-weight: 600;
      color: #111;
    }

    .course-section {
      margin-bottom: 28px;
    }

    .course-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .course-title {
      font-size: 15px;
      font-weight: 700;
      color: #111;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .course-title .badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .course-title .badge.normal {
      background: #e0f2fe;
      color: #0369a1;
    }

    .course-title .badge.english {
      background: #fce7f3;
      color: #be185d;
    }

    .course-stats {
      font-size: 13px;
      color: #64748b;
    }

    .course-stats span {
      font-weight: 600;
      color: #111;
    }

    .assignment-list {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .assignment-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .assignment-item:last-child {
      border-bottom: none;
    }

    .assignment-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .assignment-instructor {
      font-weight: 600;
      color: #111;
    }

    .assignment-lessons {
      color: #64748b;
    }

    .assignment-tag {
      padding: 2px 8px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .assignment-capacity {
      font-size: 12px;
      color: #64748b;
    }

    .assignment-capacity.warning {
      color: #f59e0b;
    }

    .assignment-delete {
      padding: 6px;
      border: none;
      background: none;
      color: #94a3b8;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .assignment-delete:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .empty-state {
      padding: 24px;
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
    }

    .add-instructor-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed #e2e8f0;
      border-radius: 10px;
      background: white;
      color: #64748b;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .add-instructor-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    /* è¬›å¸«è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
    .add-form {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
      display: none;
    }

    .add-form.show {
      display: block;
    }

    .add-form-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .add-form-group {
      flex: 1;
      min-width: 150px;
    }

    .add-form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 6px;
    }

    .add-form-group select,
    .add-form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .add-form-group select:focus,
    .add-form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .add-form-actions {
      display: flex;
      gap: 8px;
    }

    .add-form-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-form-btn.primary {
      background: #667eea;
      color: white;
    }

    .add-form-btn.primary:hover {
      background: #5a6fd6;
    }

    .add-form-btn.secondary {
      background: #e2e8f0;
      color: #64748b;
    }

    .add-form-btn.secondary:hover {
      background: #cbd5e1;
    }

    .capacity-warning {
      margin-top: 8px;
      padding: 8px 12px;
      background: #fef3c7;
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
      display: none;
    }

    .capacity-warning.show {
      display: block;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e5e5;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.secondary {
      background: #e2e8f0;
      color: #64748b;
    }

    .modal-btn.secondary:hover {
      background: #cbd5e1;
    }

    .modal-btn.primary {
      background: #667eea;
      color: white;
    }

    .modal-btn.primary:hover {
      background: #5a6fd6;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 16px;
      color: #667eea;
      font-weight: 600;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer {
      text-align: center;
      padding: 32px 24px;
      margin-top: 20px;
    }

    .footer-text {
      font-size: 13px;
      color: #999;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .main {
        padding: 24px 16px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .user-name {
        display: none;
      }
    }

    .hidden {
      display: none !important;
    }

    /* é€šå¸¸ã‚³ãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .course-section.normal {
      background: #f0f9ff;
      border: 2px solid #0ea5e9;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    /* è‹±èªã‚³ãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .course-section.english {
      background: #fdf2f8;
      border: 2px solid #ec4899;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }

    /* å‰²å½“æ¸ˆã¿ãƒªã‚¹ãƒˆ */
    .assignment-list {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    /* è¬›å¸«è¿½åŠ ãƒœã‚¿ãƒ³ */
    .add-instructor-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed #94a3b8;
      border-radius: 10px;
      background: transparent;
      color: #64748b;
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .add-instructor-btn:hover {
      border-color: #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    /* è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */
    .add-form {
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
      display: none;
    }

    .add-form.show {
      display: block;
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-cell {
      min-width: 140px;
    }

    .progress-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .progress-fill.normal {
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }

    .progress-fill.english {
      background: linear-gradient(90deg, #ec4899, #f472b6);
    }

    .progress-fill.complete {
      background: linear-gradient(90deg, #10b981, #34d399);
    }

    .progress-text {
      font-size: 12px;
      color: #64748b;
      text-align: center;
    }

    .progress-text span {
      font-weight: 700;
      color: #111;
    }

    .progress-text .remaining {
      color: #ef4444;
    }

    .progress-text .done {
      color: #10b981;
    }

    .assignment-capacity.not-submitted {
      color: #94a3b8;
      font-style: italic;
    }

    .assignment-capacity.warning {
      color: #ef4444;
      font-weight: 600;
    }

    /* æœªä¿å­˜ã®å‰²å½“ */
    .assignment-item.pending {
      background: #fefce8;
      border-left: 3px solid #eab308;
    }

    .pending-mark {
      background: #eab308;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 700;
      margin-left: 8px;
    }

    /* ä¿å­˜ãƒœã‚¿ãƒ³ */
    .save-assignments-btn {
      flex: 1;
      padding: 14px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      margin-top: 16px;
    }

    .save-assignments-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .save-assignments-btn.hidden {
      display: none;
    }

    /* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ */
    .page-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    /* è¨­å®šãƒœã‚¿ãƒ³ */
    .settings-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }

    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .settings-modal .modal {
      max-width: 500px;
    }

    .settings-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .settings-select {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      width: 100%;
      max-width: 280px;
      text-align: center;
    }

    .settings-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      text-align: center;
    }

    .settings-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .settings-select {
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .settings-select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
    .toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .toggle-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .toggle-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .toggle-desc {
      font-size: 12px;
      color: #64748b;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: #10b981;
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(22px);
    }

    .settings-save-btn {
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .settings-save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .month-label {
      font-size: 14px;
      color: #64748b;
      margin-left: 4px;
    }

    .settings-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 8px;
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="staff-schedule.html" class="back-btn">
          <i data-lucide="arrow-left" style="width:16px;height:16px;"></i>
          æˆ»ã‚‹
        </a>
        <div class="header-divider"></div>
        <span class="header-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²å½“</span>
      </div>
      <div class="user-menu">
        <button class="user-btn" id="userBtn">
          <div class="user-avatar" id="userAvatar">-</div>
          <span class="user-name" id="userName">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</span>
          <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="page-header">
      <div class="page-header-left">
        <div class="page-icon">
          <i data-lucide="calendar-check" style="width:24px;height:24px;"></i>
        </div>
        <h1 class="page-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²å½“</h1>
      </div>
      <div class="page-header-right">
        <div class="month-selector">
          <select id="yearMonth" onchange="loadData()">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </select>
          <span class="month-label">ã®å‰²å½“ä¸€è¦§</span>
        </div>
        <button class="settings-btn" onclick="openSettingsModal()">
          <i data-lucide="settings" style="width:18px;height:18px;"></i>
          è¨­å®š
        </button>
      </div>
    </div>

    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">ç”³è«‹ç”Ÿå¾’æ•°</div>
        <div class="stat-value" id="statTotal">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æœªå‰²å½“</div>
        <div class="stat-value warning" id="statUnassigned">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å‰²å½“ä¸­</div>
        <div class="stat-value" id="statInProgress">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å‰²å½“å®Œäº†</div>
        <div class="stat-value success" id="statCompleted">-</div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">å…¨ã¦</button>
      <button class="filter-btn" data-filter="unassigned" onclick="setFilter('unassigned')">æœªå‰²å½“</button>
      <button class="filter-btn" data-filter="in-progress" onclick="setFilter('in-progress')">å‰²å½“ä¸­</button>
      <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">å‰²å½“å®Œäº†</button>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” ç”Ÿå¾’åã§æ¤œç´¢..." oninput="filterTable()">
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-container">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>ç”Ÿå¾’å</th>
              <th>æŒ‡åè¬›å¸«</th>
              <th>å¸Œæœ›è¬›å¸«</th>
              <th>é€šå¸¸ã‚³ãƒ</th>
              <th>è‹±èªã‚³ãƒ</th>
              <th>çŠ¶æ…‹</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p class="footer-text">Â© 2026 EQAO Education Group.</p>
  </footer>

  <!-- å‰²å½“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="assignmentModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">å‰²å½“ç·¨é›†</h2>
        <button class="modal-close" onclick="closeModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- ç”Ÿå¾’æƒ…å ± -->
        <div class="student-info">
          <div class="student-info-row">
            <div class="student-info-item">
              <span class="student-info-label">æ‹…ä»»:</span>
              <span class="student-info-value" id="modalHomeroom">-</span>
            </div>
            <div class="student-info-item">
              <span class="student-info-label">æŒ‡åè¬›å¸«:</span>
              <span class="student-info-value" id="modalDesignated">-</span>
            </div>
            <div class="student-info-item">
              <span class="student-info-label">å¸Œæœ›è¬›å¸«:</span>
              <span class="student-info-value" id="modalPreferred">-</span>
            </div>
          </div>
          <div class="student-info-row" id="lastMonthRow" style="margin-top: 12px;">
            <div class="student-info-item" style="width: 100%;">
              <span class="student-info-label">å…ˆæœˆæ‹…å½“:</span>
              <span class="student-info-value" id="modalLastMonth">-</span>
            </div>
          </div>
        </div>

        <!-- é€šå¸¸ã‚³ãƒ -->
        <div class="course-section normal" id="normalSection">
          <div class="course-header">
            <div class="course-title">
              <span class="badge normal">é€šå¸¸</span>
              é€šå¸¸ã‚³ãƒ
            </div>
            <div class="course-stats">
              å¸Œæœ›: <span id="normalWanted">0</span> ï¼
              å‰²å½“: <span id="normalAssigned">0</span> ï¼
              æ®‹ã‚Š: <span id="normalRemaining">0</span>
            </div>
          </div>
          <div class="assignment-list" id="normalAssignmentList">
            <div class="empty-state">å‰²å½“ãªã—</div>
          </div>
          <button class="add-instructor-btn" onclick="showAddForm('normal')">
            <i data-lucide="plus" style="width:16px;height:16px;"></i>
            è¬›å¸«ã‚’è¿½åŠ 
          </button>
          <div class="add-form" id="normalAddForm">
            <div class="add-form-row">
              <div class="add-form-group">
                <label class="add-form-label">è¬›å¸«</label>
                <select id="normalInstructorSelect" onchange="checkCapacity('normal')">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div class="add-form-group" style="max-width: 100px;">
                <label class="add-form-label">ã‚³ãƒæ•°</label>
                <input type="number" id="normalLessonsInput" min="1" value="1" onchange="checkCapacity('normal')">
              </div>
              <div class="add-form-actions">
                <button class="add-form-btn primary" onclick="addAssignment('normal')">è¿½åŠ </button>
                <button class="add-form-btn secondary" onclick="hideAddForm('normal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </div>
            <div class="capacity-warning" id="normalCapacityWarning">
              âš ï¸ ã“ã®è¬›å¸«ã¯ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™
            </div>
          </div>
        </div>

        <!-- è‹±èªã‚³ãƒ -->
        <div class="course-section english" id="englishSection">
          <div class="course-header">
            <div class="course-title">
              <span class="badge english">è‹±èª</span>
              è‹±èªã‚³ãƒ
            </div>
            <div class="course-stats">
              å¸Œæœ›: <span id="englishWanted">0</span> ï¼
              å‰²å½“: <span id="englishAssigned">0</span> ï¼
              æ®‹ã‚Š: <span id="englishRemaining">0</span>
            </div>
          </div>
          <div class="assignment-list" id="englishAssignmentList">
            <div class="empty-state">å‰²å½“ãªã—</div>
          </div>
          <button class="add-instructor-btn" onclick="showAddForm('english')">
            <i data-lucide="plus" style="width:16px;height:16px;"></i>
            è¬›å¸«ã‚’è¿½åŠ 
          </button>
          <div class="add-form" id="englishAddForm">
            <div class="add-form-row">
              <div class="add-form-group">
                <label class="add-form-label">è¬›å¸«</label>
                <select id="englishInstructorSelect" onchange="checkCapacity('english')">
                  <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>
              <div class="add-form-group" style="max-width: 100px;">
                <label class="add-form-label">ã‚³ãƒæ•°</label>
                <input type="number" id="englishLessonsInput" min="1" value="1" onchange="checkCapacity('english')">
              </div>
              <div class="add-form-actions">
                <button class="add-form-btn primary" onclick="addAssignment('english')">è¿½åŠ </button>
                <button class="add-form-btn secondary" onclick="hideAddForm('english')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </div>
            <div class="capacity-warning" id="englishCapacityWarning">
              âš ï¸ ã“ã®è¬›å¸«ã¯ä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="save-assignments-btn hidden" id="saveAssignmentsBtn" onclick="saveAllAssignments()">
          <i data-lucide="save" style="width:18px;height:18px;"></i>
          <span>ä¿å­˜</span>
        </button>
        <button class="modal-btn secondary" onclick="closeModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // APIè¨­å®š
    const API_URL = 'https://script.google.com/macros/s/AKfycbyFJMfjgZzOw9v16PEoQQrRqqYe__oSn6zHdajEXdeXaUf6ACxwBhcMaGf449Qju-t-/exec';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentYearMonth = '';
    let studentList = [];
    let instructorCapacity = [];
    let currentStudent = null;
    let currentFilter = 'all';

    // â˜…è¿½åŠ : ä¸€æ™‚çš„ãªå‰²å½“ãƒ‡ãƒ¼ã‚¿
    let pendingAssignments = {
      normal: [],
      english: []
    };

    // æ—¢å­˜å‰²å½“ãƒ‡ãƒ¼ã‚¿
    let currentAssignments = {
      normal: [],
      english: []
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();

      // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
      const session = localStorage.getItem('eqao_staff_session');
      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const sessionData = JSON.parse(session);
        if (Date.now() > sessionData.expiresAt) {
          localStorage.removeItem('eqao_staff_session');
          window.location.href = 'login.html';
          return;
        }
        displayUserInfo(sessionData);
      } catch {
        localStorage.removeItem('eqao_staff_session');
        window.location.href = 'login.html';
        return;
      }

      // æœˆé¸æŠè‚¢ã‚’ç”Ÿæˆ
      generateMonthOptions();

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await loadData();

      document.getElementById('loading').classList.add('hidden');
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
    function displayUserInfo(data) {
      const name = data.name || data.employeeId || '-';
      const initial = name.charAt(0).toUpperCase();
      document.getElementById('userAvatar').textContent = initial;
      document.getElementById('userName').textContent = name;
    }

    // æœˆé¸æŠè‚¢ã‚’ç”Ÿæˆ
    function generateMonthOptions() {
      const select = document.getElementById('yearMonth');
      const now = new Date();

      for (let i = -2; i <= 3; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const value = `${y}-${m}`;
        const label = `${y}å¹´${date.getMonth() + 1}æœˆ`;

        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;

        // ç¿Œæœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
        if (i === 1) {
          option.selected = true;
          currentYearMonth = value;
        }

        select.appendChild(option);
      }
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      const yearMonth = document.getElementById('yearMonth').value;
      currentYearMonth = yearMonth;

      document.getElementById('loading').classList.remove('hidden');

      try {
        // å‰²å½“ä¸€è¦§ã‚’å–å¾—
        const listRes = await fetch(`${API_URL}?action=getAssignmentList&yearMonth=${yearMonth}`);
        const listData = await listRes.json();

        if (listData.success) {
          studentList = listData.data;
          renderTable();
          updateStats();
        }

        // è¬›å¸«ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’å–å¾—
        const capRes = await fetch(`${API_URL}?action=getInstructorCapacity&yearMonth=${yearMonth}`);
        const capData = await capRes.json();

        if (capData.success) {
          instructorCapacity = capData.data;
        }

      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }

      document.getElementById('loading').classList.add('hidden');
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      const tbody = document.getElementById('studentTableBody');
      const searchText = document.getElementById('searchInput').value.toLowerCase();

      const filtered = studentList.filter(student => {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (currentFilter === 'unassigned' && student.status !== 'æœªå‰²å½“') return false;
        if (currentFilter === 'in-progress' && student.status !== 'å‰²å½“ä¸­') return false;
        if (currentFilter === 'completed' && student.status !== 'å‰²å½“å®Œäº†') return false;

        // æ¤œç´¢
        if (searchText && !student.studentName.toLowerCase().includes(searchText)) return false;

        return true;
      });

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" style="text-align: center; padding: 40px; color: #94a3b8;">
              è©²å½“ã™ã‚‹ç”Ÿå¾’ãŒã„ã¾ã›ã‚“
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(student => {
        const statusClass = student.status === 'æœªå‰²å½“' ? 'unassigned' :
          student.status === 'å‰²å½“ä¸­' ? 'in-progress' : 'completed';

        // é€šå¸¸ã‚³ãƒã®é€²æ—
        const normalPercent = student.normalLessonsWanted > 0
          ? Math.min(100, (student.normalLessonsAssigned / student.normalLessonsWanted) * 100)
          : 0;
        const normalComplete = student.normalRemaining === 0 && student.normalLessonsWanted > 0;

        // è‹±èªã‚³ãƒã®é€²æ—
        const englishPercent = student.englishLessonsWanted > 0
          ? Math.min(100, (student.englishLessonsAssigned / student.englishLessonsWanted) * 100)
          : 0;
        const englishComplete = student.englishRemaining === 0 && student.englishLessonsWanted > 0;

        // é€šå¸¸ã‚³ãƒè¡¨ç¤º
        const normalHtml = student.normalLessonsWanted > 0 ? `
    <div class="progress-wrapper">
      <div class="progress-bar">
        <div class="progress-fill ${normalComplete ? 'complete' : 'normal'}" style="width: ${normalPercent}%"></div>
      </div>
      <div class="progress-text">
        <span>${student.normalLessonsAssigned}</span> / ${student.normalLessonsWanted}
        ${normalComplete ? '<span class="done">âœ“</span>' : `<span class="remaining">(æ®‹${student.normalRemaining})</span>`}
      </div>
    </div>
  ` : '<span style="color:#94a3b8">-</span>';

        // è‹±èªã‚³ãƒè¡¨ç¤º
        const englishHtml = student.englishLessonsWanted > 0 ? `
    <div class="progress-wrapper">
      <div class="progress-bar">
        <div class="progress-fill ${englishComplete ? 'complete' : 'english'}" style="width: ${englishPercent}%"></div>
      </div>
      <div class="progress-text">
        <span>${student.englishLessonsAssigned}</span> / ${student.englishLessonsWanted}
        ${englishComplete ? '<span class="done">âœ“</span>' : `<span class="remaining">(æ®‹${student.englishRemaining})</span>`}
      </div>
    </div>
  ` : '<span style="color:#94a3b8">-</span>';

        return `
    <tr>
      <td class="student-name">${student.studentName}</td>
      <td>${student.designatedInstructor ? `<span class="instructor-tag designated">${student.designatedInstructor}</span>` : '-'}</td>
      <td>${student.preferredInstructor ? `<span class="instructor-tag">${student.preferredInstructor}</span>` : '-'}</td>
      <td class="progress-cell">${normalHtml}</td>
      <td class="progress-cell">${englishHtml}</td>
      <td><span class="status-badge ${statusClass}">${student.status}</span></td>
      <td><button class="edit-btn" onclick="openModal('${student.studentId}')">ç·¨é›†</button></td>
    </tr>
  `;
      }).join('');
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      const total = studentList.length;
      const unassigned = studentList.filter(s => s.status === 'æœªå‰²å½“').length;
      const inProgress = studentList.filter(s => s.status === 'å‰²å½“ä¸­').length;
      const completed = studentList.filter(s => s.status === 'å‰²å½“å®Œäº†').length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statUnassigned').textContent = unassigned;
      document.getElementById('statInProgress').textContent = inProgress;
      document.getElementById('statCompleted').textContent = completed;
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
    function setFilter(filter) {
      currentFilter = filter;

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });

      renderTable();
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    function filterTable() {
      renderTable();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openModal(studentId) {
      document.getElementById('loading').classList.remove('hidden');
      pendingAssignments = { normal: [], english: [] };
      currentStudent = studentList.find(s => s.studentId === studentId);
      if (!currentStudent) return;

      document.getElementById('modalTitle').textContent = `${currentStudent.studentName} ã®å‰²å½“ç·¨é›†`;
      document.getElementById('modalPreferred').textContent = currentStudent.preferredInstructor || '-';
      document.getElementById('modalDesignated').textContent = currentStudent.designatedInstructor || '-';

      // æ‹…ä»»ã¨å…ˆæœˆæ‹…å½“ã‚’ä¸¦åˆ—ã§å–å¾—
      const [homeroomResult, lastMonthResult] = await Promise.allSettled([
        fetch(`${API_URL}?action=getStudentHomeroom&studentId=${studentId}`, {
          method: 'GET',
          redirect: 'follow'
        }).then(res => res.json()),
        fetch(`${API_URL}?action=getLastMonthInstructors&studentId=${studentId}&yearMonth=${currentYearMonth}`, {
          method: 'GET',
          redirect: 'follow'
        }).then(res => res.json())
      ]);

      // æ‹…ä»»ã®çµæœã‚’åæ˜ 
      if (homeroomResult.status === 'fulfilled' && homeroomResult.value.success && homeroomResult.value.data) {
        document.getElementById('modalHomeroom').textContent = homeroomResult.value.data.name;
      } else {
        document.getElementById('modalHomeroom').textContent = '-';
      }

      // å…ˆæœˆæ‹…å½“ã®çµæœã‚’åæ˜ 
      if (lastMonthResult.status === 'fulfilled' && lastMonthResult.value.success && lastMonthResult.value.data && lastMonthResult.value.data.length > 0) {
        const lastMonthText = lastMonthResult.value.data.map(i => `${i.name}(${i.courseType}${i.lessons}ã‚³ãƒ)`).join('ã€');
        document.getElementById('modalLastMonth').textContent = lastMonthText;
      } else {
        document.getElementById('modalLastMonth').textContent = 'ãªã—';
      }

      // ã‚³ãƒæ•°è¡¨ç¤º
      document.getElementById('normalWanted').textContent = currentStudent.normalLessonsWanted;
      document.getElementById('normalAssigned').textContent = currentStudent.normalLessonsAssigned;
      document.getElementById('normalRemaining').textContent = currentStudent.normalRemaining;

      document.getElementById('englishWanted').textContent = currentStudent.englishLessonsWanted;
      document.getElementById('englishAssigned').textContent = currentStudent.englishLessonsAssigned;
      document.getElementById('englishRemaining').textContent = currentStudent.englishRemaining;

      // è‹±èªã‚³ãƒãŒ0ãªã‚‰éè¡¨ç¤º
      document.getElementById('englishSection').classList.toggle('hidden', currentStudent.englishLessonsWanted === 0);

      // å‰²å½“è©³ç´°ã‚’å–å¾—
      try {
        const res = await fetch(`${API_URL}?action=getStudentAssignmentDetail&yearMonth=${currentYearMonth}&studentId=${studentId}`);
        const data = await res.json();

        if (data.success) {
          // ç¾åœ¨ã®å‰²å½“ã‚’ä¿æŒ
          currentAssignments = {
            normal: data.data.normal || [],
            english: data.data.english || []
          };

          renderAssignmentListWithPending('normal');
          renderAssignmentListWithPending('english');
        }
      } catch (error) {
        console.error('å‰²å½“è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }

      // è¬›å¸«é¸æŠè‚¢ã‚’æ›´æ–°
      updateInstructorSelect('normal');
      updateInstructorSelect('english');

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      hideAddForm('normal');
      hideAddForm('english');

      lucide.createIcons();
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('assignmentModal').classList.add('show');
      lucide.createIcons();
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
      document.getElementById('assignmentModal').classList.remove('show');
      currentStudent = null;
    }

    // å‰²å½“ãƒªã‚¹ãƒˆæç”»
    function renderAssignmentList(courseType, assignments) {
      const listEl = document.getElementById(`${courseType}AssignmentList`);

      if (!assignments || assignments.length === 0) {
        listEl.innerHTML = '<div class="empty-state">å‰²å½“ãªã—</div>';
        return;
      }

      listEl.innerHTML = assignments.map(a => {
        const instructor = instructorCapacity.find(i => String(i.instructorId) === String(a.instructorId));

        // æ®‹ã‚Šã‚³ãƒæ•°ã®è¡¨ç¤ºï¼ˆæœªæå‡ºã®å ´åˆã¯ã€Œæœªæå‡ºã€ã¨è¡¨ç¤ºï¼‰
        let capacityText = '';
        let capacityClass = '';

        if (!instructor || !instructor.isSubmitted) {
          capacityText = 'æœªæå‡º';
          capacityClass = 'not-submitted';
        } else if (instructor.remainingLessons < 0) {
          capacityText = `æ®‹ã‚Š${instructor.remainingLessons}ã‚³ãƒï¼ˆè¶…éï¼‰`;
          capacityClass = 'warning';
        } else {
          capacityText = `æ®‹ã‚Š${instructor.remainingLessons}ã‚³ãƒå¯èƒ½`;
        }

        return `
      <div class="assignment-item">
        <div class="assignment-info">
          <span class="assignment-instructor">${a.instructorName}</span>
          <span class="assignment-lessons">${a.assignedLessons}ã‚³ãƒ</span>
          ${a.isDesignated ? '<span class="assignment-tag">æŒ‡å</span>' : ''}
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="assignment-capacity ${capacityClass}">${capacityText}</span>
          <button class="assignment-delete" onclick="deleteAssignment(${a.rowIndex}, '${courseType}')">
            <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
          </button>
        </div>
      </div>
    `;
      }).join('');

      lucide.createIcons();
    }

    // å‰²å½“ãƒªã‚¹ãƒˆæç”»ï¼ˆä¸€æ™‚è¿½åŠ ã‚’å«ã‚€ï¼‰
    function renderAssignmentListWithPending(courseType) {
      const listEl = document.getElementById(`${courseType}AssignmentList`);

      // DBã‹ã‚‰å–å¾—ã—ãŸæ—¢å­˜ã®å‰²å½“
      const existingAssignments = currentAssignments[courseType] || [];

      // ä¸€æ™‚è¿½åŠ åˆ†
      const pending = pendingAssignments[courseType] || [];

      const allAssignments = [...existingAssignments, ...pending];

      if (allAssignments.length === 0) {
        listEl.innerHTML = '<div class="empty-state">å‰²å½“ãªã—</div>';
        return;
      }

      listEl.innerHTML = allAssignments.map((a, index) => {
        const instructor = instructorCapacity.find(i => String(i.instructorId) === String(a.instructorId));

        // æ®‹ã‚Šã‚³ãƒæ•°ã®è¡¨ç¤º
        let capacityText = '';
        let capacityClass = '';

        if (!instructor || !instructor.isSubmitted) {
          capacityText = 'æœªæå‡º';
          capacityClass = 'not-submitted';
        } else if (instructor.remainingLessons < 0) {
          capacityText = `æ®‹ã‚Š${instructor.remainingLessons}ã‚³ãƒï¼ˆè¶…éï¼‰`;
          capacityClass = 'warning';
        } else {
          capacityText = `æ®‹ã‚Š${instructor.remainingLessons}ã‚³ãƒå¯èƒ½`;
        }

        // æœªä¿å­˜ãƒãƒ¼ã‚¯
        const pendingMark = a.isPending ? '<span class="pending-mark">NEW</span>' : '';

        // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆæœªä¿å­˜ã¯ä¸€æ™‚ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã€ä¿å­˜æ¸ˆã¿ã¯DBå‰Šé™¤ï¼‰
        const deleteBtn = a.isPending
          ? `<button class="assignment-delete" onclick="removePendingAssignment('${courseType}', ${index - existingAssignments.length})">
           <i data-lucide="x" style="width:16px;height:16px;"></i>
         </button>`
          : `<button class="assignment-delete" onclick="deleteAssignment(${a.rowIndex}, '${courseType}')">
           <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
         </button>`;

        return `
      <div class="assignment-item ${a.isPending ? 'pending' : ''}">
        <div class="assignment-info">
          <span class="assignment-instructor">${a.instructorName}</span>
          <span class="assignment-lessons">${a.assignedLessons}ã‚³ãƒ</span>
          ${a.isDesignated ? '<span class="assignment-tag">æŒ‡å</span>' : ''}
          ${pendingMark}
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="assignment-capacity ${capacityClass}">${capacityText}</span>
          ${deleteBtn}
        </div>
      </div>
    `;
      }).join('');

      lucide.createIcons();
    }

    // ä¸€æ™‚è¿½åŠ ã‚’å‰Šé™¤
    function removePendingAssignment(courseType, index) {
      const removed = pendingAssignments[courseType][index];

      // æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã ã£ãŸå ´åˆã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
      if (removed && removed.isUpdate && removed.originalRowIndex) {
        currentAssignments[courseType].push({
          rowIndex: removed.originalRowIndex,
          instructorId: removed.instructorId,
          instructorName: removed.instructorName,
          assignedLessons: removed.originalLessons || removed.assignedLessons,
          isDesignated: removed.isDesignated,
          isPending: false
        });
      }

      pendingAssignments[courseType].splice(index, 1);
      renderAssignmentListWithPending(courseType);
      updatePendingStats(courseType);
      updateSaveButtonState();
    }

    // ä¸€æ™‚è¿½åŠ åˆ†ã‚’å«ã‚ãŸçµ±è¨ˆæ›´æ–°
    function updatePendingStats(courseType) {
      const existing = currentAssignments[courseType] || [];
      const pending = pendingAssignments[courseType] || [];

      const existingTotal = existing.reduce((sum, a) => sum + a.assignedLessons, 0);
      const pendingTotal = pending.reduce((sum, a) => sum + a.assignedLessons, 0);
      const total = existingTotal + pendingTotal;

      if (courseType === 'normal') {
        const wanted = currentStudent.normalLessonsWanted;
        document.getElementById('normalAssigned').textContent = total;
        document.getElementById('normalRemaining').textContent = Math.max(0, wanted - total);
      } else {
        const wanted = currentStudent.englishLessonsWanted;
        document.getElementById('englishAssigned').textContent = total;
        document.getElementById('englishRemaining').textContent = Math.max(0, wanted - total);
      }
    }

    // ä¿å­˜ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateSaveButtonState() {
      const hasPending = pendingAssignments.normal.length > 0 || pendingAssignments.english.length > 0;
      const saveBtn = document.getElementById('saveAssignmentsBtn');

      if (hasPending) {
        saveBtn.classList.remove('hidden');
        saveBtn.textContent = `ä¿å­˜ï¼ˆ${pendingAssignments.normal.length + pendingAssignments.english.length}ä»¶ï¼‰`;
      } else {
        saveBtn.classList.add('hidden');
      }
    }

    // ä¸€æ‹¬ä¿å­˜
    async function saveAllAssignments() {
      const allPending = [
        ...pendingAssignments.normal.map(a => ({ ...a, courseType: 'é€šå¸¸' })),
        ...pendingAssignments.english.map(a => ({ ...a, courseType: 'è‹±èª' }))
      ];

      if (allPending.length === 0) return;

      document.getElementById('loading').classList.remove('hidden');

      try {
        // é †ç•ªã«ä¿å­˜
        for (const assignment of allPending) {
          const payload = {
            action: 'saveAssignment',
            yearMonth: currentYearMonth,
            studentId: currentStudent.studentId,
            studentName: currentStudent.studentName,
            instructorId: assignment.instructorId,
            instructorName: assignment.instructorName,
            courseType: assignment.courseType,
            assignedLessons: assignment.assignedLessons,
            isDesignated: assignment.isDesignated
          };

          await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
        }

        // å°‘ã—å¾…ã¤
        await new Promise(resolve => setTimeout(resolve, 500));

        // ä¸€æ™‚ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        pendingAssignments = { normal: [], english: [] };

        // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
        await loadData();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ›´æ–°
        if (currentStudent) {
          const updatedStudent = studentList.find(s => s.studentId === currentStudent.studentId);
          if (updatedStudent) {
            currentStudent = updatedStudent;
            await openModal(currentStudent.studentId);
          }
        }

      } catch (error) {
        console.error('ä¸€æ‹¬ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      document.getElementById('loading').classList.add('hidden');
    }

    // è¬›å¸«é¸æŠè‚¢ã‚’æ›´æ–°
    function updateInstructorSelect(courseType) {
      const select = document.getElementById(`${courseType}InstructorSelect`);

      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      // æå‡ºæ¸ˆã¿ã¨æœªæå‡ºã§åˆ†ã‘ã‚‹
      const submitted = instructorCapacity.filter(i => i.isSubmitted);
      const notSubmitted = instructorCapacity.filter(i => !i.isSubmitted);

      // æŒ‡åè¬›å¸«ã‚’å…ˆé ­ã«
      if (currentStudent && currentStudent.designatedInstructorId) {
        const designated = instructorCapacity.find(i => String(i.instructorId) === String(currentStudent.designatedInstructorId));
        if (designated) {
          const option = document.createElement('option');
          option.value = designated.instructorId;
          option.dataset.name = designated.instructorName;
          option.dataset.remaining = designated.remainingLessons ?? 0;
          option.dataset.ideal = designated.idealLessons ?? 0;
          option.dataset.max = designated.maxLessons ?? 0;

          if (designated.isSubmitted) {
            const campusText = designated.campusLessons > 0 ? ` / æ ¡èˆ${designated.campusLessons}` : ` / æ ¡èˆ${designated.campusLessons || 0}`;
            option.textContent = `â˜… ${designated.instructorName}ã€æŒ‡åã€‘ï¼ˆç†æƒ³${designated.idealLessons} / ä¸Šé™${designated.maxLessons}${campusText} / æ®‹ã‚Š${designated.remainingLessons}ï¼‰`;
          } else {
            option.textContent = `â˜… ${designated.instructorName}ã€æŒ‡åã€‘ï¼ˆæœªæå‡ºï¼‰`;
          }
          option.style.fontWeight = 'bold';
          option.style.backgroundColor = '#fef2f2';
          select.appendChild(option);
        }
      }

      // æå‡ºæ¸ˆã¿è¬›å¸«ï¼ˆæŒ‡åä»¥å¤–ï¼‰
      submitted.forEach(instructor => {
        // æŒ‡åè¬›å¸«ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
        if (currentStudent && String(instructor.instructorId) === String(currentStudent.designatedInstructorId)) return;

        const option = document.createElement('option');
        option.value = instructor.instructorId;
        option.dataset.name = instructor.instructorName;
        option.dataset.remaining = instructor.remainingLessons ?? 0;
        option.dataset.ideal = instructor.idealLessons ?? 0;
        option.dataset.max = instructor.maxLessons ?? 0;

        const campusText = ` / æ ¡èˆ${instructor.campusLessons || 0}`;
        option.textContent = `${instructor.instructorName}ï¼ˆç†æƒ³${instructor.idealLessons} / ä¸Šé™${instructor.maxLessons}${campusText} / æ®‹ã‚Š${instructor.remainingLessons}ï¼‰`;

        select.appendChild(option);
      });

      // åŒºåˆ‡ã‚Šç·šï¼ˆæœªæå‡ºãŒã„ã‚‹å ´åˆã®ã¿ï¼‰
      if (notSubmitted.length > 0) {
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = 'â”€â”€â”€â”€â”€â”€ æœªæå‡º â”€â”€â”€â”€â”€â”€';
        separator.style.color = '#94a3b8';
        select.appendChild(separator);
      }

      // æœªæå‡ºè¬›å¸«
      notSubmitted.forEach(instructor => {
        // æŒ‡åè¬›å¸«ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
        if (currentStudent && String(instructor.instructorId) === String(currentStudent.designatedInstructorId)) return;

        const option = document.createElement('option');
        option.value = instructor.instructorId;
        option.dataset.name = instructor.instructorName;
        option.dataset.remaining = '0';
        option.dataset.ideal = '0';
        option.dataset.max = '0';
        option.textContent = `${instructor.instructorName}ï¼ˆæœªæå‡ºï¼‰`;
        option.style.color = '#94a3b8';

        select.appendChild(option);
      });
    }
    // è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    function showAddForm(courseType) {
      document.getElementById(`${courseType}AddForm`).classList.add('show');
    }

    // è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤º
    function hideAddForm(courseType) {
      document.getElementById(`${courseType}AddForm`).classList.remove('show');
      document.getElementById(`${courseType}InstructorSelect`).value = '';
      document.getElementById(`${courseType}LessonsInput`).value = 1;
      document.getElementById(`${courseType}CapacityWarning`).classList.remove('show');
    }

    // ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    // ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    function checkCapacity(courseType) {
      const select = document.getElementById(`${courseType}InstructorSelect`);
      const lessonsInput = document.getElementById(`${courseType}LessonsInput`);
      const warning = document.getElementById(`${courseType}CapacityWarning`);

      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption || !selectedOption.value) {
        warning.classList.remove('show');
        return;
      }

      // æœªæå‡ºè¬›å¸«ã®å ´åˆã¯è­¦å‘Šã‚’å‡ºã•ãªã„
      const max = selectedOption.dataset.max;
      if (!max || max === '0' || max === 'null') {
        warning.classList.remove('show');
        return;
      }

      const remaining = parseInt(selectedOption.dataset.remaining) || 0;
      const lessons = parseInt(lessonsInput.value) || 0;

      if (lessons > remaining) {
        warning.classList.add('show');
      } else {
        warning.classList.remove('show');
      }
    }

    // å‰²å½“è¿½åŠ ï¼ˆä¸€æ™‚ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼‰
    function addAssignment(courseType) {
      const select = document.getElementById(`${courseType}InstructorSelect`);
      const lessonsInput = document.getElementById(`${courseType}LessonsInput`);

      const instructorId = select.value;
      const selectedOption = select.options[select.selectedIndex];
      const instructorName = selectedOption?.dataset?.name || '';
      const lessons = parseInt(lessonsInput.value) || 0;

      if (!instructorId || lessons <= 0) {
        alert('è¬›å¸«ã¨ã‚³ãƒæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const isDesignated = String(currentStudent.designatedInstructorId) === String(instructorId);

      // æ—¢ã«åŒã˜è¬›å¸«ãŒpendingã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ â†’ ä¸Šæ›¸ã
      const existingPendingIndex = pendingAssignments[courseType].findIndex(a => String(a.instructorId) === String(instructorId));
      if (existingPendingIndex >= 0) {
        pendingAssignments[courseType][existingPendingIndex].assignedLessons = lessons;
        renderAssignmentListWithPending(courseType);
        updatePendingStats(courseType);
        hideAddForm(courseType);
        updateSaveButtonState();
        return;
      }

      // æ—¢ã«åŒã˜è¬›å¸«ãŒDBã«ä¿å­˜æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ â†’ æ›´æ–°ç”¨ã«pendingã«è¿½åŠ 
      const existingDbIndex = currentAssignments[courseType].findIndex(a => String(a.instructorId) === String(instructorId));
      if (existingDbIndex >= 0) {
        const existing = currentAssignments[courseType][existingDbIndex];
        // pendingã«æ–°ã—ã„ã‚³ãƒæ•°ã§è¿½åŠ ï¼ˆæ›´æ–°ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
        pendingAssignments[courseType].push({
          instructorId: instructorId,
          instructorName: instructorName,
          assignedLessons: lessons,
          isDesignated: isDesignated,
          isPending: true,
          isUpdate: true,
          originalRowIndex: existing.rowIndex,
          originalLessons: existing.assignedLessons  // â˜…å…ƒã®ã‚³ãƒæ•°ã‚’ä¿å­˜
        });
        // æ—¢å­˜ã‹ã‚‰å‰Šé™¤
        currentAssignments[courseType].splice(existingDbIndex, 1);

        renderAssignmentListWithPending(courseType);
        updatePendingStats(courseType);
        hideAddForm(courseType);
        updateSaveButtonState();
        return;
      }

      // ä¸€æ™‚ãƒªã‚¹ãƒˆã«è¿½åŠ 
      pendingAssignments[courseType].push({
        instructorId: instructorId,
        instructorName: instructorName,
        assignedLessons: lessons,
        isDesignated: isDesignated,
        isPending: true  // æœªä¿å­˜ãƒ•ãƒ©ã‚°
      });

      // è¡¨ç¤ºã‚’æ›´æ–°
      renderAssignmentListWithPending(courseType);
      updatePendingStats(courseType);
      hideAddForm(courseType);

      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      updateSaveButtonState();
    }

    // å‰²å½“å‰Šé™¤
    async function deleteAssignment(rowIndex, courseType) {
      if (!confirm('ã“ã®å‰²å½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const payload = {
        action: 'deleteAssignment',
        rowIndex: rowIndex
      };

      try {
        await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
        await new Promise(resolve => setTimeout(resolve, 1000));

        // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
        await loadData();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ›´æ–°
        if (currentStudent) {
          const updatedStudent = studentList.find(s => s.studentId === currentStudent.studentId);
          if (updatedStudent) {
            currentStudent = updatedStudent;
            openModal(currentStudent.studentId);
          }
        }

      } catch (error) {
        console.error('å‰²å½“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openSettingsModal() {
      document.getElementById('loading').classList.remove('hidden');

      // å¯¾è±¡å¹´æœˆã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const select = document.getElementById('settingsTargetMonth');
      select.innerHTML = '';
      const now = new Date();

      for (let i = -2; i <= 6; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const value = `${y}-${m}`;
        const label = `${y}å¹´${date.getMonth() + 1}æœˆ`;

        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        select.appendChild(option);
      }

      // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
      try {
        const res = await fetch(`${API_URL}?action=getScheduleSettings`, {
          method: 'GET',
          redirect: 'follow'
        });
        const data = await res.json();

        if (data.success) {
          // å¯¾è±¡å¹´æœˆã‚’è¨­å®š
          const targetMonth = data.data['å¯¾è±¡å¹´æœˆ'] || '';
          select.value = targetMonth;

          // ç”Ÿå¾’ç”³è«‹ã®ãƒˆã‚°ãƒ«
          const studentOpen = data.data['ç”³è«‹å—ä»˜ä¸­'];
          document.getElementById('studentApplicationToggle').checked =
            studentOpen === true || studentOpen === 'TRUE' || studentOpen === 'true';

          // è¬›å¸«ç”³è«‹ã®ãƒˆã‚°ãƒ«
          const instructorOpen = data.data['è¬›å¸«ç”³è«‹å—ä»˜ä¸­'];
          document.getElementById('instructorApplicationToggle').checked =
            instructorOpen === true || instructorOpen === 'TRUE' || instructorOpen === 'true';
        }
      } catch (error) {
        console.error('è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }

      document.getElementById('loading').classList.add('hidden');
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateSettingsPreview();
      document.getElementById('settingsModal').classList.add('show');
      lucide.createIcons();
    }

    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    // è¨­å®šã‚’ä¿å­˜
    async function saveSettings() {
      const btn = document.getElementById('settingsSaveBtn');
      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';

      const payload = {
        action: 'updateScheduleSettings',
        targetYearMonth: document.getElementById('settingsTargetMonth').value,
        studentApplicationOpen: document.getElementById('studentApplicationToggle').checked,
        instructorApplicationOpen: document.getElementById('instructorApplicationToggle').checked
      };

      console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', payload);

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify(payload)
        });

        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);

        // å°‘ã—å¾…ã¤
        await new Promise(resolve => setTimeout(resolve, 500));

        btn.textContent = 'ä¿å­˜ã—ã¾ã—ãŸï¼';

        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'è¨­å®šã‚’ä¿å­˜';
          closeSettingsModal();

          // ãƒšãƒ¼ã‚¸ã®å¯¾è±¡æœˆã‚»ãƒ¬ã‚¯ãƒˆã‚‚æ›´æ–°
          document.getElementById('yearMonth').value = payload.targetYearMonth;
          loadData();
        }, 1000);

      } catch (error) {
        console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        btn.disabled = false;
        btn.textContent = 'è¨­å®šã‚’ä¿å­˜';
      }
    }

    // è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    function updateSettingsPreview() {
      const select = document.getElementById('settingsTargetMonth');
      const selectedOption = select.options[select.selectedIndex];
      const monthLabel = selectedOption ? selectedOption.textContent : '';

      document.getElementById('settingsHint').textContent =
        `${monthLabel}åˆ†ã®ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã‚‹ã‹ã©ã†ã‹ã‚’è¨­å®šã—ã¾ã™`;
    }

  </script>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay settings-modal" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</h2>
        <button class="modal-close" onclick="closeSettingsModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-form">
          <!-- å¯¾è±¡å¹´æœˆ -->
          <div class="settings-group">
            <label class="settings-label">ç”³è«‹å—ä»˜ã®å¯¾è±¡å¹´æœˆ</label>
            <select class="settings-select" id="settingsTargetMonth" onchange="updateSettingsPreview()">
              <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </select>
            <p class="settings-hint" id="settingsHint">ã“ã®æœˆã®ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã‚‹ã‹ã©ã†ã‹ã‚’è¨­å®šã—ã¾ã™</p>
          </div>

          <!-- ç”Ÿå¾’ç”³è«‹ -->
          <div class="toggle-wrapper">
            <div class="toggle-info">
              <span class="toggle-title">ç”Ÿå¾’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”³è«‹</span>
              <span class="toggle-desc">ç”Ÿå¾’ãŒå¸Œæœ›æ—¥æ™‚ã‚’ç”³è«‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="studentApplicationToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <!-- è¬›å¸«ç”³è«‹ -->
          <div class="toggle-wrapper">
            <div class="toggle-info">
              <span class="toggle-title">è¬›å¸«æˆæ¥­å¯èƒ½æ•°ç”³è«‹</span>
              <span class="toggle-desc">è¬›å¸«ãŒæˆæ¥­å¯èƒ½æ•°ã‚’ç”³è«‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="instructorApplicationToggle">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
          <button class="settings-save-btn" id="settingsSaveBtn" onclick="saveSettings()">
            è¨­å®šã‚’ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>