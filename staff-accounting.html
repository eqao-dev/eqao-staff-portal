<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>経理管理 | EQAO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #eab308;
      --primary-dark: #ca8a04;
      --primary-light: #fef9c3;
      --success: #22c55e;
      --success-light: #dcfce7;
      --warning: #f97316;
      --warning-light: #ffedd5;
      --danger: #ef4444;
      --danger-light: #fee2e2;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      color: #333;
    }

    /* ヘッダー */
    .header {
      background: #111;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #aaa;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }

    .refresh-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--primary);
      border: none;
      color: #111;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .refresh-btn:hover {
      background: var(--primary-dark);
    }

    /* タブナビゲーション */
    .tab-nav {
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      padding: 0 24px;
      position: sticky;
      top: 64px;
      z-index: 90;
    }

    .tab-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 4px;
    }

    .tab-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 24px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      position: relative;
    }

    .tab-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: transparent;
      border-radius: 3px 3px 0 0;
      transition: all 0.2s;
    }

    .tab-btn:hover:not(.disabled) {
      color: var(--primary-dark);
      background: var(--primary-light);
    }

    .tab-btn.active {
      color: var(--primary-dark);
    }

    .tab-btn.active::after {
      background: var(--primary);
    }

    .tab-btn.disabled {
      color: #aaa;
      cursor: not-allowed;
    }

    .tab-btn .coming-soon {
      font-size: 10px;
      font-weight: 700;
      background: #e5e5e5;
      color: #888;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 4px;
    }

    /* タブコンテンツ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* コマ数管理タブ */
    .lessons-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .lessons-summary-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lessons-summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lessons-summary-icon.total {
      background: #eff6ff;
      color: #2563eb;
    }

    .lessons-summary-icon.english {
      background: #f0fdf4;
      color: #16a34a;
    }

    .lessons-summary-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }

    .lessons-summary-value {
      font-size: 24px;
      font-weight: 700;
      color: #111;
    }

    .lessons-student-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lessons-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      overflow: visible;
      transition: all 0.3s;
    }

    .lessons-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .lessons-card-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .lessons-card-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .lessons-card-avatar {
      width: 42px;
      height: 42px;
      background: var(--primary-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .lessons-card-name {
      font-weight: 600;
      color: #111;
      font-size: 15px;
    }

    .lessons-card-id {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .lessons-card-counts {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .lessons-count-item {
      text-align: center;
    }

    .lessons-count-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
    }

    .lessons-count-value {
      font-size: 18px;
      font-weight: 700;
    }

    .lessons-count-value.total {
      color: #2563eb;
    }

    .lessons-count-value.english {
      color: #16a34a;
    }

    .lessons-count-value.zero {
      color: #ccc;
    }

    .lessons-card-toggle {
      color: #999;
      transition: transform 0.3s;
    }

    .lessons-card.expanded .lessons-card-toggle {
      transform: rotate(180deg);
    }

    .lessons-card-detail {
      display: none;
      border-top: 1px solid #eee;
      padding: 16px 20px;
      background: #fafafa;
    }

    .lessons-card.expanded .lessons-card-detail {
      display: block;
    }

    .invoice-history-title {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .invoice-history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .invoice-history-table th {
      text-align: left;
      padding: 8px 12px;
      background: #f0f0f0;
      font-weight: 600;
      color: #555;
      border-bottom: 1px solid #ddd;
    }

    .invoice-history-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }

    .invoice-history-table tr:last-child td {
      border-bottom: none;
    }

    .invoice-status {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .invoice-status.paid {
      background: #dcfce7;
      color: #166534;
    }

    .invoice-status.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .no-history {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 13px;
    }

    /* Coming Soon画面 */
    .coming-soon-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      text-align: center;
    }

    .coming-soon-icon {
      width: 100px;
      height: 100px;
      background: #f5f5f5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      margin-bottom: 24px;
    }

    .coming-soon-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
    }

    .coming-soon-text {
      font-size: 15px;
      color: #666;
      line-height: 1.8;
      margin-bottom: 32px;
    }

    .coming-soon-features {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f8f9fa;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 20px 32px;
    }

    .coming-soon-feature {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: #666;
    }

    .coming-soon-feature i {
      color: #bbb;
    }

    /* メイン */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* 統計カード */
    .billing-type-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .billing-type-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 20px;
      background: #fff;
      border: 2px solid #e5e5e5;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .billing-type-btn:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .billing-type-btn.active {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .billing-type-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .billing-type-icon.new {
      background: #3b82f6;
    }

    .billing-type-icon.renewal {
      background: #8b5cf6;
    }

    .billing-type-label {
      font-weight: 600;
    }

    .billing-type-count {
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      color: #555;
    }

    .billing-type-btn.active .billing-type-count {
      background: var(--primary);
      color: #111;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-card.total .stat-icon {
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .stat-card.pending .stat-icon {
      background: var(--warning-light);
      color: var(--warning);
    }

    .stat-card.sent .stat-icon {
      background: #fef3c7;
      color: #d97706;
    }

    .stat-card.paid .stat-icon {
      background: var(--success-light);
      color: var(--success);
    }

    .stat-card.amount .stat-icon {
      background: #fef3c7;
      color: #d97706;
    }

    .stat-card.paid-amount .stat-icon {
      background: var(--success-light);
      color: var(--success);
    }

    .stat-card.total-amount .stat-icon {
      background: #f3e8ff;
      color: #9333ea;
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #111;
    }

    .stat-value.small {
      font-size: 20px;
    }

    /* フィルター */
    .filter-bar {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f5f5f5;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 8px 14px;
      flex: 1;
      min-width: 200px;
      max-width: 320px;
      color: #888;
    }

    .search-box:focus-within {
      border-color: var(--primary);
      background: #fff;
    }

    .search-box input {
      border: none;
      background: transparent;
      font-size: 14px;
      color: #333;
      width: 100%;
      outline: none;
      font-family: inherit;
    }

    .filter-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e5e5e5;
      background: #fff;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    .filter-btn.active {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    /* 期間フィルター（タブ風） */
    .period-filter-section {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 4px 12px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e5e5;
      flex-wrap: wrap;
    }

    .period-filter-label {
      font-size: 14px;
      font-weight: 500;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .period-preset-buttons {
      display: flex;
      gap: 0;
    }

    .period-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      font-size: 13px;
      font-weight: 500;
      color: #888;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      position: relative;
    }

    .period-btn::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 0;
      right: 0;
      height: 2px;
      background: transparent;
      transition: background 0.2s;
    }

    .period-btn:hover {
      color: #10b981;
    }

    .period-btn.active {
      color: #10b981;
      font-weight: 600;
    }

    .period-btn.active::after {
      background: #10b981;
    }

    .period-custom-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .period-date-input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
    }

    .period-date-input:focus {
      outline: none;
      border-color: #10b981;
    }

    .period-apply-btn {
      padding: 6px 14px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .period-apply-btn:hover {
      background: #059669;
    }

    /* 生徒リスト */
    .student-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .student-card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 14px;
      overflow: visible;
      transition: all 0.3s;
    }

    .student-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .student-card.sent,
    .student-card.paid {
      border-left: 4px solid var(--success);
    }

    .student-card.waiting {
      border-left: 4px solid #3b82f6;
    }

    .student-card.pending {
      border-left: 4px solid var(--warning);
    }

    .student-card.overdue {
      border-left: 4px solid #ef4444;
      background: #fef2f2;
    }

    .student-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 14px;
      flex: 1;
    }

    .student-avatar {
      width: 42px;
      height: 42px;
      background: var(--primary-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .student-name {
      font-size: 15px;
      font-weight: 600;
      color: #111;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .billing-type-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .billing-type-badge.new {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .billing-type-badge.renewal {
      background: #ede9fe;
      color: #7c3aed;
    }

    .student-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
      font-size: 13px;
      color: #666;
    }

    .student-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .billing-summary {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .billing-amount {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .status-tag {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-tag.sent,
    .status-tag.paid {
      background: var(--success-light);
      color: var(--success);
    }

    .status-tag.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-tag.pending {
      background: var(--warning-light);
      color: var(--warning);
    }

    .expand-btn {
      width: 36px;
      height: 36px;
      background: #f5f5f5;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
    }

    .student-card.expanded .expand-btn {
      transform: rotate(180deg);
    }

    /* 詳細パネル */
    .student-details {
      display: none;
      border-top: 1px solid #eee;
      padding: 20px;
      background: #fafafa;
    }

    .student-card.expanded .student-details {
      display: block;
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .detail-section {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 16px;
    }

    .detail-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 14px;
    }

    .detail-label {
      color: #666;
    }

    .detail-value {
      font-weight: 500;
      color: #333;
      text-align: right;
    }

    .detail-value.price {
      font-weight: 700;
      color: var(--primary-dark);
    }

    .detail-value.discount {
      color: var(--danger);
    }

    .detail-value.total {
      font-size: 18px;
      font-weight: 700;
      color: #111;
    }

    /* 証明書リンク */
    .detail-value.proof-links {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .proof-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #eff6ff;
      color: #2563eb;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
    }

    .proof-link:hover {
      background: #dbeafe;
      color: #1d4ed8;
    }

    /* 購入コマ数 */
    .detail-section.purchased-lessons {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }

    .detail-section.purchased-lessons .detail-section-title {
      color: #166534;
    }

    .detail-value.purchased {
      color: #166534;
      font-weight: 700;
    }

    /* 料金内訳 */
    .billing-breakdown {
      background: #fff;
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .breakdown-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--primary-light);
    }

    .breakdown-section {
      margin-bottom: 20px;
    }

    .breakdown-section:last-child {
      margin-bottom: 0;
    }

    .breakdown-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .breakdown-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .breakdown-section-subtotal {
      font-size: 15px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .breakdown-items {
      padding: 0 8px;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px dashed #e5e5e5;
    }

    .breakdown-item:last-child {
      border-bottom: none;
    }

    .breakdown-item-name {
      color: #555;
      flex: 1;
    }

    .breakdown-item-calc {
      color: #888;
      font-size: 12px;
      text-align: right;
      margin-right: 16px;
    }

    .breakdown-item-amount {
      font-weight: 600;
      color: #333;
      min-width: 90px;
      text-align: right;
    }

    .breakdown-item-amount.discount {
      color: var(--danger);
    }

    .breakdown-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary-light);
      border: 2px solid var(--primary);
      padding: 16px 20px;
      border-radius: 10px;
      margin-top: 16px;
    }

    .breakdown-total-label {
      font-size: 16px;
      font-weight: 700;
      color: #333;
    }

    .breakdown-total-amount {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .breakdown-check {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
    }

    .breakdown-check.match {
      background: var(--success-light);
      color: var(--success);
    }

    .breakdown-check.mismatch {
      background: var(--danger-light);
      color: var(--danger);
    }

    .breakdown-check-text {
      font-size: 14px;
      font-weight: 600;
    }

    /* アクションボタン */
    .action-section {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 20px;
    }

    .action-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .action-btn.preview {
      background: #f5f5f5;
      color: #333;
    }

    .action-btn.preview:hover:not(:disabled) {
      background: #eee;
    }

    .action-btn.preview:disabled {
      background: #f0f0f0;
      color: #bbb;
      cursor: not-allowed;
    }

    .action-btn.send {
      background: var(--primary);
      color: #111;
    }

    .action-btn.send:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .action-btn.send:disabled {
      background: #ddd;
      color: #999;
      cursor: not-allowed;
    }

    .action-btn.resend {
      background: var(--success-light);
      color: var(--success);
    }

    .action-btn.resend:hover {
      background: #bbf7d0;
    }

    /* ローディング */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #666;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #eee;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* モーダル */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #111;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      background: #f5f5f5;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* ウィザードモーダル */
    .wizard-modal {
      max-width: 900px;
    }

    .wizard-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 24px;
      background: #f9fafb;
      border-bottom: 1px solid #eee;
    }

    .wizard-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .wizard-step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e5e7eb;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }

    .wizard-step.active .wizard-step-number,
    .wizard-step.completed .wizard-step-number {
      background: var(--primary);
      color: #fff;
    }

    .wizard-step.completed .wizard-step-number {
      background: var(--success);
    }

    .wizard-step-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    .wizard-step.active .wizard-step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .wizard-step.completed .wizard-step-label {
      color: var(--success);
    }

    .wizard-step-line {
      width: 60px;
      height: 2px;
      background: #e5e7eb;
      margin: 0 12px;
      margin-bottom: 20px;
      transition: background 0.3s;
    }

    .wizard-step-line.completed {
      background: var(--success);
    }

    .wizard-body {
      padding: 0;
    }

    .wizard-content {
      display: none;
      padding: 24px;
    }

    .wizard-content.active {
      display: block;
    }

    .wizard-footer {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .wizard-footer-spacer {
      flex: 1;
    }

    .wizard-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .wizard-btn.back {
      background: #f3f4f6;
      color: #374151;
    }

    .wizard-btn.back:hover {
      background: #e5e7eb;
    }

    .wizard-btn.next {
      background: var(--primary);
      color: #fff;
    }

    .wizard-btn.next:hover {
      background: var(--primary-dark);
    }

    .wizard-btn.send {
      background: var(--success);
      color: #fff;
    }

    .wizard-btn.send:hover {
      background: #059669;
    }

    .wizard-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: btn-spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes btn-spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ウィザード内のフォーム */
    .email-form-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .email-form-group {
      margin-bottom: 20px;
    }

    .email-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .email-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .email-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .email-input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }

    .email-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 200px;
      transition: all 0.2s;
    }

    .email-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* バリデーションエラー */
    .input-error {
      border-color: #ef4444 !important;
      background-color: #fef2f2 !important;
    }

    .input-error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .validation-error {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #dc2626;
      font-size: 12px;
      margin-top: 6px;
    }

    /* 請求書プレビュー */
    .invoice-preview {
      background: #fff;
      padding: 30px 35px;
      font-size: 11px;
      line-height: 1.5;
      color: #333;
      font-family: 'Noto Sans JP', sans-serif;
      width: 210mm;
      min-height: 297mm;
      max-height: 297mm;
      box-sizing: border-box;
      overflow: hidden;
    }

    .invoice-title-section {
      text-align: center;
      margin-bottom: 24px;
    }

    .invoice-main-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 12px;
      margin: 0;
    }

    .invoice-header-section {
      display: flex;
      justify-content: space-between;
      gap: 40px;
      margin-bottom: 24px;
    }

    .invoice-to-section {
      flex: 1;
      padding-top: 20px;
    }

    .invoice-meta-box.right-align {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-bottom: 16px;
    }

    .invoice-meta-row {
      display: flex;
      gap: 8px;
      font-size: 12px;
      margin-bottom: 2px;
      justify-content: flex-end;
    }

    .invoice-meta-label {
      color: #666;
    }

    .invoice-meta-value {
      font-weight: 500;
      text-align: right;
    }

    .invoice-to-name-wrapper {
      display: inline-flex;
      align-items: baseline;
      margin-bottom: 8px;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
    }

    .invoice-to-name-input {
      font-size: 20px;
      font-weight: 600;
      border: none;
      background: transparent;
      text-align: center;
      width: 180px;
      outline: none;
      font-family: inherit;
    }

    .invoice-to-sama {
      font-size: 16px;
      font-weight: 400;
      margin-left: 16px;
    }

    .invoice-notice {
      font-size: 12px;
      margin-bottom: 16px;
    }

    .invoice-subject {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .invoice-subject-label {
      font-size: 12px;
      flex-shrink: 0;
    }

    .invoice-subject-input {
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-bottom: 1px solid #333;
      background: transparent;
      padding: 4px 0;
      width: 380px;
      outline: none;
      font-family: inherit;
    }

    /* 編集可能フィールドのスタイル */
    .editable-field {
      background: #fffef0 !important;
      transition: all 0.2s;
    }

    .editable-field:hover {
      background: #fef9c3 !important;
    }

    .editable-field:focus {
      background: #fef9c3 !important;
      border-color: var(--primary) !important;
    }

    .invoice-from-section {
      width: 260px;
    }

    .invoice-company {
      margin-top: 20px;
      margin-bottom: 12px;
    }

    .invoice-company-name {
      font-size: 14px;
      font-weight: 700;
    }

    .invoice-company-dept {
      font-size: 12px;
      color: #666;
    }

    .invoice-company-details {
      font-size: 10px;
      color: #555;
      line-height: 1.5;
    }

    .invoice-company-details p {
      margin: 0;
    }

    .invoice-stamps {
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
    }

    .invoice-logo-small {
      width: 100px;
      height: auto;
    }

    .invoice-stamp {
      width: 110px;
      height: auto;
    }

    .invoice-summary-section {
      margin-bottom: 20px;
    }

    .invoice-summary-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .invoice-summary-table th,
    .invoice-summary-table td {
      width: 33.33%;
    }

    .invoice-summary-table th {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 10px;
      font-size: 12px;
      font-weight: 500;
    }

    .invoice-summary-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
      font-size: 14px;
    }

    .invoice-total-cell {
      font-size: 22px !important;
      font-weight: 700;
    }

    .invoice-payment-section {
      display: flex;
      width: 100%;
      margin-bottom: 24px;
    }

    .invoice-payment-spacer {
      width: 33.33%;
    }

    .invoice-payment-date {
      width: 33.33%;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    .invoice-payment-date-label {
      background: #f5f5f5;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    .invoice-payment-date-value {
      padding: 12px;
      font-size: 13px;
      font-weight: 500;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .invoice-payment-bank {
      width: 33.33%;
      border: 1px solid #ddd;
      border-left: none;
    }

    .invoice-payment-bank-label {
      background: #f5f5f5;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
      border-bottom: 1px solid #ddd;
    }

    .invoice-payment-bank-details {
      padding: 12px;
      font-size: 11px;
      line-height: 1.6;
    }

    .invoice-payment-bank-details p {
      margin: 0;
    }

    .invoice-payment-note {
      margin-top: 8px !important;
      font-size: 10px;
      color: #666;
    }

    .invoice-detail-section {
      margin-bottom: 20px;
    }

    .invoice-detail-table {
      width: 100%;
      border-collapse: collapse;
    }

    .invoice-detail-table th {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .invoice-detail-table td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      font-size: 11px;
    }

    .invoice-detail-table .col-desc {
      width: 50%;
    }

    .invoice-detail-table .col-qty,
    .invoice-detail-table .col-unit,
    .invoice-detail-table .col-amount {
      width: 16.66%;
      text-align: right;
    }

    .invoice-detail-table .text-right {
      text-align: right;
    }

    .invoice-breakdown-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-bottom: 24px;
      padding-right: 20px;
    }

    .invoice-breakdown-row {
      display: flex;
      gap: 40px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .invoice-breakdown-label {
      color: #666;
    }

    .invoice-breakdown-value {
      font-weight: 600;
      min-width: 100px;
      text-align: right;
    }

    .invoice-remarks-section {
      border-top: 1px solid #ddd;
      padding-top: 16px;
    }

    .invoice-remarks-label {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .invoice-remarks-input {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      font-size: 11px;
      font-family: inherit;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      outline: none;
    }

    .invoice-remarks-input:focus {
      border-color: var(--primary);
    }

    .invoice-remarks-input::placeholder {
      color: #aaa;
    }

    /* トースト */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #333;
      color: #fff;
      padding: 14px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.info {
      background: #6366f1;
    }

    /* 料金表モーダル */
    .price-modal {
      max-width: 600px;
    }

    .price-table-body {
      padding: 20px;
    }

    .price-section {
      margin-bottom: 24px;
    }

    .price-section:last-child {
      margin-bottom: 0;
    }

    .price-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
    }

    .price-table {
      width: 100%;
      border-collapse: collapse;
    }

    .price-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }

    .price-table td:first-child {
      color: #555;
    }

    .price-value {
      text-align: right;
      font-weight: 600;
      color: #111;
    }

    .price-value.discount {
      color: var(--danger);
    }

    .price-note {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
    }

    /* メール編集モーダル */
    .email-modal {
      max-width: 700px;
    }

    .email-modal-body {
      padding: 20px;
    }

    .email-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .email-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .email-label {
      font-size: 12px;
      font-weight: 600;
      color: #555;
    }

    .email-input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .email-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .email-input[readonly] {
      background: #f5f5f5;
      color: #666;
    }

    .email-preview-toggle {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .toggle-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #000;
      font-weight: 600;
    }

    .toggle-btn:hover:not(.active) {
      background: #f5f5f5;
    }

    .email-textarea {
      width: 100%;
      min-height: 300px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      line-height: 1.6;
      resize: vertical;
    }

    .email-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .email-html-preview {
      min-height: 300px;
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
      font-size: 13px;
      line-height: 1.8;
    }

    .email-attachment {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 6px;
      font-size: 12px;
      color: #0369a1;
      margin-top: 8px;
    }

    .action-btn.secondary {
      background: #f5f5f5;
      color: #555;
    }

    .action-btn.secondary:hover {
      background: #e5e5e5;
    }

    /* ステータスバッジ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.paid {
      background: #dcfce7;
      color: #166534;
    }

    /* ステータス変更ドロップダウン */
    .status-dropdown {
      position: relative;
      display: inline-block;
    }

    .status-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .status-dropdown-btn.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-dropdown-btn.waiting:hover {
      background: #bfdbfe;
    }

    .status-dropdown-btn.paid {
      background: #dcfce7;
      color: #166534;
    }

    .status-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 4px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      min-width: 120px;
      display: none;
      overflow: visible;
    }

    .status-dropdown-menu.show {
      display: block;
    }

    .status-dropdown-item {
      padding: 10px 14px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .status-dropdown-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .status-dropdown-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .status-dropdown-item:hover {
      background: #f5f5f5;
    }

    /* 更新通知バナー */
    .renewal-alert {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .renewal-alert-icon {
      width: 40px;
      height: 40px;
      background: #f59e0b;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      flex-shrink: 0;
    }

    .renewal-alert-content {
      flex: 1;
    }

    .renewal-alert-title {
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }

    .renewal-alert-text {
      font-size: 12px;
      color: #a16207;
    }

    .renewal-alert-badge {
      background: #f59e0b;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 8px;
    }

    /* 期日超過アラート */
    .overdue-alert {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 1px solid #ef4444;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .overdue-alert-icon {
      width: 40px;
      height: 40px;
      background: #ef4444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      flex-shrink: 0;
    }

    .overdue-alert-content {
      flex: 1;
    }

    .overdue-alert-title {
      font-size: 14px;
      font-weight: 600;
      color: #991b1b;
      margin-bottom: 4px;
    }

    .overdue-alert-text {
      font-size: 12px;
      color: #b91c1c;
    }

    .overdue-alert-badge {
      background: #ef4444;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 8px;
    }

    /* 期日超過バッジ */
    .overdue-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* 料金表ボタン */
    .price-table-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .price-table-btn:hover {
      background: #f5f5f5;
      border-color: #bbb;
    }

    /* 請求書編集パネル */
    .invoice-edit-panel {
      background: #f8f9fa;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .edit-panel-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .edit-panel-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .edit-panel-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .edit-panel-label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
    }

    .period-inputs select.edit-input {
      width: 140px;
      padding: 8px 12px;
    }

    .period-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
    }

    .period-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .discount-section {
      width: 100%;
      margin-top: 8px;
    }

    .discount-checkboxes {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .discount-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 16px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .discount-checkbox:hover:not(.disabled) {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .discount-checkbox.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .discount-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .checkbox-label {
      font-size: 13px;
      font-weight: 500;
    }

    .checkbox-hint {
      font-size: 11px;
      color: #888;
    }

    .discount-note {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
    }

    /* 編集パネル追加スタイル */
    .edit-panel-item.full-width {
      width: 100%;
    }

    .edit-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
      width: 100%;
    }

    .edit-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .preview-button-area {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .preview-generate-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preview-generate-btn:hover {
      background: var(--primary-dark);
    }

    .preview-generate-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .preview-hint {
      font-size: 12px;
      color: #888;
    }

    /* PDFプレビューエリア */
    .pdf-preview-area {
      background: #f5f5f5;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      min-height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .pdf-preview-placeholder {
      text-align: center;
      color: #999;
    }

    .pdf-preview-placeholder p {
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.6;
    }

    .pdf-preview-area iframe,
    .pdf-preview-area object,
    .pdf-preview-area embed {
      width: 100%;
      height: 600px;
      border: none;
    }

    .pdf-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      color: #666;
    }

    .pdf-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e5e5e5;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      background: #f5f5f5;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      color: #999;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      .header {
        padding: 14px 16px;
      }

      .tab-nav {
        padding: 0 16px;
      }

      .tab-btn {
        padding: 14px 16px;
        font-size: 13px;
      }

      .tab-btn .coming-soon {
        display: none;
      }

      .main {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .billing-type-selector {
        gap: 8px;
      }

      .billing-type-btn {
        padding: 10px 14px;
        font-size: 13px;
        flex: 1;
        justify-content: center;
      }

      .billing-type-icon {
        display: none;
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .billing-summary {
        display: none;
      }

      .details-grid {
        grid-template-columns: 1fr;
      }

      /* モバイル表示時もPDF生成用のサイズは維持 */

      .invoice-parties {
        flex-direction: column;
        gap: 20px;
      }

      .invoice-from {
        text-align: left;
      }

      .coming-soon-container {
        padding: 60px 16px;
      }

      .coming-soon-title {
        font-size: 18px;
      }

      .coming-soon-features {
        padding: 16px 20px;
      }
    }

    /* 購入コマ数入力 */
    .lessons-input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }

    .lessons-input-item {
      background: #f8f9fa;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 12px 16px;
    }

    .lessons-input-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }

    .lessons-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lessons-input {
      width: 100px !important;
      text-align: right;
      font-size: 16px !important;
      font-weight: 600 !important;
    }

    .lessons-input-unit {
      font-size: 14px;
      color: #666;
    }

    .lessons-input-hint {
      display: block;
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }

    /* 再送信ボタン（一覧用） */
    .resend-btn-small {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      background: #dcfce7;
      border: 1px solid #86efac;
      border-radius: 8px;
      color: #16a34a;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .resend-btn-small:hover {
      background: #bbf7d0;
      border-color: #22c55e;
    }

    /* 受講内容編集セクション */
    .course-edit-section {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .course-edit-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 12px;
    }

    .course-edit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .course-edit-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .course-edit-label {
      font-size: 11px;
      font-weight: 600;
      color: #78350f;
    }

    .course-edit-input {
      padding: 8px 10px;
      border: 1px solid #fcd34d;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
    }

    .course-edit-input:focus {
      outline: none;
      border-color: #f59e0b;
    }

    .resend-mode-banner {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .resend-mode-banner i {
      color: #2563eb;
    }

    .resend-mode-banner-text {
      font-size: 13px;
      color: #1e40af;
      font-weight: 500;
    }

    /* 更新予定カレンダー */
    .renewal-calendar-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .renewal-calendar-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 12px;
    }

    .renewal-month-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .renewal-month-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .renewal-month-card:hover {
      border-color: #cbd5e1;
      background: #f8fafc;
    }

    .renewal-month-card.selected {
      border-color: #f59e0b;
      background: #fffbeb;
    }

    .renewal-month-card.has-students {
      border-color: #fcd34d;
      background: #fffbeb;
    }

    .renewal-month-card.has-students .renewal-month-count {
      color: #d97706;
      font-weight: 700;
    }

    .renewal-month-card.current {
      box-shadow: 0 0 0 2px #f59e0b;
    }

    .renewal-month-card.past {
      opacity: 0.5;
    }

    .renewal-month-label {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
    }

    .renewal-month-count {
      font-size: 24px;
      font-weight: 700;
      color: #cbd5e1;
      margin: 4px 0;
    }

    .renewal-month-year {
      font-size: 10px;
      color: #94a3b8;
    }

    @media (max-width: 768px) {
      .renewal-month-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* 更新案内カード */
    .stat-card.renewal-card {
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .stat-card.renewal-card:hover {
      border-color: #fcd34d;
      background: #fffbeb;
    }

    .renewal-counts {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }

    .renewal-count-item {
      font-size: 13px;
      color: #666;
    }

    .renewal-count-item strong {
      font-size: 18px;
      color: #d97706;
      margin-left: 2px;
    }

    .renewal-send-icon {
      color: #d97706;
      opacity: 0.5;
      transition: all 0.2s;
    }

    .stat-card.renewal-card:hover .renewal-send-icon {
      opacity: 1;
      transform: translateX(4px);
    }

    /* 更新案内アクションセクション */
    .renewal-action-section {
      display: flex;
      align-items: center;
      gap: 16px;
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 12px;
      padding: 12px 20px;
      margin-bottom: 20px;
    }

    .renewal-action-icon {
      width: 36px;
      height: 36px;
      background: #f59e0b;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      flex-shrink: 0;
    }

    .renewal-action-label {
      font-size: 14px;
      font-weight: 600;
      color: #92400e;
      flex-shrink: 0;
    }

    .renewal-action-months {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      flex-wrap: wrap;
      font-size: 13px;
      color: #888;
    }

    .renewal-month-item {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .renewal-month-item:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    .renewal-month-item.has-students {
      color: #d97706;
      font-weight: 600;
    }

    .renewal-month-item.current {
      background: rgba(245, 158, 11, 0.15);
    }

    .renewal-month-separator {
      color: #ddd;
      margin: 0 2px;
    }

    .renewal-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #f59e0b;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      flex-shrink: 0;
    }

    .renewal-action-btn:hover {
      background: #d97706;
    }

    @media (max-width: 768px) {
      .renewal-action-section {
        flex-wrap: wrap;
      }

      .renewal-action-months {
        order: 3;
        width: 100%;
        margin-top: 8px;
      }

      .renewal-action-btn {
        margin-left: auto;
      }
    }

    /* ユーザーメニュー */
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-menu {
      position: relative;
    }

    .user-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .user-name {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 200;
    }

    .user-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-header {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-name {
      font-size: 14px;
      font-weight: 600;
      color: #111;
      margin-bottom: 2px;
    }

    .dropdown-email {
      font-size: 12px;
      color: #888;
    }

    .dropdown-menu {
      padding: 8px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #555;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      font-family: inherit;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
      color: #111;
    }

    .dropdown-item.danger {
      color: #ef4444;
    }

    .dropdown-item.danger:hover {
      background: #fef2f2;
    }

    .dropdown-divider {
      height: 1px;
      background: #f0f0f0;
      margin: 4px 8px;
    }

    @media (max-width: 768px) {
      .user-name {
        display: none;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="staff-executive.html" class="back-btn">
          <i data-lucide="arrow-left" style="width:16px;height:16px;"></i>
          戻る
        </a>
        <div class="header-info">
          <div class="header-icon">
            <i data-lucide="receipt" style="width:20px;height:20px;"></i>
          </div>
          <h1 class="header-title">経理管理</h1>
        </div>
      </div>
      <div class="header-right">
        <button class="refresh-btn" onclick="loadData()">
          <i data-lucide="refresh-cw" style="width:16px;height:16px;"></i>
          更新
        </button>
        <div class="user-menu">
          <button class="user-btn" id="userBtn" onclick="toggleUserMenu()">
            <div class="user-avatar" id="userAvatar">-</div>
            <span class="user-name" id="userName">ログイン中</span>
            <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
          </button>
          <div class="user-dropdown" id="userDropdown">
            <div class="dropdown-header">
              <div class="dropdown-name" id="dropdownName">-</div>
              <div class="dropdown-email" id="dropdownEmail">-</div>
            </div>
            <div class="dropdown-menu">
              <a href="my-schedule.html" class="dropdown-item">
                <i data-lucide="calendar" style="width:16px;height:16px;"></i>
                マイスケジュール
              </a>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item danger" onclick="handleLogout()">
                <i data-lucide="log-out" style="width:16px;height:16px;"></i>
                ログアウト
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- タブナビゲーション -->
  <div class="tab-nav">
    <div class="tab-nav-inner">
      <button class="tab-btn active" data-tab="invoice" onclick="switchTab('invoice')">
        <i data-lucide="file-text" style="width:18px;height:18px;"></i>
        請求書管理
      </button>
      <button class="tab-btn" data-tab="lessons" onclick="switchTab('lessons')">
        <i data-lucide="package-check" style="width:18px;height:18px;"></i>
        コマ数管理
      </button>
      <button class="tab-btn disabled" data-tab="payroll" disabled>
        <i data-lucide="wallet" style="width:18px;height:18px;"></i>
        給与管理
        <span class="coming-soon">準備中</span>
      </button>
    </div>
  </div>

  <main class="main">
    <!-- 請求書管理タブ -->
    <div class="tab-content active" id="tab-invoice">

      <!-- 請求タイプ切り替え -->
      <div class="billing-type-selector">
        <button class="billing-type-btn active" data-type="all" onclick="setBillingType('all')">
          <span class="billing-type-label">すべて</span>
          <span class="billing-type-count" id="count-all">-</span>
        </button>
        <button class="billing-type-btn" data-type="new" onclick="setBillingType('new')">
          <span class="billing-type-icon new"></span>
          <span class="billing-type-label">新規入塾</span>
          <span class="billing-type-count" id="count-new">-</span>
        </button>
        <button class="billing-type-btn" data-type="renewal" onclick="setBillingType('renewal')">
          <span class="billing-type-icon renewal"></span>
          <span class="billing-type-label">継続更新</span>
          <span class="billing-type-count" id="count-renewal">-</span>
        </button>
      </div>

      <!-- 統計サマリー -->
      <div class="stats-grid">
        <div class="stat-card pending">
          <div class="stat-icon">
            <i data-lucide="clock" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">未送信</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
        </div>
        <div class="stat-card sent">
          <div class="stat-icon">
            <i data-lucide="check-circle" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">入金待ち</div>
            <div class="stat-value" id="stat-sent">-</div>
          </div>
        </div>
        <div class="stat-card paid">
          <div class="stat-icon">
            <i data-lucide="circle-check" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">着金済</div>
            <div class="stat-value" id="stat-paid">-</div>
          </div>
        </div>
        <div class="stat-card amount">
          <div class="stat-icon">
            <i data-lucide="banknote" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">未入金額</div>
            <div class="stat-value small" id="stat-pending-amount">-</div>
          </div>
        </div>
        <div class="stat-card paid-amount">
          <div class="stat-icon">
            <i data-lucide="piggy-bank" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">着金済金額</div>
            <div class="stat-value small" id="stat-paid-amount">-</div>
          </div>
        </div>
        <div class="stat-card total-amount">
          <div class="stat-icon">
            <i data-lucide="trending-up" style="width:24px;height:24px;"></i>
          </div>
          <div class="stat-info">
            <div class="stat-label">請求総額</div>
            <div class="stat-value small" id="stat-total-amount">-</div>
          </div>
        </div>
      </div>

      <!-- 更新案内アクションセクション -->
      <div class="renewal-action-section" id="renewal-action-section">
        <div class="renewal-action-icon">
          <i data-lucide="calendar-clock" style="width:18px;height:18px;"></i>
        </div>
        <div class="renewal-action-label">更新案内</div>
        <div class="renewal-action-months" id="renewal-action-badges">
          <!-- JSで動的生成 -->
        </div>
        <button class="renewal-action-btn" onclick="openRenewalNoticeModal()">
          <i data-lucide="send" style="width:14px;height:14px;"></i>
          送信
        </button>
      </div>

      <!-- 期間フィルター（着金日ベース） -->
      <div class="period-filter-section">
        <div class="period-filter-label">
          <i data-lucide="calendar" style="width:14px;height:14px;"></i>
          着金期間:
        </div>
        <div class="period-preset-buttons">
          <button class="period-btn active" data-period="all" onclick="setPeriodFilter('all')">全期間</button>
          <button class="period-btn" data-period="thisMonth" onclick="setPeriodFilter('thisMonth')">今月</button>
          <button class="period-btn" data-period="lastMonth" onclick="setPeriodFilter('lastMonth')">先月</button>
          <button class="period-btn" data-period="thisYear" onclick="setPeriodFilter('thisYear')">今年</button>
          <button class="period-btn" data-period="custom" onclick="toggleCustomPeriod()">カスタム</button>
        </div>
        <div class="period-custom-inputs" id="period-custom-inputs" style="display:none;">
          <input type="date" id="period-start" class="period-date-input">
          <span>〜</span>
          <input type="date" id="period-end" class="period-date-input">
          <button class="period-apply-btn" onclick="applyCustomPeriod()">適用</button>
        </div>
      </div>

      <!-- フィルター -->
      <!-- 更新通知バナー -->
      <div class="renewal-alert" id="renewal-alert" style="display: none;">
        <div class="renewal-alert-icon">
          <i data-lucide="bell-ring" style="width:20px;height:20px;"></i>
        </div>
        <div class="renewal-alert-content">
          <div class="renewal-alert-title">更新が必要な生徒がいます</div>
          <div class="renewal-alert-text" id="renewal-alert-text">今月更新が必要な生徒が0名います</div>
        </div>
        <div class="renewal-alert-badge" id="renewal-alert-count">0</div>
      </div>

      <!-- 入金期日超過アラート -->
      <div class="overdue-alert" id="overdue-alert" style="display: none;">
        <div class="overdue-alert-icon">
          <i data-lucide="alert-triangle" style="width:20px;height:20px;"></i>
        </div>
        <div class="overdue-alert-content">
          <div class="overdue-alert-title">入金期日を超過しています</div>
          <div class="overdue-alert-text" id="overdue-alert-text">入金期日を過ぎた請求書が0件あります</div>
        </div>
        <div class="overdue-alert-badge" id="overdue-alert-count">0</div>
      </div>

      <div class="filter-bar">
        <div class="search-box">
          <i data-lucide="search" style="width:16px;height:16px;"></i>
          <input type="text" id="search-input" placeholder="生徒番号・氏名で検索..." oninput="renderList()">
        </div>
        <div class="filter-buttons">
          <span class="filter-label">
            <i data-lucide="filter" style="width:14px;height:14px;"></i>
            フィルター:
          </span>
          <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">すべて</button>
          <button class="filter-btn" data-filter="pending" onclick="setFilter('pending')">未送信</button>
          <button class="filter-btn" data-filter="waiting" onclick="setFilter('waiting')">入金待ち</button>
          <button class="filter-btn" data-filter="paid" onclick="setFilter('paid')">着金済</button>
        </div>
        <button class="price-table-btn" onclick="openPriceModal()">
          <i data-lucide="calculator" style="width:16px;height:16px;"></i>
          料金表
        </button>
      </div>

      <!-- 生徒リスト -->
      <div class="student-list" id="student-list">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>データを読み込んでいます...</span>
        </div>
      </div>
    </div><!-- /tab-invoice -->

    <!-- 給与管理タブ -->
    <div class="tab-content" id="tab-payroll">
      <div class="coming-soon-container">
        <div class="coming-soon-icon">
          <i data-lucide="hard-hat" style="width:48px;height:48px;"></i>
        </div>
        <h2 class="coming-soon-title">給与管理機能は準備中です</h2>
        <p class="coming-soon-text">講師の給与計算・支払い管理機能を開発中です。<br>もうしばらくお待ちください。</p>
        <div class="coming-soon-features">
          <div class="coming-soon-feature">
            <i data-lucide="calculator" style="width:20px;height:20px;"></i>
            <span>授業コマ数からの自動計算</span>
          </div>
          <div class="coming-soon-feature">
            <i data-lucide="calendar" style="width:20px;height:20px;"></i>
            <span>月次給与明細の作成</span>
          </div>
          <div class="coming-soon-feature">
            <i data-lucide="send" style="width:20px;height:20px;"></i>
            <span>給与明細のメール送信</span>
          </div>
        </div>
      </div>
    </div><!-- /tab-payroll -->

    <!-- コマ数管理タブ -->
    <div class="tab-content" id="tab-lessons">
      <!-- サマリーカード -->
      <div class="lessons-summary">
        <div class="lessons-summary-card">
          <div class="lessons-summary-icon total">
            <i data-lucide="book-open" style="width:24px;height:24px;"></i>
          </div>
          <div class="lessons-summary-info">
            <div class="lessons-summary-label">総合型 合計</div>
            <div class="lessons-summary-value" id="total-lessons-sum">-</div>
          </div>
        </div>
        <div class="lessons-summary-card">
          <div class="lessons-summary-icon english">
            <i data-lucide="globe" style="width:24px;height:24px;"></i>
          </div>
          <div class="lessons-summary-info">
            <div class="lessons-summary-label">ENGLISH 合計</div>
            <div class="lessons-summary-value" id="english-lessons-sum">-</div>
          </div>
        </div>
      </div>

      <!-- 生徒一覧 -->
      <div class="lessons-student-list" id="lessons-student-list">
        <!-- 動的に生成 -->
      </div>
    </div><!-- /tab-lessons -->
  </main>

  <!-- 請求書作成ウィザードモーダル -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal wizard-modal">
      <div class="modal-header">
        <div class="modal-title" id="wizard-modal-title">
          <i data-lucide="file-text" style="width:20px;height:20px;"></i>
          請求書作成
        </div>
        <button class="modal-close" onclick="closeModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>

      <!-- ステップインジケーター -->
      <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
          <div class="wizard-step-number">1</div>
          <div class="wizard-step-label">設定</div>
        </div>
        <div class="wizard-step-line"></div>
        <div class="wizard-step" data-step="2">
          <div class="wizard-step-number">2</div>
          <div class="wizard-step-label">プレビュー</div>
        </div>
        <div class="wizard-step-line"></div>
        <div class="wizard-step" data-step="3">
          <div class="wizard-step-number">3</div>
          <div class="wizard-step-label">送信</div>
        </div>
      </div>

      <div class="modal-body wizard-body">
        <!-- STEP 1: 設定 -->
        <div class="wizard-content active" id="wizard-step-1">
          <div id="invoice-settings-content">
            <!-- 動的に生成 -->
          </div>
        </div>

        <!-- STEP 2: プレビュー -->
        <div class="wizard-content" id="wizard-step-2">
          <div class="pdf-preview-container">
            <div class="pdf-preview-area" id="pdf-preview-area">
              <div class="pdf-loading">
                <div class="pdf-loading-spinner"></div>
                <p>PDFを生成中...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 3: 送信 -->
        <div class="wizard-content" id="wizard-step-3">
          <div class="email-form-container">
            <div class="email-form-group">
              <label class="email-label">送信先</label>
              <input type="email" class="email-input" id="wizard-email-to">
            </div>
            <div class="email-form-group">
              <label class="email-label">件名</label>
              <input type="text" class="email-input" id="wizard-email-subject">
            </div>
            <div class="email-form-group">
              <label class="email-label">本文</label>
              <textarea class="email-textarea" id="wizard-email-body" rows="12"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer wizard-footer">
        <button class="wizard-btn back" id="wizard-back-btn" onclick="wizardBack()" style="display:none;">
          <i data-lucide="arrow-left" style="width:16px;height:16px;"></i>
          戻る
        </button>
        <div class="wizard-footer-spacer"></div>
        <button class="wizard-btn next" id="wizard-next-btn" onclick="wizardNext()">
          次へ
          <i data-lucide="arrow-right" style="width:16px;height:16px;"></i>
        </button>
        <button class="wizard-btn send" id="wizard-send-btn" onclick="wizardSend()" style="display:none;">
          <i data-lucide="send" style="width:16px;height:16px;"></i>
          送信する
        </button>
      </div>
    </div>
  </div>

  <!-- 料金表モーダル -->
  <div class="modal-overlay" id="price-modal">
    <div class="modal price-modal">
      <div class="modal-header">
        <div class="modal-title">
          <i data-lucide="calculator" style="width:20px;height:20px;"></i>
          料金表
        </div>
        <button class="modal-close" onclick="closePriceModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body price-table-body">
        <div class="price-section">
          <h3 class="price-section-title">📦 初期費用（税込）</h3>
          <table class="price-table">
            <tr>
              <td>入塾金</td>
              <td class="price-value">¥39,800</td>
            </tr>
            <tr>
              <td>教材費</td>
              <td class="price-value">¥19,800</td>
            </tr>
            <tr>
              <td>アカウント設定費</td>
              <td class="price-value">¥550</td>
            </tr>
            <tr>
              <td>過去動画教材費（任意）</td>
              <td class="price-value">¥11,000</td>
            </tr>
          </table>
        </div>

        <div class="price-section">
          <h3 class="price-section-title">📚 月額費用（税込）</h3>
          <table class="price-table">
            <tr>
              <td>在籍基本料</td>
              <td class="price-value">¥11,980</td>
            </tr>
            <tr>
              <td>システムサーバー費</td>
              <td class="price-value">¥2,980</td>
            </tr>
          </table>
        </div>

        <div class="price-section">
          <h3 class="price-section-title">🎓 授業料（税込/1コマ）</h3>
          <table class="price-table">
            <tr>
              <td>海外大学・国公立大学</td>
              <td class="price-value">¥15,500</td>
            </tr>
            <tr>
              <td>難関私立大学</td>
              <td class="price-value">¥13,500</td>
            </tr>
            <tr>
              <td>一般私立大学</td>
              <td class="price-value">¥12,800</td>
            </tr>
            <tr>
              <td>ENGLISH（英語資格対策）</td>
              <td class="price-value">¥12,800</td>
            </tr>
          </table>
        </div>

        <div class="price-section">
          <h3 class="price-section-title">🎁 まとめ払い割引</h3>
          <table class="price-table">
            <tr>
              <td>4ヶ月</td>
              <td class="price-value discount">-¥10,000</td>
            </tr>
            <tr>
              <td>5ヶ月</td>
              <td class="price-value discount">-¥12,500</td>
            </tr>
            <tr>
              <td>6ヶ月</td>
              <td class="price-value discount">-¥15,000</td>
            </tr>
            <tr>
              <td>7ヶ月</td>
              <td class="price-value discount">-¥17,500</td>
            </tr>
            <tr>
              <td>8ヶ月</td>
              <td class="price-value discount">-¥20,000</td>
            </tr>
            <tr>
              <td>9ヶ月</td>
              <td class="price-value discount">-¥25,000</td>
            </tr>
            <tr>
              <td>10ヶ月</td>
              <td class="price-value discount">-¥30,000</td>
            </tr>
            <tr>
              <td>11ヶ月</td>
              <td class="price-value discount">-¥35,000</td>
            </tr>
            <tr>
              <td>12ヶ月</td>
              <td class="price-value discount">-¥40,000</td>
            </tr>
          </table>
        </div>

        <div class="price-section">
          <h3 class="price-section-title">💡 特別割引（入塾金より）</h3>
          <table class="price-table">
            <tr>
              <td>ひとり親割引</td>
              <td class="price-value discount">-¥10,000</td>
            </tr>
            <tr>
              <td>紹介割引</td>
              <td class="price-value discount">-¥10,000</td>
            </tr>
          </table>
          <p class="price-note">※ 経理確認の上、適用</p>
        </div>
      </div>
    </div>
  </div>

  <!-- メール編集モーダル -->
  <div class="modal-overlay" id="email-modal">
    <div class="modal email-modal">
      <div class="modal-header">
        <div class="modal-title">
          <i data-lucide="mail" style="width:20px;height:20px;"></i>
          メール送信
        </div>
        <button class="modal-close" onclick="closeEmailModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body email-modal-body">
        <div class="email-form">
          <div class="email-field">
            <label class="email-label">宛先</label>
            <input type="email" class="email-input" id="email-to">
          </div>
          <div class="email-field">
            <label class="email-label">件名</label>
            <input type="text" class="email-input" id="email-subject">
          </div>
          <div class="email-field">
            <label class="email-label">本文</label>
            <div class="email-preview-toggle">
              <button class="toggle-btn active" onclick="setEmailView('edit')">編集</button>
              <button class="toggle-btn" onclick="setEmailView('preview')">プレビュー</button>
            </div>
          </div>
          <div class="email-body-edit" id="email-body-edit">
            <textarea class="email-textarea" id="email-body"></textarea>
          </div>
          <div class="email-body-preview" id="email-body-preview" style="display:none;">
            <div class="email-html-preview" id="email-html-preview"></div>
          </div>
        </div>
        <div class="email-attachment">
          <i data-lucide="paperclip" style="width:14px;height:14px;"></i>
          <span>添付: 請求書PDF</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn secondary" onclick="closeEmailModal()">
          キャンセル
        </button>
        <button class="action-btn send" onclick="confirmSendEmail()">
          <i data-lucide="send" style="width:16px;height:16px;"></i>
          送信する
        </button>
      </div>
    </div>
  </div>

  <!-- トースト -->
  <div class="toast" id="toast"></div>

  <script>
    // ===== ログインチェック =====
    document.addEventListener('DOMContentLoaded', () => {
      checkLoginStatus();
    });

    function checkLoginStatus() {
      const session = localStorage.getItem('eqao_staff_session');
      if (!session) { window.location.href = 'login.html'; return; }
      try {
        const data = JSON.parse(session);
        if (Date.now() > data.expiresAt) { localStorage.removeItem('eqao_staff_session'); window.location.href = 'login.html'; return; }
        displayUserInfo(data);
      } catch { localStorage.removeItem('eqao_staff_session'); window.location.href = 'login.html'; }
    }

    function displayUserInfo(data) {
      const name = data.name || data.employeeId || '-';
      const email = data.email || '-';
      const initial = name.charAt(0).toUpperCase();
      document.getElementById('userAvatar').textContent = initial;
      document.getElementById('userName').textContent = name;
      document.getElementById('dropdownName').textContent = name;
      document.getElementById('dropdownEmail').textContent = email;
    }

    function toggleUserMenu() {
      document.getElementById('userDropdown').classList.toggle('show');
    }

    document.addEventListener('click', (e) => {
      const userMenu = document.querySelector('.user-menu');
      const dropdown = document.getElementById('userDropdown');
      if (userMenu && !userMenu.contains(e.target)) { dropdown.classList.remove('show'); }
    });

    function handleLogout() {
      if (confirm('ログアウトしますか？')) { localStorage.removeItem('eqao_staff_session'); window.location.href = 'login.html'; }
    }

    // ===== 設定 =====
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyFJMfjgZzOw9v16PEoQQrRqqYe__oSn6zHdajEXdeXaUf6ACxwBhcMaGf449Qju-t-/exec';

    // 請求書用画像URL（GitHubにアップロード後に設定）
    const INVOICE_IMAGES = {
      stamp: 'https://raw.githubusercontent.com/eqao-dev/eqao-staff-portal/main/stamp.png',
      logo: 'https://raw.githubusercontent.com/eqao-dev/eqao-staff-portal/main/logo.png'
    };

    // ===== 状態管理 =====
    let students = [];
    let currentFilter = 'all';
    let currentBillingType = 'all'; // all, new, renewal
    let currentStudent = null;
    let currentPeriod = 'all'; // all, thisMonth, lastMonth, thisYear, custom
    let periodStart = null;
    let periodEnd = null;
    let purchasedLessonsMap = {}; // 生徒ごとの購入コマ数
    let invoiceHistoryData = []; // 請求書履歴データ
    let isResendMode = false; // 再送信モードフラグ
    let editedCourseData = {}; // 編集された受講内容を保持

    // ===== タブ切り替え =====
    function switchTab(tabId) {
      // タブボタンの状態更新
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
      });

      // タブコンテンツの表示切り替え
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabId}`);
      });

      // コマ数管理タブの場合はデータを表示
      if (tabId === 'lessons') {
        renderLessonsTab();
      }

      lucide.createIcons();
    }

    // ===== 料金定数 =====
    const PRICES = {
      // 初期費用
      ENROLLMENT_FEE: 39800,      // 入塾金
      MATERIAL_FEE: 19800,        // 教材費
      ACCOUNT_FEE: 550,           // アカウント設定費
      VIDEO_FEE: 11000,           // 過去動画教材費（入塾時）

      // 月額費用
      BASIC_FEE: 11980,           // 在籍基本料
      SYSTEM_FEE: 2980,           // システムサーバー費

      // 授業料（コマ単価）
      COURSE: {
        '海外大学': 15500,
        '国公立大学': 15500,
        '難関私立大学': 13500,
        '一般私立大学': 12800,
        // 旧名称対応
        '難関国公立大学': 15500,
        '最難関私大': 13500,
        '難関私大': 12800
      },

      // ENGLISH
      ENGLISH: 12800,

      // まとめ払い割引
      BULK_DISCOUNT: {
        4: 10000,
        5: 12500,
        6: 15000,
        7: 17500,
        8: 20000,
        9: 25000,
        10: 30000,
        11: 35000,
        12: 40000
      }
    };

    // ===== ひとり親証明書リンクのフォーマット =====
    function formatProofLinks(proofUrls) {
      if (!proofUrls) return '-';

      // URLが連結されている場合を分割（https://で区切る）
      const urls = proofUrls.split(/(?=https:\/\/)/g).filter(url => url.trim());

      if (urls.length === 0) return '-';

      return urls.map((url, index) => {
        const label = urls.length > 1 ? `書類${index + 1}` : '確認する';
        return `<a href="${url.trim()}" target="_blank" class="proof-link">
          <i data-lucide="external-link" style="width:12px;height:12px;"></i>
          ${label}
        </a>`;
      }).join(' ');
    }

    // ===== 購入コマ数表示 =====
    function renderPurchasedLessons(studentId) {
      const lessons = purchasedLessonsMap[studentId];

      if (!lessons || (lessons.totalLessons === 0 && lessons.englishLessons === 0)) {
        return ''; // データがなければ非表示
      }

      return `
        <div class="detail-section purchased-lessons">
          <div class="detail-section-title">
            <i data-lucide="package-check" style="width:14px;height:14px;"></i>
            購入済みコマ数（着金済分）
          </div>
          ${lessons.totalLessons > 0 ? `
          <div class="detail-item">
            <span class="detail-label">総合型選抜コース</span>
            <span class="detail-value purchased">${lessons.totalLessons}コマ</span>
          </div>
          ` : ''}
          ${lessons.englishLessons > 0 ? `
          <div class="detail-item">
            <span class="detail-label">ENGLISH</span>
            <span class="detail-value purchased">${lessons.englishLessons}コマ</span>
          </div>
          ` : ''}
        </div>
      `;
    }

    // ===== 料金内訳計算・表示 =====
    function renderBillingBreakdown(student) {
      const monthlyLessons = parseInt(student.monthlyLessons) || 0;
      const paymentMonths = parseInt(student.paymentMonth) || 0;
      const englishLessons = parseInt(student.englishLessons) || 0;
      const englishMonths = parseInt(student.englishPayment) || 0;
      const courseType = student.course || '';
      const hasVideo = student.videoMaterial === '購入する';

      // === 初期費用計算 ===
      let initialItems = [];
      initialItems.push({ name: '入塾金', amount: PRICES.ENROLLMENT_FEE });
      initialItems.push({ name: '教材費', amount: PRICES.MATERIAL_FEE });
      initialItems.push({ name: 'アカウント設定費', amount: PRICES.ACCOUNT_FEE });
      if (hasVideo) {
        initialItems.push({ name: '過去動画教材費', amount: PRICES.VIDEO_FEE });
      }
      const initialSubtotal = initialItems.reduce((sum, item) => sum + item.amount, 0);

      // === 総合型コース計算 ===
      let courseItems = [];
      let courseSubtotal = 0;
      let bulkDiscount = 0;

      if (monthlyLessons > 0 && paymentMonths > 0) {
        const coursePrice = PRICES.COURSE[courseType] || 0;
        const basicTotal = PRICES.BASIC_FEE * paymentMonths;
        const systemTotal = PRICES.SYSTEM_FEE * paymentMonths;
        const lessonTotal = coursePrice * monthlyLessons * paymentMonths;

        courseItems.push({
          name: '在籍基本料',
          calc: `¥${PRICES.BASIC_FEE.toLocaleString()} × ${paymentMonths}ヶ月`,
          amount: basicTotal
        });
        courseItems.push({
          name: 'システムサーバー費',
          calc: `¥${PRICES.SYSTEM_FEE.toLocaleString()} × ${paymentMonths}ヶ月`,
          amount: systemTotal
        });
        courseItems.push({
          name: `授業料（${courseType || '未選択'}）`,
          calc: `¥${coursePrice.toLocaleString()} × ${monthlyLessons}コマ × ${paymentMonths}ヶ月`,
          amount: lessonTotal
        });

        // まとめ払い割引
        if (PRICES.BULK_DISCOUNT[paymentMonths]) {
          bulkDiscount = PRICES.BULK_DISCOUNT[paymentMonths];
          courseItems.push({
            name: `まとめ払い割引（${paymentMonths}ヶ月）`,
            calc: '',
            amount: -bulkDiscount,
            isDiscount: true
          });
        }

        courseSubtotal = basicTotal + systemTotal + lessonTotal - bulkDiscount;
      }

      // === ENGLISH計算 ===
      let englishItems = [];
      let englishSubtotal = 0;

      if (englishLessons > 0 && englishMonths > 0) {
        const englishTotal = PRICES.ENGLISH * englishLessons * englishMonths;
        englishItems.push({
          name: '英語資格対策授業料',
          calc: `¥${PRICES.ENGLISH.toLocaleString()} × ${englishLessons}コマ × ${englishMonths}ヶ月`,
          amount: englishTotal
        });
        englishSubtotal = englishTotal;
      }

      // === 計算合計 ===
      const calculatedTotal = initialSubtotal + courseSubtotal + englishSubtotal;

      // === SSの値と比較 ===
      const ssInitial = parseInt(student.initialFee) || 0;
      const ssCourse = parseInt(student.courseFee) || 0;
      const ssEnglish = parseInt(student.englishFee) || 0;
      const ssDiscount = parseInt(student.discount) || 0;
      const ssTotal = parseInt(student.total) || 0;

      const isMatch = calculatedTotal === ssTotal;

      // === HTML生成 ===
      let html = '';

      // 初期費用
      html += `
        <div class="breakdown-section">
          <div class="breakdown-section-header">
            <span class="breakdown-section-title">📦 初期費用</span>
            <span class="breakdown-section-subtotal">¥${initialSubtotal.toLocaleString()}</span>
          </div>
          <div class="breakdown-items">
            ${initialItems.map(item => `
              <div class="breakdown-item">
                <span class="breakdown-item-name">${item.name}</span>
                <span class="breakdown-item-calc"></span>
                <span class="breakdown-item-amount">¥${item.amount.toLocaleString()}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // 総合型コース
      if (courseItems.length > 0) {
        html += `
          <div class="breakdown-section">
            <div class="breakdown-section-header">
              <span class="breakdown-section-title">📚 総合型選抜コース</span>
              <span class="breakdown-section-subtotal">¥${courseSubtotal.toLocaleString()}</span>
            </div>
            <div class="breakdown-items">
              ${courseItems.map(item => `
                <div class="breakdown-item">
                  <span class="breakdown-item-name">${item.name}</span>
                  <span class="breakdown-item-calc">${item.calc}</span>
                  <span class="breakdown-item-amount ${item.isDiscount ? 'discount' : ''}">${item.isDiscount ? '-' : ''}¥${Math.abs(item.amount).toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // ENGLISH
      if (englishItems.length > 0) {
        html += `
          <div class="breakdown-section">
            <div class="breakdown-section-header">
              <span class="breakdown-section-title">🌐 ENGLISHコース</span>
              <span class="breakdown-section-subtotal">¥${englishSubtotal.toLocaleString()}</span>
            </div>
            <div class="breakdown-items">
              ${englishItems.map(item => `
                <div class="breakdown-item">
                  <span class="breakdown-item-name">${item.name}</span>
                  <span class="breakdown-item-calc">${item.calc}</span>
                  <span class="breakdown-item-amount">¥${item.amount.toLocaleString()}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // 合計
      html += `
        <div class="breakdown-total">
          <span class="breakdown-total-label">計算合計（税込）</span>
          <span class="breakdown-total-amount">¥${calculatedTotal.toLocaleString()}</span>
        </div>
      `;

      // SSとの比較
      html += `
        <div class="breakdown-check ${isMatch ? 'match' : 'mismatch'}">
          <i data-lucide="${isMatch ? 'check-circle' : 'alert-triangle'}" style="width:20px;height:20px;"></i>
          <span class="breakdown-check-text">
            ${isMatch
          ? 'SS記録額と一致しています'
          : `SS記録額: ¥${ssTotal.toLocaleString()}（差額: ¥${Math.abs(calculatedTotal - ssTotal).toLocaleString()}）`
        }
          </span>
        </div>
      `;

      return html;
    }

    // ===== 初期化 =====
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      loadData();
    });

    // ===== データ読み込み =====
    async function loadData() {
      const listEl = document.getElementById('student-list');
      listEl.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>データを読み込んでいます...</span>
        </div>
      `;

      try {
        // 経理データと請求書履歴を同時に取得
        const [accountingRes, historyRes] = await Promise.all([
          fetch(`${GAS_API_URL}?action=getAccountingData`),
          fetch(`${GAS_API_URL}?action=getInvoiceHistory`)
        ]);

        const accountingResult = await accountingRes.json();
        const historyResult = await historyRes.json();

        if (accountingResult.success) {
          students = accountingResult.data || [];

          // 購入コマ数と請求書履歴を保持
          if (historyResult.success) {
            purchasedLessonsMap = historyResult.purchasedLessons || {};
            invoiceHistoryData = historyResult.data || [];
          }

          updateStats();
          renderList();
        } else {
          throw new Error(accountingResult.message || 'データ取得失敗');
        }
      } catch (error) {
        console.error('データ取得エラー:', error);
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <i data-lucide="alert-circle" style="width:32px;height:32px;"></i>
            </div>
            <div class="empty-state-title">データの取得に失敗しました</div>
            <p>${error.message}</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // ===== 請求タイプ切り替え =====
    function setBillingType(type) {
      currentBillingType = type;
      document.querySelectorAll('.billing-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      updateStats();
      renderList();
    }

    // ===== 統計更新 =====
    function updateStats() {
      // 請求タイプでフィルタリング
      const newStudents = students.filter(s => s.billingType === '新規' || !s.billingType);
      const renewalStudents = students.filter(s => s.billingType === '継続');

      // カウント表示
      document.getElementById('count-all').textContent = students.length;
      document.getElementById('count-new').textContent = newStudents.length;
      document.getElementById('count-renewal').textContent = renewalStudents.length;

      // 現在の表示対象
      let filtered = students;
      if (currentBillingType === 'new') {
        filtered = newStudents;
      } else if (currentBillingType === 'renewal') {
        filtered = renewalStudents;
      }

      // ステータス別カウント（未送信 / 入金待ち / 着金済）
      const pending = filtered.filter(s => !s.invoiceSent || s.invoiceSent === '未送信').length;
      const waiting = filtered.filter(s => s.invoiceSent === '入金待ち').length;
      const paid = filtered.filter(s => s.invoiceSent === '着金済').length;

      // 期間でフィルターされた着金済データ
      const paidInPeriod = filtered.filter(s => s.invoiceSent === '着金済' && isPaidInPeriod(s));
      const paidCountInPeriod = paidInPeriod.length;

      // 金額計算（billedAmountがあればそれを使用、なければtotalを使用）
      const getAmount = (s) => parseInt(s.billedAmount) || parseInt(s.total) || 0;

      const pendingAmount = filtered
        .filter(s => s.invoiceSent === '入金待ち')
        .reduce((sum, s) => sum + getAmount(s), 0);

      // 着金済金額は期間フィルター適用
      const paidAmount = paidInPeriod
        .reduce((sum, s) => sum + getAmount(s), 0);

      const totalAmount = filtered.reduce((sum, s) => sum + getAmount(s), 0);

      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-sent').textContent = waiting;
      document.getElementById('stat-paid').textContent = currentPeriod === 'all' ? paid : `${paidCountInPeriod}/${paid}`;
      document.getElementById('stat-pending-amount').textContent = '¥' + pendingAmount.toLocaleString();
      document.getElementById('stat-paid-amount').textContent = '¥' + paidAmount.toLocaleString();
      document.getElementById('stat-total-amount').textContent = '¥' + totalAmount.toLocaleString();

      updateRenewalCardCounts();

      // 更新通知バナーの表示
      checkRenewalAlerts();
    }

    // ===== 更新通知チェック =====
    function checkRenewalAlerts() {
      const now = new Date();
      const currentMonth = now.getFullYear() * 100 + (now.getMonth() + 1); // 202412形式
      const nextMonth = now.getMonth() === 11
        ? (now.getFullYear() + 1) * 100 + 1
        : now.getFullYear() * 100 + (now.getMonth() + 2);

      // 更新が必要な生徒（次回更新月が今月または来月）
      const renewalNeeded = students.filter(s => {
        if (!s.nextRenewalMonth) return false;
        const renewalMonth = parseInt(s.nextRenewalMonth);
        return renewalMonth > 0 && renewalMonth <= nextMonth;
      });

      const alertEl = document.getElementById('renewal-alert');
      const countEl = document.getElementById('renewal-alert-count');
      const textEl = document.getElementById('renewal-alert-text');

      // 更新通知バナーの表示（既存コードを修正）
      if (renewalNeeded.length > 0) {
        alertEl.style.display = 'flex';
        countEl.textContent = renewalNeeded.length;

        const thisMonthCount = renewalNeeded.filter(s => parseInt(s.nextRenewalMonth) <= currentMonth).length;
        const nextMonthCount = renewalNeeded.length - thisMonthCount;

        let text = '';
        if (thisMonthCount > 0) {
          text += `今月更新が必要: ${thisMonthCount}名`;
        }
        if (nextMonthCount > 0) {
          if (text) text += '、';
          text += `来月更新予定: ${nextMonthCount}名`;
        }
        textEl.textContent = text;

        // 更新案内ボタンを追加
        if (!document.getElementById('renewal-notice-btn')) {
          const btnHtml = `
      <button id="renewal-notice-btn" onclick="openRenewalNoticeModal()" style="
        background:#f59e0b;
        color:#fff;
        border:none;
        padding:8px 16px;
        border-radius:8px;
        font-size:13px;
        font-weight:600;
        cursor:pointer;
        margin-left:12px;
        display:flex;
        align-items:center;
        gap:6px;
      ">
        <i data-lucide="send" style="width:14px;height:14px;"></i>
        更新案内を送信
      </button>
    `;
          alertEl.querySelector('.renewal-alert-content').insertAdjacentHTML('afterend', btnHtml);
        }

        lucide.createIcons();
      } else {
        alertEl.style.display = 'none';
      }

      // 期日超過チェック
      checkOverdueAlerts();
    }

    // ===== 入金期日超過チェック =====
    // 入金期日設定（デフォルト値として使用）
    const PAYMENT_DUE_DAYS = {
      '新規': 3,    // 新規: 送信日から3日後
      '継続': 14    // 継続: 送信日から14日後
    };

    function getPaymentDueDays(student) {
      const billingType = student.billingType || '新規';
      return PAYMENT_DUE_DAYS[billingType] || PAYMENT_DUE_DAYS['新規'];
    }

    function isOverdue(student) {
      if (student.invoiceSent !== '入金待ち') return false;

      // スプレッドシートに入金期日がある場合はそれを使用
      if (student.dueDate) {
        let dueDate;
        if (typeof student.dueDate === 'string') {
          dueDate = new Date(student.dueDate.replace(/\//g, '-'));
        } else {
          dueDate = new Date(student.dueDate);
        }

        if (!isNaN(dueDate.getTime())) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return today > dueDate;
        }
      }

      // 入金期日がない場合は送信日 + デフォルト日数で計算
      if (!student.invoiceDate) return false;

      let sendDate;
      if (typeof student.invoiceDate === 'string') {
        sendDate = new Date(student.invoiceDate.replace(/\//g, '-'));
      } else {
        sendDate = new Date(student.invoiceDate);
      }

      if (isNaN(sendDate.getTime())) return false;

      const dueDays = getPaymentDueDays(student);
      const dueDate = new Date(sendDate);
      dueDate.setDate(dueDate.getDate() + dueDays);

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return today > dueDate;
    }

    function getDaysOverdue(student) {
      let dueDate;

      // スプレッドシートに入金期日がある場合はそれを使用
      if (student.dueDate) {
        if (typeof student.dueDate === 'string') {
          dueDate = new Date(student.dueDate.replace(/\//g, '-'));
        } else {
          dueDate = new Date(student.dueDate);
        }

        if (isNaN(dueDate.getTime())) {
          dueDate = null;
        }
      }

      // 入金期日がない場合は送信日 + デフォルト日数で計算
      if (!dueDate && student.invoiceDate) {
        let sendDate;
        if (typeof student.invoiceDate === 'string') {
          sendDate = new Date(student.invoiceDate.replace(/\//g, '-'));
        } else {
          sendDate = new Date(student.invoiceDate);
        }

        if (!isNaN(sendDate.getTime())) {
          const dueDays = getPaymentDueDays(student);
          dueDate = new Date(sendDate);
          dueDate.setDate(dueDate.getDate() + dueDays);
        }
      }

      if (!dueDate) return 0;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const diffTime = today - dueDate;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return Math.max(0, diffDays);
    }

    function checkOverdueAlerts() {
      // 入金待ちで期日超過の生徒
      const overdueStudents = students.filter(s => isOverdue(s));

      const alertEl = document.getElementById('overdue-alert');
      const countEl = document.getElementById('overdue-alert-count');
      const textEl = document.getElementById('overdue-alert-text');

      if (overdueStudents.length > 0) {
        alertEl.style.display = 'flex';
        countEl.textContent = overdueStudents.length;

        // 超過金額の計算
        const overdueAmount = overdueStudents.reduce((sum, s) => sum + (parseInt(s.total) || 0), 0);
        textEl.textContent = `入金期日を過ぎた請求書が${overdueStudents.length}件（¥${overdueAmount.toLocaleString()}）あります`;
        lucide.createIcons();
      } else {
        alertEl.style.display = 'none';
      }
    }

    // ===== コマ数管理タブ =====
    function renderLessonsTab() {
      const listEl = document.getElementById('lessons-student-list');

      // サマリー計算
      let totalLessonsSum = 0;
      let englishLessonsSum = 0;

      Object.values(purchasedLessonsMap).forEach(lessons => {
        totalLessonsSum += lessons.totalLessons || 0;
        englishLessonsSum += lessons.englishLessons || 0;
      });

      document.getElementById('total-lessons-sum').textContent = totalLessonsSum + 'コマ';
      document.getElementById('english-lessons-sum').textContent = englishLessonsSum + 'コマ';

      // 購入コマ数がある生徒のみ表示
      const studentsWithLessons = students.filter(s => {
        const lessons = purchasedLessonsMap[s.studentId];
        return lessons && (lessons.totalLessons > 0 || lessons.englishLessons > 0);
      });

      if (studentsWithLessons.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <i data-lucide="package" style="width:32px;height:32px;"></i>
            </div>
            <div class="empty-state-title">着金済みのコマ数がありません</div>
            <p>請求書を送信し、着金済みになると表示されます</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      listEl.innerHTML = studentsWithLessons.map(student => renderLessonsCard(student)).join('');
      lucide.createIcons();
    }

    function renderLessonsCard(student) {
      const lessons = purchasedLessonsMap[student.studentId] || { totalLessons: 0, englishLessons: 0 };
      const initial = (student.studentName || '?').charAt(0);

      // この生徒の請求書履歴
      const studentHistory = invoiceHistoryData.filter(h => String(h['生徒番号']) === String(student.studentId));

      return `
        <div class="lessons-card" id="lessons-card-${student.studentId}">
          <div class="lessons-card-header" onclick="toggleLessonsCard('${student.studentId}')">
            <div class="lessons-card-info">
              <div class="lessons-card-avatar">${initial}</div>
              <div>
                <div class="lessons-card-name">${student.studentName || '名前なし'}</div>
                <div class="lessons-card-id">#${student.studentId}</div>
              </div>
            </div>
            <div class="lessons-card-counts">
              <div class="lessons-count-item">
                <div class="lessons-count-label">総合型</div>
                <div class="lessons-count-value ${lessons.totalLessons > 0 ? 'total' : 'zero'}">${lessons.totalLessons}コマ</div>
              </div>
              <div class="lessons-count-item">
                <div class="lessons-count-label">ENGLISH</div>
                <div class="lessons-count-value ${lessons.englishLessons > 0 ? 'english' : 'zero'}">${lessons.englishLessons}コマ</div>
              </div>
              <div class="lessons-card-toggle">
                <i data-lucide="chevron-down" style="width:20px;height:20px;"></i>
              </div>
            </div>
          </div>
          <div class="lessons-card-detail">
            <div class="invoice-history-title">
              <i data-lucide="history" style="width:14px;height:14px;"></i>
              請求書履歴
            </div>
            ${renderInvoiceHistory(studentHistory)}
          </div>
        </div>
      `;
    }

    function renderInvoiceHistory(history) {
      if (!history || history.length === 0) {
        return '<div class="no-history">請求書履歴がありません</div>';
      }

      // 新しい順に並び替え
      const sorted = [...history].sort((a, b) => {
        const dateA = new Date(a['発行日']);
        const dateB = new Date(b['発行日']);
        return dateB - dateA;
      });

      return `
        <table class="invoice-history-table">
          <thead>
            <tr>
              <th>請求書番号</th>
              <th>発行日</th>
              <th>金額</th>
              <th>総合型</th>
              <th>ENGLISH</th>
              <th>ステータス</th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(h => `
              <tr>
                <td>${h['請求書番号'] || '-'}</td>
                <td>${formatHistoryDate(h['発行日'])}</td>
                <td>¥${(h['合計金額'] || 0).toLocaleString()}</td>
                <td>${h['総合型コマ数'] || 0}コマ</td>
                <td>${h['ENGLISHコマ数'] || 0}コマ</td>
                <td>
                  <span class="invoice-status ${h['ステータス'] === '着金済' ? 'paid' : 'waiting'}">
                    ${h['ステータス'] || '不明'}
                  </span>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function formatHistoryDate(date) {
      if (!date) return '-';
      if (typeof date === 'string') {
        return date.replace(/-/g, '/');
      }
      const d = new Date(date);
      return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
    }

    // 請求期間の日付フォーマット（YYYY-MM または ISO形式 → YYYY年MM月）
    function formatBillingPeriod(dateValue) {
      if (!dateValue) return '-';

      // 文字列に変換
      const dateStr = String(dateValue);

      // ISO形式（2025-12-31T15:00:00.000Z）の場合
      if (dateStr.includes('T')) {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return `${date.getFullYear()}年${date.getMonth() + 1}月`;
        }
      }

      // YYYY-MM形式の場合
      if (dateStr.match(/^\d{4}-\d{2}$/)) {
        const [year, month] = dateStr.split('-');
        return `${year}年${parseInt(month)}月`;
      }

      // YYYY/MM形式の場合
      if (dateStr.match(/^\d{4}\/\d{2}$/)) {
        const [year, month] = dateStr.split('/');
        return `${year}年${parseInt(month)}月`;
      }

      // その他はそのまま返す
      return dateStr;
    }

    function toggleLessonsCard(studentId) {
      const card = document.getElementById(`lessons-card-${studentId}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    // ===== フィルター設定 =====
    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      renderList();
    }

    // ===== 期間フィルター =====
    function setPeriodFilter(period) {
      currentPeriod = period;

      // ボタンの状態更新
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });

      // カスタム入力欄を非表示
      if (period !== 'custom') {
        document.getElementById('period-custom-inputs').style.display = 'none';
      }

      // 期間を設定
      const now = new Date();
      switch (period) {
        case 'thisMonth':
          periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
          periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'lastMonth':
          periodStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          periodEnd = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'thisYear':
          periodStart = new Date(now.getFullYear(), 0, 1);
          periodEnd = new Date(now.getFullYear(), 11, 31);
          break;
        case 'all':
        default:
          periodStart = null;
          periodEnd = null;
          break;
      }

      updateStats();
    }

    function toggleCustomPeriod() {
      const customInputs = document.getElementById('period-custom-inputs');
      const isVisible = customInputs.style.display !== 'none';
      customInputs.style.display = isVisible ? 'none' : 'flex';

      // ボタンの状態更新
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === 'custom' && !isVisible);
      });

      // デフォルト値を設定
      if (!isVisible) {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('period-start').value = startOfMonth.toISOString().split('T')[0];
        document.getElementById('period-end').value = now.toISOString().split('T')[0];
      }
    }

    function applyCustomPeriod() {
      const startInput = document.getElementById('period-start').value;
      const endInput = document.getElementById('period-end').value;

      if (!startInput || !endInput) {
        showToast('開始日と終了日を入力してください', 'warning');
        return;
      }

      currentPeriod = 'custom';
      periodStart = new Date(startInput);
      periodEnd = new Date(endInput);
      periodEnd.setHours(23, 59, 59, 999); // 終了日の終わりまで含める

      updateStats();
      showToast(`期間: ${startInput} 〜 ${endInput}`, 'info');
    }

    // 着金日が期間内かチェック
    function isPaidInPeriod(student) {
      if (!periodStart || !periodEnd) return true; // 全期間の場合
      if (!student.paidDate) return false; // 着金日がない場合は含めない

      // 着金日をパース
      let paidDate;
      if (typeof student.paidDate === 'string') {
        paidDate = new Date(student.paidDate.replace(/\//g, '-'));
      } else {
        paidDate = new Date(student.paidDate);
      }

      return paidDate >= periodStart && paidDate <= periodEnd;
    }

    // ===== リスト描画 =====
    function renderList() {
      const listEl = document.getElementById('student-list');
      const searchQuery = document.getElementById('search-input').value.toLowerCase().trim();

      let filtered = [...students];

      // 請求タイプフィルター
      if (currentBillingType === 'new') {
        filtered = filtered.filter(s => s.billingType === '新規' || !s.billingType);
      } else if (currentBillingType === 'renewal') {
        filtered = filtered.filter(s => s.billingType === '継続');
      }

      // 検索フィルター
      if (searchQuery) {
        filtered = filtered.filter(s => {
          const id = String(s.studentId || '').toLowerCase();
          const name = String(s.studentName || '').toLowerCase();
          return id.includes(searchQuery) || name.includes(searchQuery);
        });
      }

      // ステータスフィルター
      if (currentFilter === 'pending') {
        filtered = filtered.filter(s => !s.invoiceSent || s.invoiceSent === '' || s.invoiceSent === '未送信');
      } else if (currentFilter === 'waiting') {
        filtered = filtered.filter(s => s.invoiceSent === '入金待ち');
      } else if (currentFilter === 'paid') {
        filtered = filtered.filter(s => s.invoiceSent === '着金済');
      }

      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <i data-lucide="users" style="width:32px;height:32px;"></i>
            </div>
            <div class="empty-state-title">該当する生徒がいません</div>
            <p>条件に一致する生徒データがありません</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      listEl.innerHTML = filtered.map(student => renderStudentCard(student)).join('');
      lucide.createIcons();
    }

    // ===== 生徒カード描画 =====
    function renderStudentCard(student) {
      const status = student.invoiceSent || '未送信';
      const isPending = !status || status === '' || status === '未送信';
      const isWaiting = status === '入金待ち';
      const isPaid = status === '着金済';

      const initial = student.studentName ? student.studentName.charAt(0) : '?';
      // 請求金額（billedAmountがあればそれを使用）
      const total = parseInt(student.billedAmount) || parseInt(student.total) || 0;
      const originalTotal = parseInt(student.total) || 0;
      const hasDiscount = student.discountDetail && student.discountDetail.trim() !== '';
      const isRenewal = student.billingType === '継続';

      // 期日超過チェック
      const overdueFlag = isOverdue(student);
      const daysOverdue = getDaysOverdue(student);

      // ステータスに応じたクラスとラベル
      let statusClass = 'pending';
      let statusLabel = '未送信';
      if (isWaiting) {
        statusClass = 'waiting';
        statusLabel = '入金待ち';
      } else if (isPaid) {
        statusClass = 'paid';
        statusLabel = '着金済';
      }

      // ステータス変更用のドロップダウン（入金待ち・着金済の場合のみ）
      const statusDropdown = (isWaiting || isPaid) ? `
        <div class="status-dropdown">
          <button class="status-dropdown-btn ${statusClass}" onclick="event.stopPropagation(); toggleStatusDropdown('${student.studentId}')">
            ${statusLabel}
            <i data-lucide="chevron-down" style="width:12px;height:12px;"></i>
          </button>
          <div class="status-dropdown-menu" id="status-menu-${student.studentId}">
            ${statusLabel !== '入金待ち' ? `
              <div class="status-dropdown-item" onclick="event.stopPropagation(); changeStatus('${student.studentId}', '入金待ち')">
                入金待ち
              </div>
            ` : ''}
            ${statusLabel !== '着金済' ? `
              <div class="status-dropdown-item" onclick="event.stopPropagation(); changeStatus('${student.studentId}', '着金済')">
                着金済
              </div>
            ` : ''}
          </div>
        </div>
      ` : `
        <span class="status-tag pending">未送信</span>
      `;

      // 期日超過バッジ
      const overdueBadge = overdueFlag ? `
        <span class="overdue-badge">
          <i data-lucide="alert-triangle" style="width:12px;height:12px;"></i>
          ${daysOverdue}日超過
        </span>
      ` : '';

      return `
        <div class="student-card ${statusClass} ${overdueFlag ? 'overdue' : ''}" id="card-${student.studentId}">
          <div class="student-header" onclick="toggleCard('${student.studentId}')">
            <div class="student-info">
              <div class="student-avatar">${initial}</div>
              <div>
                <div class="student-name">
                  ${student.studentName || '名前なし'}
                  <span class="billing-type-badge ${isRenewal ? 'renewal' : 'new'}">${isRenewal ? '継続' : '新規'}</span>
                  ${overdueBadge}
                </div>
                <div class="student-meta">
                  <span><i data-lucide="hash" style="width:12px;height:12px;"></i>${student.studentId}</span>
                  <span><i data-lucide="graduation-cap" style="width:12px;height:12px;"></i>${student.grade || '-'}</span>
                </div>
              </div>
            </div>
            <div class="billing-summary">
 <div class="billing-amount">¥${total.toLocaleString()}</div>
 ${statusDropdown}
 ${(isWaiting || isPaid) ? `
 <button class="resend-btn-small" onclick="event.stopPropagation(); openInvoiceDetail('${student.studentId}')" style="background:#eff6ff;border-color:#93c5fd;color:#2563eb;">
  <i data-lucide="file-search" style="width:14px;height:14px;"></i>
  確認
 </button>
 ` : ''}
 ${isWaiting ? `
 <button class="resend-btn-small" onclick="event.stopPropagation(); openResendWizard('${student.studentId}')">
  <i data-lucide="repeat" style="width:14px;height:14px;"></i>
  再送信
 </button>
 ` : ''}
 ${isPaid ? `
 <button class="resend-btn-small" onclick="event.stopPropagation(); openPaymentConfirmModal('${student.studentId}')" style="background:#fef3c7;border-color:#fcd34d;color:#92400e;">
  <i data-lucide="mail-check" style="width:14px;height:14px;"></i>
  着金確認
 </button>
 ` : ''}
</div>
            <button class="expand-btn">
              <i data-lucide="chevron-down" style="width:18px;height:18px;"></i>
            </button>
          </div>
          <div class="student-details">
            <div class="details-grid">
              <div class="detail-section">
                <div class="detail-section-title">
                  <i data-lucide="user" style="width:14px;height:14px;"></i>
                  生徒・保護者情報
                </div>
                <div class="detail-item">
                  <span class="detail-label">生徒メール</span>
                  <span class="detail-value">${student.studentEmail || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">保護者氏名</span>
                  <span class="detail-value">${student.parentName || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">保護者電話</span>
                  <span class="detail-value">${student.parentPhone || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">保護者メール</span>
                  <span class="detail-value">${student.parentEmail || '-'}</span>
                </div>
              </div>
              
              <div class="detail-section">
                <div class="detail-section-title">
                  <i data-lucide="book-open" style="width:14px;height:14px;"></i>
                  受講内容
                </div>
                <div class="detail-item">
                  <span class="detail-label">総合型コース</span>
                  <span class="detail-value">${student.course || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">月コマ数</span>
                  <span class="detail-value">${student.monthlyLessons || '-'}コマ</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">支払月数</span>
                  <span class="detail-value">${student.paymentMonth || '-'}ヶ月</span>
                </div>
                <div class="detail-item" style="border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
                  <span class="detail-label">ENGLISH</span>
                  <span class="detail-value">${student.englishEnroll || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">ENGLISH月コマ数</span>
                  <span class="detail-value">${student.englishLessons || '-'}コマ</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">ENGLISH支払月数</span>
                  <span class="detail-value">${student.englishPayment || '-'}ヶ月</span>
                </div>
                <div class="detail-item" style="border-top:1px solid #eee;padding-top:8px;margin-top:8px;">
                  <span class="detail-label">動画教材</span>
                  <span class="detail-value">${student.videoMaterial || '-'}</span>
                </div>
              </div>
              
              <div class="detail-section">
                <div class="detail-section-title">
                  <i data-lucide="tag" style="width:14px;height:14px;"></i>
                  割引情報
                </div>
                <div class="detail-item">
                  <span class="detail-label">ひとり親</span>
                  <span class="detail-value">${student.singleParent || '-'}</span>
                </div>
                ${student.singleParentProof ? `
                <div class="detail-item">
                  <span class="detail-label">証明書類</span>
                  <span class="detail-value proof-links">
                    ${formatProofLinks(student.singleParentProof)}
                  </span>
                </div>
                ` : ''}
                <div class="detail-item">
                  <span class="detail-label">紹介</span>
                  <span class="detail-value">${student.referral || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">紹介者</span>
                  <span class="detail-value">${student.referralName || '-'}</span>
                </div>
              </div>
              
              <!-- 購入コマ数（着金済分） -->
              ${renderPurchasedLessons(student.studentId)}
            </div>
            
            <!-- 詳細料金内訳セクション -->
            <div class="billing-breakdown">
              <div class="breakdown-title">
                <i data-lucide="calculator" style="width:18px;height:18px;"></i>
                料金内訳チェック
              </div>
              ${renderBillingBreakdown(student)}
            </div>
            
            <div class="action-section">
              <div class="action-section-title">
                <i data-lucide="send" style="width:16px;height:16px;"></i>
                請求書アクション
              </div>
              <div class="action-buttons">
                ${isPending ? `
                  <button class="action-btn send" onclick="openInvoiceWizard('${student.studentId}')">
                    <i data-lucide="file-text" style="width:16px;height:16px;"></i>
                    請求書作成
                  </button>
                ` : `
                  <button class="action-btn preview" onclick="openInvoiceDetail('${student.studentId}')">
                    <i data-lucide="file-search" style="width:16px;height:16px;"></i>
                    請求書確認
                  </button>
                  ${isWaiting ? `
                    <button class="action-btn resend" onclick="openResendWizard('${student.studentId}')">
                      <i data-lucide="repeat" style="width:16px;height:16px;"></i>
                      再送信
                    </button>
                  ` : ''}
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ===== カード展開 =====
    function toggleCard(studentId) {
      const card = document.getElementById(`card-${studentId}`);
      const isExpanding = !card.classList.contains('expanded');

      // 他の開いているカードを閉じる
      if (isExpanding) {
        document.querySelectorAll('.student-card.expanded').forEach(c => {
          if (c.id !== `card-${studentId}`) {
            c.classList.remove('expanded');
          }
        });
      }

      card.classList.toggle('expanded');
      lucide.createIcons();
    }

    // ===== 請求書プレビュー =====
    function openInvoicePreview(studentId) {
      currentStudent = students.find(s => String(s.studentId) === String(studentId));
      if (!currentStudent) return;

      const today = new Date();
      const invoiceDate = formatDateSlash(today);

      // 請求タイプに応じた入金期日を計算
      const dueDays = getPaymentDueDays(currentStudent);
      const dueDate = formatDateSlash(new Date(today.getTime() + dueDays * 24 * 60 * 60 * 1000));

      const invoiceNumber = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}-${currentStudent.studentId}-01`;

      // デフォルトの件名
      const isRenewal = currentStudent.billingType === '継続';
      const defaultSubject = isRenewal
        ? `総合型選抜対策 授業料`
        : `総合型選抜対策 入塾金・授業料`;

      // 請求期間のデフォルト（支払月数から計算）
      const paymentMonths = parseInt(currentStudent.paymentMonth) || 0;
      const startMonth = today.getMonth() + 1;
      const endMonth = ((startMonth + paymentMonths - 2) % 12) + 1;
      const startYear = today.getFullYear();
      const endYear = startMonth + paymentMonths - 1 > 12 ? startYear + 1 : startYear;

      // 次回更新月のデフォルト（YYYY-MM形式に変換）
      let nextRenewalMonth = currentStudent.nextRenewalMonth || '';
      if (nextRenewalMonth && nextRenewalMonth.length === 6 && !nextRenewalMonth.includes('-')) {
        nextRenewalMonth = nextRenewalMonth.slice(0, 4) + '-' + nextRenewalMonth.slice(4);
      }

      // 割引のチェック状態（スプレッドシートの値から）
      const hasSingleParent = currentStudent.singleParent === 'はい';
      const hasReferral = currentStudent.referral === 'あり';
      const referralNameDisplay = currentStudent.referralName || '';

      document.getElementById('invoice-content').innerHTML = `
        <!-- 編集パネル -->
        <div class="invoice-edit-panel">
          <div class="edit-panel-title">
            <i data-lucide="settings" style="width:16px;height:16px;"></i>
            請求書設定
          </div>
          
          <div class="edit-panel-grid">
            <!-- 生徒名 -->
            <div class="edit-panel-item">
              <label class="edit-panel-label">生徒名</label>
              <input type="text" class="edit-input" id="invoice-to-name" value="${currentStudent.studentName || ''}">
            </div>
            
            <!-- 件名 -->
            <div class="edit-panel-item full-width">
              <label class="edit-panel-label">件名</label>
              <input type="text" class="edit-input" id="invoice-subject" value="${defaultSubject}">
            </div>
            
            <!-- 請求日・請求書番号 -->
            <div class="edit-panel-item">
              <label class="edit-panel-label">請求日</label>
              <input type="text" class="edit-input" id="invoice-date" value="${invoiceDate}">
            </div>
            <div class="edit-panel-item">
              <label class="edit-panel-label">請求書番号</label>
              <input type="text" class="edit-input" id="invoice-number" value="${invoiceNumber}">
            </div>
            
            <!-- 入金期日 -->
            <div class="edit-panel-item">
              <label class="edit-panel-label">入金期日</label>
              <input type="text" class="edit-input" id="invoice-due-date" value="${dueDate}">
            </div>
            
            <!-- 請求期間 -->
            <div class="edit-panel-item">
              <label class="edit-panel-label">請求期間</label>
              <div class="period-inputs">
                <input type="month" class="period-input" id="billing-start" value="${startYear}-${String(startMonth).padStart(2, '0')}">
                <span>〜</span>
                <input type="month" class="period-input" id="billing-end" value="${endYear}-${String(endMonth).padStart(2, '0')}">
              </div>
            </div>
            
            <!-- 次回更新月 -->
            <div class="edit-panel-item">
              <label class="edit-panel-label">次回更新月</label>
              <select class="edit-input" id="next-renewal">
                ${generateRenewalMonthOptions(nextRenewalMonth)}
              </select>
            </div>
            
            <!-- 割引適用 -->
            <div class="edit-panel-item discount-section full-width">
              <label class="edit-panel-label">特別割引（入塾金から-¥10,000）</label>
              <div class="discount-checkboxes">
                <label class="discount-checkbox ${isRenewal ? 'disabled' : ''}">
                  <input type="checkbox" id="discount-single-parent" ${hasSingleParent && !isRenewal ? 'checked' : ''} ${isRenewal ? 'disabled' : ''}>
                  <span class="checkbox-label">ひとり親割引</span>
                  ${hasSingleParent ? '<span class="checkbox-hint">（申告あり）</span>' : ''}
                </label>
                <label class="discount-checkbox ${isRenewal ? 'disabled' : ''}">
                  <input type="checkbox" id="discount-referral" ${hasReferral && !isRenewal ? 'checked' : ''} ${isRenewal ? 'disabled' : ''}>
                  <span class="checkbox-label">紹介割引</span>
                  ${hasReferral ? '<span class="checkbox-hint">（紹介者: ' + referralNameDisplay + '）</span>' : ''}
                </label>
              </div>
              ${isRenewal ? '<p class="discount-note">※継続更新のため入塾金割引は適用外</p>' : ''}
            </div>
            
            <!-- 免税 -->
            <div class="edit-panel-item full-width">
              <label class="edit-panel-label">消費税</label>
              <div class="discount-checkboxes">
                <label class="discount-checkbox tax-exempt-checkbox">
                  <input type="checkbox" id="tax-exempt">
                  <span class="checkbox-label">免税（海外生徒）</span>
                </label>
              </div>
            </div>
            
            <!-- 備考 -->
            <div class="edit-panel-item full-width">
              <label class="edit-panel-label">備考</label>
              <input type="text" class="edit-input" id="invoice-remarks" value="生徒番号：${currentStudent.studentId}" placeholder="備考を入力...">
            </div>
          </div>
          
          <!-- プレビュー生成ボタン -->
          <div class="preview-button-area">
            <button class="preview-generate-btn" onclick="generatePreview()">
              <i data-lucide="eye" style="width:16px;height:16px;"></i>
              PDFプレビューを生成
            </button>
            <span class="preview-hint">※設定を変更したら再度生成してください</span>
          </div>
        </div>
        
        <!-- PDFプレビューエリア -->
        <div class="pdf-preview-area" id="pdf-preview-area">
          <div class="pdf-preview-placeholder">
            <i data-lucide="file-text" style="width:48px;height:48px;color:#ccc;"></i>
            <p>「PDFプレビューを生成」ボタンを押すと<br>実際の請求書PDFが表示されます</p>
          </div>
        </div>
      `;

      document.getElementById('invoice-modal').classList.add('show');
      lucide.createIcons();

      // プレビューデータをリセット
      currentPdfBase64 = null;
      currentInvoiceData = null;

      // 設定変更時にプレビューをリセットするイベントを追加
      const settingInputs = document.querySelectorAll('.invoice-edit-panel input, .invoice-edit-panel select');
      settingInputs.forEach(input => {
        input.addEventListener('change', invalidatePreview);
        input.addEventListener('input', invalidatePreview);
      });

      // 件名の自動フォントサイズ調整
      const subjectInput = document.getElementById('invoice-subject');
      if (subjectInput) {
        subjectInput.addEventListener('input', adjustSubjectFontSize);
        adjustSubjectFontSize(); // 初回調整
      }
    }

    // ===== ウィザード状態管理 =====
    let currentWizardStep = 1;

    // ===== 請求書作成ウィザードを開く =====
    function openInvoiceWizard(studentId) {
      currentStudent = students.find(s => String(s.studentId) === String(studentId));
      if (!currentStudent) return;

      // ウィザードをリセット
      currentWizardStep = 1;
      currentPdfBase64 = null;
      currentInvoiceData = null;

      isResendMode = false;
      editedCourseData = {};

      // モーダルタイトルを更新
      document.getElementById('wizard-modal-title').innerHTML = '<i data-lucide="file-text" style="width:20px;height:20px;"></i> 請求書作成';

      // STEP 1: 設定画面を生成
      document.getElementById('invoice-settings-content').innerHTML = generateSettingsContent();

      // モーダルを開く
      document.getElementById('invoice-modal').classList.add('show');
      updateWizardUI();
      lucide.createIcons();

      // 設定変更イベントを追加
      setTimeout(() => {
        const settingInputs = document.querySelectorAll('#invoice-settings-content input, #invoice-settings-content select');
        settingInputs.forEach(input => {
          input.addEventListener('change', () => { currentPdfBase64 = null; currentInvoiceData = null; });
          input.addEventListener('input', () => { currentPdfBase64 = null; currentInvoiceData = null; });
        });

        // 件名の自動フォントサイズ調整
        const subjectInput = document.getElementById('invoice-subject');
        if (subjectInput) {
          subjectInput.addEventListener('input', adjustSubjectFontSize);
          adjustSubjectFontSize();
        }
      }, 100);
    }

    // ===== 再送信ウィザードを開く =====
    function openResendWizard(studentId) {
      currentStudent = students.find(s => String(s.studentId) === String(studentId));
      if (!currentStudent) return;

      currentWizardStep = 1;
      currentPdfBase64 = null;
      currentInvoiceData = null;
      isResendMode = true;
      editedCourseData = {};

      document.getElementById('wizard-modal-title').innerHTML = '<i data-lucide="repeat" style="width:20px;height:20px;"></i> 請求書再送信';
      document.getElementById('invoice-settings-content').innerHTML = generateSettingsContent();
      document.getElementById('invoice-modal').classList.add('show');
      updateWizardUI();
      lucide.createIcons();

      setTimeout(() => {
        const settingInputs = document.querySelectorAll('#invoice-settings-content input, #invoice-settings-content select');
        settingInputs.forEach(input => {
          input.addEventListener('change', () => { currentPdfBase64 = null; currentInvoiceData = null; });
          input.addEventListener('input', () => { currentPdfBase64 = null; currentInvoiceData = null; });
        });

        const subjectInput = document.getElementById('invoice-subject');
        if (subjectInput) {
          subjectInput.addEventListener('input', adjustSubjectFontSize);
          adjustSubjectFontSize();
        }

        // 受講内容編集の変更を監視
        if (isResendMode) {
          const courseEditInputs = document.querySelectorAll('.course-edit-input');
          courseEditInputs.forEach(input => {
            input.addEventListener('change', updatePurchaseLessonsFromEdit);
            input.addEventListener('input', updatePurchaseLessonsFromEdit);
          });
        }
      }, 100);
    }

    // ===== 受講内容編集から購入コマ数を更新 =====
    function updatePurchaseLessonsFromEdit() {
      const monthlyLessons = parseInt(document.getElementById('edit-monthly-lessons')?.value) || 0;
      const paymentMonths = parseInt(document.getElementById('edit-payment-months')?.value) || 0;
      const englishLessons = parseInt(document.getElementById('edit-english-lessons')?.value) || 0;
      const englishMonths = parseInt(document.getElementById('edit-english-months')?.value) || 0;

      const totalLessonsInput = document.getElementById('purchase-total-lessons');
      const englishLessonsInput = document.getElementById('purchase-english-lessons');

      if (totalLessonsInput) totalLessonsInput.value = monthlyLessons * paymentMonths;
      if (englishLessonsInput) englishLessonsInput.value = englishLessons * englishMonths;

      editedCourseData = {
        course: document.getElementById('edit-course-type')?.value || currentStudent.course,
        monthlyLessons, paymentMonths, englishLessons, englishMonths
      };

      currentPdfBase64 = null;
      currentInvoiceData = null;
    }

    // ===== 次回更新月のドロップダウンオプション生成 =====
    function generateRenewalMonthOptions(selectedValue) {
      const today = new Date();
      const options = ['<option value="">選択してください</option>'];

      // 今月から18ヶ月分を生成
      for (let i = 0; i < 18; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const value = `${year}-${String(month).padStart(2, '0')}`;
        const label = `${year}年${month}月`;
        const selected = value === selectedValue ? 'selected' : '';
        options.push(`<option value="${value}" ${selected}>${label}</option>`);
      }

      return options.join('');
    }

    // ===== 請求期間のドロップダウンオプション生成 =====
    function generateBillingMonthOptions(selectedValue) {
      const today = new Date();
      const options = [];

      // 6ヶ月前から24ヶ月先まで生成
      for (let i = -6; i < 24; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const value = `${year}-${String(month).padStart(2, '0')}`;
        const label = `${year}年${month}月`;
        const selected = value === selectedValue ? 'selected' : '';
        options.push(`<option value="${value}" ${selected}>${label}</option>`);
      }

      return options.join('');
    }

    // ===== 設定画面のHTML生成 =====
    function generateSettingsContent() {
      const today = new Date();
      const invoiceDate = formatDateSlash(today);

      const dueDays = getPaymentDueDays(currentStudent);
      const dueDate = formatDateSlash(new Date(today.getTime() + dueDays * 24 * 60 * 60 * 1000));

      const invoiceNumber = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}-${currentStudent.studentId}-01`;

      const isRenewal = currentStudent.billingType === '継続';
      const defaultSubject = isRenewal
        ? `総合型選抜対策 授業料`
        : `総合型選抜対策 入塾金・授業料`;

      const paymentMonths = parseInt(currentStudent.paymentMonth) || 0;
      const monthlyLessons = parseInt(currentStudent.monthlyLessons) || 0;
      const englishLessons = parseInt(currentStudent.englishLessons) || 0;
      const englishMonths = parseInt(currentStudent.englishPayment) || 0;

      // デフォルトの購入コマ数を計算
      const defaultTotalLessons = monthlyLessons * paymentMonths;
      const defaultEnglishLessons = englishLessons * englishMonths;

      const startMonth = today.getMonth() + 1;
      const endMonth = ((startMonth + paymentMonths - 2) % 12) + 1;
      const startYear = today.getFullYear();
      const endYear = startMonth + paymentMonths - 1 > 12 ? startYear + 1 : startYear;

      // nextRenewalMonthをYYYY-MM形式に変換（YYYYMM形式の場合）
      let nextRenewalMonth = currentStudent.nextRenewalMonth || '';
      if (nextRenewalMonth && nextRenewalMonth.length === 6 && !nextRenewalMonth.includes('-')) {
        nextRenewalMonth = nextRenewalMonth.slice(0, 4) + '-' + nextRenewalMonth.slice(4);
      }

      const hasSingleParent = currentStudent.singleParent === 'はい';
      const hasReferral = currentStudent.referral === 'あり';
      const referralNameDisplay = currentStudent.referralName || '';

      // 再送信モード用の表示
      const resendModeBanner = isResendMode ? `
  <div class="resend-mode-banner">
    <i data-lucide="info" style="width:18px;height:18px;"></i>
    <span class="resend-mode-banner-text">再送信モード - 前回の請求書内容を確認・編集して再送信できます</span>
  </div>
` : '';

      const courseEditSection = isResendMode ? `
  <div class="course-edit-section">
    <div class="course-edit-title">
      <i data-lucide="edit-3" style="width:16px;height:16px;"></i>
      受講内容の修正（必要な場合のみ）
    </div>
    <div class="course-edit-grid">
      <div class="course-edit-item">
        <label class="course-edit-label">コース種別</label>
        <select class="course-edit-input" id="edit-course-type">
          <option value="海外大学" ${currentStudent.course === '海外大学' ? 'selected' : ''}>海外大学</option>
          <option value="国公立大学" ${currentStudent.course === '国公立大学' ? 'selected' : ''}>国公立大学</option>
          <option value="難関私立大学" ${currentStudent.course === '難関私立大学' ? 'selected' : ''}>難関私立大学</option>
          <option value="一般私立大学" ${currentStudent.course === '一般私立大学' ? 'selected' : ''}>一般私立大学</option>
        </select>
      </div>
      <div class="course-edit-item">
        <label class="course-edit-label">総合型 月コマ数</label>
        <input type="number" class="course-edit-input" id="edit-monthly-lessons" value="${monthlyLessons}" min="0">
      </div>
      <div class="course-edit-item">
        <label class="course-edit-label">総合型 支払月数</label>
        <input type="number" class="course-edit-input" id="edit-payment-months" value="${paymentMonths}" min="0">
      </div>
      <div class="course-edit-item">
        <label class="course-edit-label">ENGLISH 月コマ数</label>
        <input type="number" class="course-edit-input" id="edit-english-lessons" value="${englishLessons}" min="0">
      </div>
      <div class="course-edit-item">
        <label class="course-edit-label">ENGLISH 支払月数</label>
        <input type="number" class="course-edit-input" id="edit-english-months" value="${englishMonths}" min="0">
      </div>
    </div>
  </div>
` : '';

      return `
      ${resendModeBanner}
    ${courseEditSection}
    <div class="invoice-edit-panel" style="border:none;background:none;padding:0;">
      <div class="edit-panel-grid">
        <div class="edit-panel-item">
          <label class="edit-panel-label">生徒名</label>
          <input type="text" class="edit-input" id="invoice-to-name" value="${currentStudent.studentName || ''}">
        </div>
        
        <div class="edit-panel-item full-width">
          <label class="edit-panel-label">件名</label>
          <input type="text" class="edit-input" id="invoice-subject" value="${defaultSubject}">
        </div>
        
        <div class="edit-panel-item">
          <label class="edit-panel-label">請求日</label>
          <input type="text" class="edit-input" id="invoice-date" value="${invoiceDate}">
        </div>
        <div class="edit-panel-item">
          <label class="edit-panel-label">請求書番号</label>
          <input type="text" class="edit-input" id="invoice-number" value="${invoiceNumber}">
        </div>
        
        <div class="edit-panel-item">
          <label class="edit-panel-label">入金期日</label>
          <input type="text" class="edit-input" id="invoice-due-date" value="${dueDate}">
        </div>
        
        <div class="edit-panel-item">
         <label class="edit-panel-label">請求期間</label>
         <div class="period-inputs">
          <select class="edit-input" id="billing-start">
           ${generateBillingMonthOptions(`${startYear}-${String(startMonth).padStart(2, '0')}`)}
          </select>
           <span>〜</span>
          <select class="edit-input" id="billing-end">
           ${generateBillingMonthOptions(`${endYear}-${String(endMonth).padStart(2, '0')}`)}
          </select>
         </div>
       </div>
        
        <div class="edit-panel-item">
          <label class="edit-panel-label">次回更新月</label>
          <select class="edit-input" id="next-renewal">
            ${generateRenewalMonthOptions(nextRenewalMonth)}
          </select>
        </div>
        
        <!-- 購入コマ数セクション -->
        <div class="edit-panel-item full-width">
          <label class="edit-panel-label">📚 購入コマ数</label>
          <div class="lessons-input-grid">
            <div class="lessons-input-item">
              <label class="lessons-input-label">総合型選抜コース（${currentStudent.course || '未選択'}）</label>
              <div class="lessons-input-wrapper">
                <input type="number" class="edit-input lessons-input" id="purchase-total-lessons" value="${defaultTotalLessons}" min="0">
                <span class="lessons-input-unit">コマ</span>
              </div>
              <span class="lessons-input-hint">申請: ${monthlyLessons}コマ/月 × ${paymentMonths}ヶ月 = ${defaultTotalLessons}コマ</span>
            </div>
            <div class="lessons-input-item">
              <label class="lessons-input-label">ENGLISH（英語資格対策）</label>
              <div class="lessons-input-wrapper">
                <input type="number" class="edit-input lessons-input" id="purchase-english-lessons" value="${defaultEnglishLessons}" min="0">
                <span class="lessons-input-unit">コマ</span>
              </div>
              <span class="lessons-input-hint">申請: ${englishLessons}コマ/月 × ${englishMonths}ヶ月 = ${defaultEnglishLessons}コマ</span>
            </div>
          </div>
        </div>
        
        <div class="edit-panel-item discount-section full-width">
          <label class="edit-panel-label">特別割引（入塾金から-¥10,000）</label>
          <div class="discount-checkboxes">
            <label class="discount-checkbox ${isRenewal ? 'disabled' : ''}">
              <input type="checkbox" id="discount-single-parent" ${hasSingleParent && !isRenewal ? 'checked' : ''} ${isRenewal ? 'disabled' : ''}>
              <span class="checkbox-label">ひとり親割引</span>
              ${hasSingleParent ? '<span class="checkbox-hint">（申告あり）</span>' : ''}
            </label>
            <label class="discount-checkbox ${isRenewal ? 'disabled' : ''}">
              <input type="checkbox" id="discount-referral" ${hasReferral && !isRenewal ? 'checked' : ''} ${isRenewal ? 'disabled' : ''}>
              <span class="checkbox-label">紹介割引</span>
              ${hasReferral ? '<span class="checkbox-hint">（紹介者: ' + referralNameDisplay + '）</span>' : ''}
            </label>
          </div>
          ${isRenewal ? '<p class="discount-note">※継続更新のため入塾金割引は適用外</p>' : ''}
        </div>
        
        <div class="edit-panel-item full-width">
          <label class="edit-panel-label">消費税</label>
          <div class="discount-checkboxes">
            <label class="discount-checkbox tax-exempt-checkbox">
              <input type="checkbox" id="tax-exempt">
              <span class="checkbox-label">免税（海外生徒）</span>
            </label>
          </div>
        </div>
        
        <div class="edit-panel-item full-width">
          <label class="edit-panel-label">備考</label>
          <input type="text" class="edit-input" id="invoice-remarks" value="生徒番号：${currentStudent.studentId}" placeholder="備考を入力...">
        </div>
      </div>
    </div>
  `;
    }

    // ===== ウィザードUI更新 =====
    function updateWizardUI() {
      // ステップインジケーター更新
      document.querySelectorAll('.wizard-step').forEach((el, idx) => {
        const stepNum = idx + 1;
        el.classList.remove('active', 'completed');
        if (stepNum === currentWizardStep) {
          el.classList.add('active');
        } else if (stepNum < currentWizardStep) {
          el.classList.add('completed');
        }
      });

      // ステップライン更新
      document.querySelectorAll('.wizard-step-line').forEach((el, idx) => {
        el.classList.toggle('completed', idx + 1 < currentWizardStep);
      });

      // コンテンツ切り替え
      document.querySelectorAll('.wizard-content').forEach((el, idx) => {
        el.classList.toggle('active', idx + 1 === currentWizardStep);
      });

      // ボタン表示更新
      const backBtn = document.getElementById('wizard-back-btn');
      const nextBtn = document.getElementById('wizard-next-btn');
      const sendBtn = document.getElementById('wizard-send-btn');

      backBtn.style.display = currentWizardStep > 1 ? 'flex' : 'none';
      nextBtn.style.display = currentWizardStep < 3 ? 'flex' : 'none';
      sendBtn.style.display = currentWizardStep === 3 ? 'flex' : 'none';

      lucide.createIcons();
    }

    // ===== ウィザード次へ =====
    async function wizardNext() {
      const nextBtn = document.getElementById('wizard-next-btn');

      if (currentWizardStep === 1) {
        // STEP 1 → STEP 2: バリデーション
        const errors = validateStep1();
        if (errors.length > 0) {
          showValidationErrors(errors);
          return;
        }

        // ボタンをローディング状態に
        nextBtn.disabled = true;
        nextBtn.innerHTML = `
          <span class="btn-spinner"></span>
          PDFを生成中...
        `;

        // プレビュー生成
        await generateWizardPreview();

        // ボタンを元に戻す
        nextBtn.disabled = false;
        nextBtn.innerHTML = `
          次へ
          <i data-lucide="arrow-right" style="width:16px;height:16px;"></i>
        `;
        lucide.createIcons();

        if (currentPdfBase64) {
          currentWizardStep = 2;
          updateWizardUI();
        }
      } else if (currentWizardStep === 2) {
        // STEP 2 → STEP 3: メール設定
        prepareEmailStep();
        currentWizardStep = 3;
        updateWizardUI();
      }
    }

    // ===== ステップ1バリデーション =====
    function validateStep1() {
      const errors = [];

      const studentName = document.getElementById('invoice-to-name')?.value?.trim();
      if (!studentName) {
        errors.push({ field: 'invoice-to-name', message: '生徒名を入力してください' });
      }

      const invoiceDate = document.getElementById('invoice-date')?.value?.trim();
      if (!invoiceDate) {
        errors.push({ field: 'invoice-date', message: '請求日を入力してください' });
      }

      const dueDate = document.getElementById('invoice-due-date')?.value?.trim();
      if (!dueDate) {
        errors.push({ field: 'invoice-due-date', message: '入金期日を入力してください' });
      }

      const nextRenewal = document.getElementById('next-renewal')?.value?.trim();
      if (!nextRenewal) {
        errors.push({ field: 'next-renewal', message: '次回更新月を入力してください' });
      }

      return errors;
    }

    // ===== バリデーションエラー表示 =====
    function showValidationErrors(errors) {
      // 既存のエラー表示をクリア
      document.querySelectorAll('.validation-error').forEach(el => el.remove());
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

      errors.forEach(error => {
        const field = document.getElementById(error.field);
        if (field) {
          field.classList.add('input-error');

          // エラーメッセージを追加
          const errorEl = document.createElement('div');
          errorEl.className = 'validation-error';
          errorEl.innerHTML = `<i data-lucide="alert-circle" style="width:12px;height:12px;"></i> ${error.message}`;
          field.parentNode.appendChild(errorEl);
        }
      });

      lucide.createIcons();

      // 最初のエラーフィールドにスクロール
      if (errors.length > 0) {
        const firstField = document.getElementById(errors[0].field);
        if (firstField) {
          firstField.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstField.focus();
        }
      }

      showToast(`入力エラーがあります（${errors.length}件）`, 'error');
    }

    // ===== ウィザード戻る =====
    function wizardBack() {
      if (currentWizardStep > 1) {
        currentWizardStep--;
        updateWizardUI();
      }
    }

    // ===== プレビュー生成（ウィザード用） =====
    async function generateWizardPreview() {
      if (!currentStudent) return;

      const previewArea = document.getElementById('pdf-preview-area');

      previewArea.innerHTML = `
    <div class="pdf-loading">
      <div class="pdf-loading-spinner"></div>
      <p>PDFを生成中...</p>
    </div>
  `;

      try {
        const studentName = document.getElementById('invoice-to-name').value;
        const invoiceSubject = document.getElementById('invoice-subject').value;
        const invoiceDate = document.getElementById('invoice-date').value;
        const invoiceNumber = document.getElementById('invoice-number').value;
        const dueDate = document.getElementById('invoice-due-date').value;
        const remarks = document.getElementById('invoice-remarks').value;

        const singleParentDiscount = document.getElementById('discount-single-parent')?.checked || false;
        const referralDiscount = document.getElementById('discount-referral')?.checked || false;
        const isTaxExempt = document.getElementById('tax-exempt')?.checked || false;

        // カスタムコマ数を取得
        const customTotalLessons = parseInt(document.getElementById('purchase-total-lessons')?.value) || 0;
        const customEnglishLessons = parseInt(document.getElementById('purchase-english-lessons')?.value) || 0;

        const breakdown = calculateInvoiceBreakdown(currentStudent, {
          singleParentDiscount,
          referralDiscount,
          taxExempt: isTaxExempt,
          totalLessons: customTotalLessons,
          englishLessons: customEnglishLessons
        });

        const invoiceData = {
          studentId: currentStudent.studentId,
          studentName: studentName,
          invoiceDate: invoiceDate,
          invoiceNumber: invoiceNumber,
          dueDate: dueDate,
          invoiceSubject: invoiceSubject,
          subtotal: breakdown.subtotalExTax,
          tax: breakdown.tax,
          total: breakdown.total,
          items: breakdown.items,
          remarks: remarks,
          isTaxExempt: isTaxExempt,
          // カスタムコマ数も保存
          totalLessons: customTotalLessons,
          englishLessons: customEnglishLessons
        };

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'previewInvoice',
            invoiceData: invoiceData
          })
        });

        const result = await response.json();

        if (result.success) {
          const pdfDataUrl = 'data:application/pdf;base64,' + result.pdfBase64;
          previewArea.innerHTML = `
        <embed src="${pdfDataUrl}" type="application/pdf" width="100%" height="500px">
      `;

          currentPdfBase64 = result.pdfBase64;
          currentInvoiceData = invoiceData;
        } else {
          throw new Error(result.message || 'PDF生成に失敗しました');
        }

      } catch (error) {
        console.error('プレビュー生成エラー:', error);
        previewArea.innerHTML = `
      <div class="pdf-preview-placeholder" style="color:#d32f2f;">
        <i data-lucide="alert-circle" style="width:48px;height:48px;"></i>
        <p>プレビュー生成に失敗しました<br>${error.message}</p>
      </div>
    `;
        lucide.createIcons();
      }
    }

    // ===== メールステップ準備 =====
    function prepareEmailStep() {
      if (!currentStudent || !currentInvoiceData) return;

      // 料金計算（メール本文用）
      const singleParentDiscount = document.getElementById('discount-single-parent')?.checked || false;
      const referralDiscount = document.getElementById('discount-referral')?.checked || false;
      const isTaxExempt = document.getElementById('tax-exempt')?.checked || false;

      const breakdown = calculateInvoiceBreakdown(currentStudent, {
        singleParentDiscount,
        referralDiscount,
        taxExempt: isTaxExempt
      });

      const paymentMonths = parseInt(currentStudent.paymentMonth) || 0;
      const invoiceSubject = currentInvoiceData.invoiceSubject || '';

      document.getElementById('wizard-email-to').value = currentStudent.parentEmail || currentStudent.studentEmail || '';
      document.getElementById('wizard-email-subject').value = `【EQAO】ご請求書の送付（${currentStudent.studentName}様）`;
      document.getElementById('wizard-email-body').value = generateEmailBody(currentStudent, breakdown, paymentMonths, invoiceSubject);
    }


    async function wizardSend() {
      const student = currentStudent;
      const invoiceData = currentInvoiceData;
      if (!student || !invoiceData) return;

      const email = document.getElementById('wizard-email-to').value;
      const subject = document.getElementById('wizard-email-subject').value;
      const body = document.getElementById('wizard-email-body').value;

      if (!confirm(`${email} に請求書を送信しますか？`)) return;

      const billingStart = document.getElementById('billing-start')?.value || '';
      const billingEnd = document.getElementById('billing-end')?.value || '';
      const nextRenewal = document.getElementById('next-renewal')?.value || '';

      try {
        showToast('請求書を送信中...', 'info');
        closeModal();

        // 適用割引情報を作成
        const discountDetails = [];
        const singleParentDiscount = document.getElementById('discount-single-parent')?.checked;
        const referralDiscount = document.getElementById('discount-referral')?.checked;
        if (singleParentDiscount) discountDetails.push('ひとり親:-10000');
        if (referralDiscount) discountDetails.push('紹介:-10000');
        const discountDetail = discountDetails.join(', ');

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'sendInvoice',
            studentId: student.studentId,
            email: email,
            emailSubject: subject,
            emailBody: body,
            studentName: invoiceData.studentName,
            parentName: student.parentName,
            total: invoiceData.total,
            billingStart: billingStart,
            billingEnd: billingEnd,
            nextRenewalMonth: nextRenewal.replace('-', ''),
            invoiceSubject: invoiceData.invoiceSubject,
            invoiceData: invoiceData,
            billingType: student.billingType || '新規',
            totalLessons: invoiceData.totalLessons || 0,
            englishLessons: invoiceData.englishLessons || 0,
            discountDetail: discountDetail  // 追加
          })
        });

        const result = await response.json();

        if (result.success) {
          student.invoiceSent = '入金待ち';
          student.nextRenewalMonth = nextRenewal.replace('-', '');
          updateStats();
          renderList();
          showToast('請求書を送信しました', 'success');

          currentPdfBase64 = null;
          currentInvoiceData = null;
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('送信エラー:', error);
        showToast('送信に失敗しました: ' + error.message, 'error');
      }
    }

    // ===== プレビュー無効化（設定変更時） =====
    function invalidatePreview() {
      // 既にプレビューがない場合は何もしない
      if (!currentPdfBase64 && !currentInvoiceData) return;

      // プレビューデータをリセット
      currentPdfBase64 = null;
      currentInvoiceData = null;

      // ボタンを無効化
      updateActionButtons(false);

      // プレビューエリアに再生成を促すメッセージ
      const previewArea = document.getElementById('pdf-preview-area');
      if (previewArea) {
        previewArea.innerHTML = `
          <div class="pdf-preview-placeholder" style="color:#f59e0b;">
            <i data-lucide="alert-triangle" style="width:48px;height:48px;"></i>
            <p>設定が変更されました<br>「PDFプレビューを生成」を押して確認してください</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // ===== 件名フォントサイズ自動調整 =====
    function adjustSubjectFontSize() {
      const input = document.getElementById('invoice-subject');
      if (!input) return;

      const text = input.value;
      const maxWidth = 380; // 入力欄の幅

      // 文字数に応じてフォントサイズを調整
      let fontSize = 16;
      if (text.length > 20) fontSize = 14;
      if (text.length > 25) fontSize = 13;
      if (text.length > 30) fontSize = 12;
      if (text.length > 35) fontSize = 11;

      input.style.fontSize = fontSize + 'px';
    }

    // ===== 請求書再計算（現在は使用しない） =====
    function recalculateInvoice() {
      // PDFプレビュー方式に変更したため、ここでは何もしない
    }

    // ===== PDFプレビュー生成 =====
    async function generatePreview() {
      if (!currentStudent) return;

      const previewArea = document.getElementById('pdf-preview-area');

      // ローディング表示
      previewArea.innerHTML = `
        <div class="pdf-loading">
          <div class="pdf-loading-spinner"></div>
          <p>PDFを生成中...</p>
        </div>
      `;

      try {
        // フォームから値を取得
        const studentName = document.getElementById('invoice-to-name').value;
        const invoiceSubject = document.getElementById('invoice-subject').value;
        const invoiceDate = document.getElementById('invoice-date').value;
        const invoiceNumber = document.getElementById('invoice-number').value;
        const dueDate = document.getElementById('invoice-due-date').value;
        const remarks = document.getElementById('invoice-remarks').value;

        // 割引チェック状態を取得
        const singleParentDiscount = document.getElementById('discount-single-parent')?.checked || false;
        const referralDiscount = document.getElementById('discount-referral')?.checked || false;

        // 免税チェック状態を取得
        const isTaxExempt = document.getElementById('tax-exempt')?.checked || false;

        // 料金計算
        const breakdown = calculateInvoiceBreakdown(currentStudent, {
          singleParentDiscount,
          referralDiscount,
          taxExempt: isTaxExempt
        });

        // 請求書データを作成
        const invoiceData = {
          studentId: currentStudent.studentId,
          studentName: studentName,
          invoiceDate: invoiceDate,
          invoiceNumber: invoiceNumber,
          dueDate: dueDate,
          invoiceSubject: invoiceSubject,
          subtotal: breakdown.subtotalExTax,
          tax: breakdown.tax,
          total: breakdown.total,
          items: breakdown.items,
          remarks: remarks,
          isTaxExempt: isTaxExempt
        };

        // GASにリクエスト
        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'previewInvoice',
            invoiceData: invoiceData
          })
        });

        const result = await response.json();

        if (result.success) {
          // Base64からPDFを表示
          const pdfDataUrl = 'data:application/pdf;base64,' + result.pdfBase64;
          previewArea.innerHTML = `
            <embed src="${pdfDataUrl}" type="application/pdf" width="100%" height="600px">
          `;

          // 現在のPDFデータを保存（送信時に使用）
          currentPdfBase64 = result.pdfBase64;
          currentInvoiceData = invoiceData;

          // ボタンを有効化
          updateActionButtons(true);
        } else {
          throw new Error(result.message || 'PDF生成に失敗しました');
        }

      } catch (error) {
        console.error('プレビュー生成エラー:', error);
        previewArea.innerHTML = `
          <div class="pdf-preview-placeholder" style="color:#d32f2f;">
            <i data-lucide="alert-circle" style="width:48px;height:48px;"></i>
            <p>プレビュー生成に失敗しました<br>${error.message}</p>
          </div>
        `;
        lucide.createIcons();

        // ボタンを無効化
        updateActionButtons(false);
      }
    }

    // ===== アクションボタンの有効/無効切り替え =====
    function updateActionButtons(enabled) {
      const downloadBtn = document.getElementById('btn-download-pdf');
      const sendBtn = document.getElementById('btn-send-invoice');

      if (downloadBtn) downloadBtn.disabled = !enabled;
      if (sendBtn) sendBtn.disabled = !enabled;
    }

    // 現在のPDFデータを保持する変数
    let currentPdfBase64 = null;
    let currentInvoiceData = null;

    // ===== 請求書用の料金計算（税込み価格） =====
    function calculateInvoiceBreakdown(student, options = {}) {
      const items = [];
      let total = 0; // 税込み合計

      const monthlyLessons = parseInt(student.monthlyLessons) || 0;
      const paymentMonths = parseInt(student.paymentMonth) || 0;
      const englishLessonsPerMonth = parseInt(student.englishLessons) || 0;
      const englishMonths = parseInt(student.englishPayment) || 0;
      const courseType = student.course || '';
      const hasVideo = student.videoMaterial === '購入する';
      const isRenewal = student.billingType === '継続';

      // 割引オプション
      const singleParentDiscount = options.singleParentDiscount || false;
      const referralDiscount = options.referralDiscount || false;
      const taxExempt = options.taxExempt || false;

      // カスタムコマ数（指定がなければデフォルト計算）
      const customTotalLessons = options.totalLessons !== undefined ? options.totalLessons : (monthlyLessons * paymentMonths);
      const customEnglishLessons = options.englishLessons !== undefined ? options.englishLessons : (englishLessonsPerMonth * englishMonths);

      // 新規の場合は初期費用（税込み）
      if (!isRenewal) {
        // 入塾金
        items.push({ name: '入塾金', qty: 1, unit: PRICES.ENROLLMENT_FEE, amount: PRICES.ENROLLMENT_FEE });
        total += PRICES.ENROLLMENT_FEE;

        // ひとり親割引（入塾金から-10,000円）
        if (singleParentDiscount) {
          items.push({ name: 'ひとり親割引', qty: 1, unit: -10000, amount: -10000 });
          total -= 10000;
        }

        // 紹介割引（入塾金から-10,000円）
        if (referralDiscount) {
          items.push({ name: '紹介割引', qty: 1, unit: -10000, amount: -10000 });
          total -= 10000;
        }

        // 教材費
        items.push({ name: '教材費', qty: 1, unit: PRICES.MATERIAL_FEE, amount: PRICES.MATERIAL_FEE });
        total += PRICES.MATERIAL_FEE;

        // アカウント設定費
        items.push({ name: 'アカウント設定費', qty: 1, unit: PRICES.ACCOUNT_FEE, amount: PRICES.ACCOUNT_FEE });
        total += PRICES.ACCOUNT_FEE;

        // 動画教材（入塾時購入）
        if (hasVideo) {
          items.push({ name: '過去動画教材費', qty: 1, unit: PRICES.VIDEO_FEE, amount: PRICES.VIDEO_FEE });
          total += PRICES.VIDEO_FEE;
        }
      }

      // 在籍基本料（税込み）
      if (paymentMonths > 0) {
        const basicAmount = PRICES.BASIC_FEE * paymentMonths;
        items.push({ name: '在籍基本料', qty: paymentMonths, unit: PRICES.BASIC_FEE, amount: basicAmount });
        total += basicAmount;

        // システムサーバー費
        const systemAmount = PRICES.SYSTEM_FEE * paymentMonths;
        items.push({ name: 'システムサーバー費', qty: paymentMonths, unit: PRICES.SYSTEM_FEE, amount: systemAmount });
        total += systemAmount;
      }

      // 授業料（税込み）- カスタムコマ数を使用
      if (customTotalLessons > 0) {
        const coursePrice = PRICES.COURSE[courseType] || 12800;
        const lessonAmount = coursePrice * customTotalLessons;
        items.push({ name: `授業料(${courseType || 'コース'})`, qty: customTotalLessons, unit: coursePrice, amount: lessonAmount });
        total += lessonAmount;
      }

      // まとめ払い割引
      if (paymentMonths > 0 && PRICES.BULK_DISCOUNT[paymentMonths]) {
        const discountAmount = PRICES.BULK_DISCOUNT[paymentMonths];
        items.push({ name: `まとめ払い割引(${paymentMonths}ヶ月)`, qty: 1, unit: -discountAmount, amount: -discountAmount });
        total -= discountAmount;
      }

      // ENGLISH（税込み）- カスタムコマ数を使用
      if (customEnglishLessons > 0) {
        const englishAmount = PRICES.ENGLISH * customEnglishLessons;
        items.push({ name: '英語資格対策授業料', qty: customEnglishLessons, unit: PRICES.ENGLISH, amount: englishAmount });
        total += englishAmount;
      }

      // 内税計算（税込み価格から税抜・消費税を算出）
      // 免税の場合は消費税を0にする
      if (taxExempt) {
        const subtotalExTax = Math.floor(total / 1.1);  // 元の税抜価格
        return { items, total: subtotalExTax, subtotalExTax, tax: 0 };
      } else {
        const subtotalExTax = Math.floor(total / 1.1);
        const tax = total - subtotalExTax;
        return { items, total, subtotalExTax, tax };
      }
    }

    // ===== 日付フォーマット（スラッシュ区切り） =====
    function formatDateSlash(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}/${m}/${d}`;
    }

    // ===== モーダルを閉じる =====
    function closeModal() {
      document.getElementById('invoice-modal').classList.remove('show');
      currentStudent = null;
      currentWizardStep = 1;
      currentPdfBase64 = null;
      currentInvoiceData = null;
    }

    // ===== 料金表モーダル =====
    function openPriceModal() {
      document.getElementById('price-modal').classList.add('show');
      lucide.createIcons();
    }

    function closePriceModal() {
      document.getElementById('price-modal').classList.remove('show');
    }

    // ===== PDFダウンロード =====
    async function downloadPDF() {
      // プレビューが生成されていない場合
      if (!currentPdfBase64 || !currentInvoiceData) {
        showToast('先にPDFプレビューを生成してください', 'warning');
        return;
      }

      try {
        // Base64からBlobを作成
        const byteCharacters = atob(currentPdfBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });

        // ダウンロードリンクを作成
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `請求書_${currentInvoiceData.studentName}_${currentInvoiceData.invoiceNumber}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('PDFをダウンロードしました', 'success');
      } catch (error) {
        console.error('PDFダウンロードエラー:', error);
        showToast('PDFダウンロードに失敗しました', 'error');
      }
    }

    // ===== メール編集モーダルを開く =====
    function sendInvoice() {
      if (!currentStudent) return;

      // プレビューが生成されていない場合は警告
      if (!currentInvoiceData) {
        showToast('先にPDFプレビューを生成してください', 'warning');
        return;
      }

      const email = currentStudent.parentEmail || currentStudent.studentEmail;
      if (!email) {
        showToast('送信先メールアドレスがありません', 'error');
        return;
      }

      // 編集パネルから設定値を取得
      const invoiceSubject = document.getElementById('invoice-subject')?.value || '';

      // 割引適用状態
      const singleParentDiscount = document.getElementById('discount-single-parent')?.checked || false;
      const referralDiscount = document.getElementById('discount-referral')?.checked || false;

      // 料金再計算
      const breakdown = calculateInvoiceBreakdown(currentStudent, {
        singleParentDiscount,
        referralDiscount
      });

      // 支払月数を計算
      const paymentMonths = parseInt(currentStudent.paymentMonth) || 1;

      // メール本文生成
      const emailBody = generateEmailBody(currentStudent, breakdown, paymentMonths, invoiceSubject);

      // モーダルに値をセット
      document.getElementById('email-to').value = email;
      document.getElementById('email-subject').value = `【EQAO】ご請求書の送付（${currentStudent.studentName}様）`;
      document.getElementById('email-body').value = emailBody;

      // プレビュー更新
      updateEmailPreview();

      // モーダル表示
      document.getElementById('email-modal').classList.add('show');
      lucide.createIcons();
    }

    // ===== メール本文生成 =====
    function generateEmailBody(student, breakdown, paymentMonths, invoiceSubject) {
      const monthsDisplay = paymentMonths > 1 ? `（${paymentMonths}ヶ月分）` : '';

      return `${student.studentName} 様

いつもお世話になっております。
株式会社EQAO教育グループでございます。

この度は、ご入塾いただき誠にありがとうございます。
添付ファイルにて請求書をお送りいたします。

━━━━━━━━━━━━━━━━━━━━━━━━
■ ご請求内容
━━━━━━━━━━━━━━━━━━━━━━━━

生徒番号：${student.studentId}
生徒氏名：${student.studentName}
${invoiceSubject ? '件名：' + invoiceSubject + '\n' : ''}ご請求金額：¥${breakdown.total.toLocaleString()}（税込）${monthsDisplay}

━━━━━━━━━━━━━━━━━━━━━━━━
■ お支払いについて
━━━━━━━━━━━━━━━━━━━━━━━━

お支払期限：請求書発行日より2週間以内
お振込先：請求書に記載の口座へお振込ください

※ お振込の際は、生徒番号をご入力ください。
※ お振込手数料はお客様ご負担となります。

━━━━━━━━━━━━━━━━━━━━━━━━

ご不明点がございましたら、EQAO公式LINEまでお気軽にお問い合わせください。
https://lin.ee/Zu2Gb05

今後ともよろしくお願いいたします。

---
株式会社EQAO教育グループ
Email: globalsight.official@gmail.com`;
    }

    // ===== メールプレビュー更新 =====
    function updateEmailPreview() {
      const bodyText = document.getElementById('email-body').value;
      const htmlPreview = document.getElementById('email-html-preview');

      // テキストをHTMLに変換（改行を<br>に、区切り線をスタイル付きに）
      let html = bodyText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/━+/g, '<hr style="border:none;border-top:1px solid #ddd;margin:16px 0;">')
        .replace(/■\s*(.+)/g, '<strong style="color:#333;font-size:14px;">■ $1</strong>')
        .replace(/\n/g, '<br>');

      htmlPreview.innerHTML = `<div style="font-family:sans-serif;color:#333;">${html}</div>`;
    }

    // ===== メール編集/プレビュー切り替え =====
    function setEmailView(view) {
      const editBtn = document.querySelector('.toggle-btn:first-child');
      const previewBtn = document.querySelector('.toggle-btn:last-child');
      const editArea = document.getElementById('email-body-edit');
      const previewArea = document.getElementById('email-body-preview');

      if (view === 'edit') {
        editBtn.classList.add('active');
        previewBtn.classList.remove('active');
        editArea.style.display = 'block';
        previewArea.style.display = 'none';
      } else {
        editBtn.classList.remove('active');
        previewBtn.classList.add('active');
        editArea.style.display = 'none';
        previewArea.style.display = 'block';
        updateEmailPreview();
      }
    }

    // ===== メールモーダルを閉じる =====
    function closeEmailModal() {
      document.getElementById('email-modal').classList.remove('show');
    }

    // ===== メール送信確認＆実行 =====
    async function confirmSendEmail() {
      // currentStudentをローカル変数にコピー（非同期処理中にnullになるのを防ぐ）
      const student = currentStudent;
      if (!student) return;

      // プレビューデータがない場合はエラー
      if (!currentInvoiceData) {
        showToast('先にPDFプレビューを生成してください', 'error');
        return;
      }

      const email = document.getElementById('email-to').value;
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;

      if (!confirm(`${email} に請求書を送信しますか？`)) return;

      // 編集パネルから設定値を取得
      const billingStart = document.getElementById('billing-start')?.value || '';
      const billingEnd = document.getElementById('billing-end')?.value || '';
      const nextRenewal = document.getElementById('next-renewal')?.value || '';

      try {
        showToast('請求書を送信中...', 'info');
        closeEmailModal();

        // GASに送信（currentInvoiceDataを使用）
        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'sendInvoice',
            studentId: student.studentId,
            email: email,
            emailSubject: subject,
            emailBody: body,
            studentName: currentInvoiceData.studentName,
            parentName: student.parentName,
            total: currentInvoiceData.total,
            billingStart: billingStart,
            billingEnd: billingEnd,
            nextRenewalMonth: nextRenewal.replace('-', ''),
            invoiceSubject: currentInvoiceData.invoiceSubject,
            invoiceData: currentInvoiceData,
            billingType: student.billingType || '新規'
          })
        });

        const result = await response.json();

        if (result.success) {
          // ローカルデータ更新
          student.invoiceSent = '入金待ち';
          student.nextRenewalMonth = nextRenewal.replace('-', '');
          updateStats();
          renderList();
          closeModal();
          showToast('請求書を送信しました', 'success');

          // プレビューデータをクリア
          currentPdfBase64 = null;
          currentInvoiceData = null;
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('送信エラー:', error);
        showToast('送信に失敗しました: ' + error.message, 'error');
      }
    }

    // ===== 再送信モーダルを開く =====
    function openResendModal(studentId) {
      currentStudent = students.find(s => String(s.studentId) === String(studentId));
      if (!currentStudent) return;

      // メール送信モーダルを開く（プレビューなし）
      const modal = document.getElementById('email-modal');
      modal.classList.add('show');

      // 送信先メールアドレス
      document.getElementById('email-to').value = currentStudent.parentEmail || currentStudent.studentEmail || '';

      // リマインド用の件名と本文
      document.getElementById('email-subject').value = `【EQAO】ご請求書のお送り（リマインド）（${currentStudent.studentName}様）`;
      document.getElementById('email-body').value =
        `${currentStudent.parentName || currentStudent.studentName} 様

いつもお世話になっております。
株式会社EQAO教育グループでございます。

先日お送りいたしました請求書につきまして、リマインドのご連絡をさせていただきます。

ご多忙のところ恐れ入りますが、お手続きがお済みでない場合は、ご確認いただけますと幸いです。

ご不明な点がございましたら、お気軽にお問い合わせください。

何卒よろしくお願いいたします。

━━━━━━━━━━━━━━━
株式会社EQAO教育グループ
Email: contact@eqao.jp
━━━━━━━━━━━━━━━`;

      // 送信ボタンを再送信用に変更
      const sendBtn = document.querySelector('#email-modal .action-btn.send');
      if (sendBtn) {
        sendBtn.onclick = confirmResendEmail;
        sendBtn.innerHTML = '<i data-lucide="repeat" style="width:16px;height:16px;"></i> リマインド送信';
      }

      lucide.createIcons();
    }

    // ===== リマインド再送信 =====
    async function confirmResendEmail() {
      const student = currentStudent;
      if (!student) return;

      const email = document.getElementById('email-to').value;
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;

      if (!confirm(`${email} にリマインドメールを送信しますか？`)) return;

      try {
        showToast('リマインドメールを送信中...', 'info');
        closeEmailModal();

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'resendInvoice',
            studentId: student.studentId,
            email: email,
            emailSubject: subject,
            emailBody: body,
            studentName: student.studentName
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('リマインドメールを送信しました', 'success');
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('再送信エラー:', error);
        showToast('送信に失敗しました: ' + error.message, 'error');
      }
    }

    // ===== ステータスドロップダウン切り替え =====
    function toggleStatusDropdown(studentId) {
      const menu = document.getElementById(`status-menu-${studentId}`);
      // 他のドロップダウンを閉じる
      document.querySelectorAll('.status-dropdown-menu.show').forEach(el => {
        if (el.id !== `status-menu-${studentId}`) {
          el.classList.remove('show');
        }
      });
      menu.classList.toggle('show');
    }

    // ===== ステータス変更 =====
    async function changeStatus(studentId, newStatus) {
      const student = students.find(s => String(s.studentId) === String(studentId));
      if (!student) return;

      // ドロップダウンを閉じる
      document.querySelectorAll('.status-dropdown-menu.show').forEach(el => el.classList.remove('show'));

      try {
        showToast('ステータス更新中...', 'info');

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'updateStatus',
            studentId: studentId,
            status: newStatus
          })
        });

        const result = await response.json();

        if (result.success) {
          student.invoiceSent = newStatus;
          renderList();
          updateStats();
          showToast(`ステータスを「${newStatus}」に変更しました`, 'success');
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('ステータス更新エラー:', error);
        showToast('ステータス更新に失敗しました', 'error');
      }
    }

    // ===== ユーティリティ =====
    function formatDate(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate();
      return `${y}年${m}月${d}日`;
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info';
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i data-lucide="${icon}" style="width:18px;height:18px;"></i>
        ${message}
      `;
      toast.classList.add('show');
      lucide.createIcons();

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // モーダル外クリックで閉じる
    document.getElementById('invoice-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeModal();
      }
    });

    document.getElementById('price-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closePriceModal();
      }
    });

    document.getElementById('email-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeEmailModal();
      }
    });

    // ドキュメントクリックでステータスドロップダウンを閉じる
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.status-dropdown')) {
        document.querySelectorAll('.status-dropdown-menu.show').forEach(el => el.classList.remove('show'));
      }
    });

    // ===== 請求書詳細表示 =====
    function openInvoiceDetail(studentId) {
      const student = students.find(s => String(s.studentId) === String(studentId));
      if (!student) return;

      // 請求書履歴から最新の請求書情報を取得
      const studentHistory = invoiceHistoryData.filter(h => String(h['生徒番号']) === String(studentId));
      const latestInvoice = studentHistory.sort((a, b) => new Date(b['発行日']) - new Date(a['発行日']))[0];

      const billedAmount = parseInt(student.billedAmount) || parseInt(student.total) || 0;
      const discountDetail = student.discountDetail || '';
      const invoiceNumber = student.latestInvoiceNumber || latestInvoice?.['請求書番号'] || '-';

      const modalHtml = `
        <div class="modal-overlay show" id="invoice-detail-modal" onclick="if(event.target===this)closeInvoiceDetail()">
          <div class="modal" style="max-width:500px;">
            <div class="modal-header">
              <div class="modal-title">
                <i data-lucide="file-text" style="width:20px;height:20px;"></i>
                請求書詳細
              </div>
              <button class="modal-close" onclick="closeInvoiceDetail()">
                <i data-lucide="x" style="width:20px;height:20px;"></i>
              </button>
            </div>
            <div class="modal-body" style="padding:24px;">
              <div class="detail-section" style="margin-bottom:16px;">
                <div class="detail-section-title">
                  <i data-lucide="user" style="width:14px;height:14px;"></i>
                  基本情報
                </div>
                <div class="detail-item">
                  <span class="detail-label">生徒名</span>
                  <span class="detail-value">${student.studentName || '-'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">請求書番号</span>
                  <span class="detail-value">${invoiceNumber}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">ステータス</span>
                  <span class="detail-value">${student.invoiceSent || '-'}</span>
                </div>
              </div>
              
              <div class="detail-section" style="margin-bottom:16px;">
                <div class="detail-section-title">
                  <i data-lucide="calculator" style="width:14px;height:14px;"></i>
                  金額情報
                </div>
                <div class="detail-item">
                  <span class="detail-label">SS記録額（割引前）</span>
                  <span class="detail-value">¥${(parseInt(student.total) || 0).toLocaleString()}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">実際の請求金額</span>
                  <span class="detail-value price">¥${billedAmount.toLocaleString()}</span>
                </div>
                ${discountDetail ? `
                <div class="detail-item">
                  <span class="detail-label">適用割引</span>
                  <span class="detail-value discount">${discountDetail}</span>
                </div>
                ` : ''}
              </div>
              
              ${latestInvoice ? `
              <div class="detail-section">
                <div class="detail-section-title">
                  <i data-lucide="calendar" style="width:14px;height:14px;"></i>
                  請求期間
                </div>
                <div class="detail-item">
  <span class="detail-label">期間</span>
  <span class="detail-value">${formatBillingPeriod(latestInvoice['請求期間開始'])} 〜 ${formatBillingPeriod(latestInvoice['請求期間終了'])}</span>
</div>
                <div class="detail-item">
                  <span class="detail-label">総合型コマ数</span>
                  <span class="detail-value">${latestInvoice['総合型コマ数'] || 0}コマ</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">ENGLISHコマ数</span>
                  <span class="detail-value">${latestInvoice['ENGLISHコマ数'] || 0}コマ</span>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      lucide.createIcons();
    }

    function closeInvoiceDetail() {
      const modal = document.getElementById('invoice-detail-modal');
      if (modal) modal.remove();
    }

    // ===== 着金確認メールモーダルを開く =====
    function openPaymentConfirmModal(studentId) {
      const student = students.find(s => String(s.studentId) === String(studentId));
      if (!student) return;

      // 次回更新月をフォーマット
      let nextRenewalDisplay = '次回更新時';
      if (student.nextRenewalMonth) {
        const monthStr = String(student.nextRenewalMonth);
        if (monthStr.length === 6) {
          // YYYYMM形式
          const year = monthStr.slice(0, 4);
          const month = parseInt(monthStr.slice(4));
          nextRenewalDisplay = `${year}年${month}月`;
        } else if (monthStr.includes('-')) {
          // YYYY-MM形式
          const [year, month] = monthStr.split('-');
          nextRenewalDisplay = `${year}年${parseInt(month)}月`;
        }
      }

      const email = student.parentEmail || student.studentEmail || '';
      const subject = `【EQAO】ご入金確認のお知らせ（${student.studentName}様）`;
      const body = `${student.studentName} 様

平素より大変お世話になっております。
株式会社EQAO教育グループでございます。

この度は、ご入金をいただき誠にありがとうございます。
お客様からのご入金を無事に確認いたしましたので、ご連絡申し上げます。

━━━━━━━━━━━━━━━━━━━━━━━━
■ 次回ご請求について
━━━━━━━━━━━━━━━━━━━━━━━━

次回のご請求は、${nextRenewalDisplay}頃にご案内させていただく予定です。

請求月数の変更をご希望の場合は、
EQAO公式LINEよりお気軽にお知らせください。

▼ EQAO公式LINE
https://lin.ee/Zu2Gb05

━━━━━━━━━━━━━━━━━━━━━━━━

今後ともどうぞよろしくお願いいたします。

---
株式会社EQAO教育グループ
経理担当
Email: globalsight.official@gmail.com`;

      // モーダルに値をセット
      document.getElementById('email-to').value = email;
      document.getElementById('email-subject').value = subject;
      document.getElementById('email-body').value = body;

      // プレビュー更新
      updateEmailPreview();

      // 送信ボタンを着金確認用に変更
      const sendBtn = document.querySelector('#email-modal .action-btn.send');
      if (sendBtn) {
        sendBtn.onclick = () => sendPaymentConfirmEmail(studentId);
        sendBtn.innerHTML = '<i data-lucide="mail-check" style="width:16px;height:16px;"></i> 着金確認を送信';
      }

      // 添付ファイル表示を非表示に
      const attachmentEl = document.querySelector('#email-modal .email-attachment');
      if (attachmentEl) {
        attachmentEl.style.display = 'none';
      }

      // モーダル表示
      document.getElementById('email-modal').classList.add('show');
      lucide.createIcons();
    }

    // ===== 着金確認メール送信 =====
    async function sendPaymentConfirmEmail(studentId) {
      const student = students.find(s => String(s.studentId) === String(studentId));
      if (!student) return;

      const email = document.getElementById('email-to').value;
      const subject = document.getElementById('email-subject').value;
      const body = document.getElementById('email-body').value;

      if (!email) {
        showToast('送信先メールアドレスがありません', 'error');
        return;
      }

      if (!confirm(`${email} に着金確認メールを送信しますか？`)) return;

      try {
        showToast('メールを送信中...', 'info');
        closeEmailModal();

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'sendPaymentConfirm',
            studentId: student.studentId,
            email: email,
            emailSubject: subject,
            emailBody: body,
            studentName: student.studentName
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('着金確認メールを送信しました', 'success');
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('送信エラー:', error);
        showToast('送信に失敗しました: ' + error.message, 'error');
      }
    }

    function closeEmailModal() {
      document.getElementById('email-modal').classList.remove('show');

      // 添付ファイル表示をリセット（次回開いた時のため）
      const attachmentEl = document.querySelector('#email-modal .email-attachment');
      if (attachmentEl) {
        attachmentEl.style.display = 'flex';
      }
    }

    // ===== モーダルを閉じる =====
    function closeRenewalNoticeModal() {
      const modal = document.getElementById('renewal-notice-modal');
      if (modal) modal.remove();
    }

    // ===== 全選択/解除 =====
    function toggleRenewalSelectAll() {
      const selectAll = document.getElementById('renewal-select-all').checked;
      document.querySelectorAll('.renewal-target-checkbox').forEach(cb => {
        cb.checked = selectAll;
      });
      updateRenewalSendButton();
    }

    // ===== 送信ボタンの状態更新 =====
    function updateRenewalSendButton() {
      const checked = document.querySelectorAll('.renewal-target-checkbox:checked').length;
      const sendBtn = document.getElementById('renewal-send-btn');
      sendBtn.disabled = checked === 0;
      sendBtn.innerHTML = `<i data-lucide="send" style="width:16px;height:16px;"></i> 送信する（${checked}名）`;
      lucide.createIcons();
    }

    // チェックボックス変更時にボタン更新（イベント委譲）
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('renewal-target-checkbox')) {
        updateRenewalSendButton();
        // 全選択チェックボックスの状態も更新
        const total = document.querySelectorAll('.renewal-target-checkbox').length;
        const checked = document.querySelectorAll('.renewal-target-checkbox:checked').length;
        const selectAllCb = document.getElementById('renewal-select-all');
        if (selectAllCb) selectAllCb.checked = total > 0 && total === checked;
      }
    });

    // ===== 更新案内バッジの更新 =====
    function updateRenewalCardCounts() {
      const now = new Date();
      const currentMonthKey = now.getFullYear() * 100 + (now.getMonth() + 1);

      // 着金済の生徒のみ対象
      const paidStudents = students.filter(s => s.invoiceSent === '着金済');

      // 12ヶ月分を生成
      const items = [];
      for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthKey = year * 100 + month;
        const monthKeyStr = `${year}${String(month).padStart(2, '0')}`;

        // この月の更新予定人数
        const count = paidStudents.filter(s => {
          const renewalMonth = parseInt(String(s.nextRenewalMonth || '').replace('-', ''));
          return renewalMonth === monthKey;
        }).length;

        const isCurrent = monthKey === currentMonthKey;
        const hasStudents = count > 0;
        const countDisplay = count > 0 ? `${count}名` : '-';

        // 区切り線（最初以外）
        if (i > 0) {
          items.push('<span class="renewal-month-separator">|</span>');
        }

        items.push(`
  <span class="renewal-month-item ${hasStudents ? 'has-students' : ''} ${isCurrent ? 'current' : ''}" 
        onclick="openRenewalNoticeModal(); setTimeout(() => selectRenewalMonth('${monthKeyStr}'), 100);">
    ${month}月 : ${countDisplay}
  </span>
`);
      }

      const badgesContainer = document.getElementById('renewal-action-badges');
      if (badgesContainer) {
        badgesContainer.innerHTML = items.join('');
      }

      // 旧IDの互換性維持
      const thisMonthEl = document.getElementById('renewal-this-month');
      const nextMonthEl = document.getElementById('renewal-next-month');
      if (thisMonthEl) {
        const thisMonthCount = paidStudents.filter(s => {
          const renewalMonth = parseInt(String(s.nextRenewalMonth || '').replace('-', ''));
          return renewalMonth === currentMonthKey;
        }).length;
        thisMonthEl.textContent = thisMonthCount;
      }
      if (nextMonthEl) {
        const nextMonthKey = now.getMonth() === 11
          ? (now.getFullYear() + 1) * 100 + 1
          : now.getFullYear() * 100 + (now.getMonth() + 2);
        const nextMonthCount = paidStudents.filter(s => {
          const renewalMonth = parseInt(String(s.nextRenewalMonth || '').replace('-', ''));
          return renewalMonth === nextMonthKey;
        }).length;
        nextMonthEl.textContent = nextMonthCount;
      }
    }
    // ===== 更新案内モーダルを開く =====
    function openRenewalNoticeModal() {
      const renewalMap = {};
      const today = new Date();

      for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const key = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}`;
        renewalMap[key] = {
          year: date.getFullYear(),
          month: date.getMonth() + 1,
          students: []
        };
      }

      students.forEach(s => {
        if (s.invoiceSent !== '着金済') return;
        const renewalMonth = String(s.nextRenewalMonth || '').replace('-', '');
        if (renewalMonth && renewalMap[renewalMonth]) {
          renewalMap[renewalMonth].students.push(s);
        }
      });

      const monthCards = Object.entries(renewalMap).map(([key, data]) => {
        const count = data.students.length;
        const isCurrentMonth = key === `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}`;

        return `
      <div class="renewal-month-card ${count > 0 ? 'has-students' : ''} ${isCurrentMonth ? 'current' : ''}" 
           data-month="${key}" onclick="selectRenewalMonth('${key}')">
        <div class="renewal-month-label">${data.month}月</div>
        <div class="renewal-month-count">${count}</div>
        <div class="renewal-month-year">${data.year}</div>
      </div>
    `;
      }).join('');

      const modalHtml = `
    <div class="modal-overlay show" id="renewal-notice-modal" onclick="if(event.target===this)closeRenewalNoticeModal()">
      <div class="modal" style="max-width:800px;">
        <div class="modal-header">
          <div class="modal-title">
            <i data-lucide="calendar-clock" style="width:20px;height:20px;"></i>
            更新案内送信
          </div>
          <button class="modal-close" onclick="closeRenewalNoticeModal()">
            <i data-lucide="x" style="width:20px;height:20px;"></i>
          </button>
        </div>
        <div class="modal-body" style="padding:20px;">
          
          <div class="renewal-calendar-section">
            <div class="renewal-calendar-title">
              <i data-lucide="calendar" style="width:16px;height:16px;"></i>
              更新予定一覧（着金済の生徒）
            </div>
            <div class="renewal-month-grid">
              ${monthCards}
            </div>
          </div>
          
          <div class="edit-panel-item" style="margin-bottom:20px;">
            <label class="edit-panel-label" style="display:flex;align-items:center;gap:12px;">
              <span id="renewal-target-label">対象月を選択してください</span>
              <label style="font-weight:normal;font-size:12px;display:flex;align-items:center;gap:4px;cursor:pointer;">
                <input type="checkbox" id="renewal-select-all" onchange="toggleRenewalSelectAll()">
                全選択
              </label>
            </label>
            <div id="renewal-target-list" style="max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:8px;">
              <div style="color:#999;text-align:center;padding:20px;">上のカレンダーから月を選択してください</div>
            </div>
          </div>

          <div class="edit-panel-item" style="margin-bottom:20px;">
            <label class="edit-panel-label">件名</label>
            <input type="text" class="edit-input" id="renewal-email-subject" value="【EQAO】次回ご請求のご案内">
          </div>

          <div class="edit-panel-item">
            <label class="edit-panel-label">本文テンプレート</label>
            <textarea class="email-textarea" id="renewal-email-body" rows="10" style="min-height:180px;">保護者様

平素より大変お世話になっております。
株式会社EQAO教育グループでございます。

次回のご請求時期が近づいてまいりましたので、ご案内申し上げます。

━━━━━━━━━━━━━━━━━━━━━━━━
■ 次回ご請求について
━━━━━━━━━━━━━━━━━━━━━━━━

次回のご請求は、来月中旬頃にご案内させていただく予定です。

請求月数の変更をご希望の場合は、
EQAO公式LINEよりお気軽にお知らせください。

▼ EQAO公式LINE
https://lin.ee/Zu2Gb05

━━━━━━━━━━━━━━━━━━━━━━━━

ご不明点がございましたら、お気軽にお問い合わせください。
今後ともどうぞよろしくお願いいたします。

---
株式会社EQAO教育グループ
経理担当
Email: globalsight.official@gmail.com</textarea>
            <p style="font-size:11px;color:#888;margin-top:8px;">
              ※本文先頭に「{生徒名} 様」が自動で追加されます
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn secondary" onclick="closeRenewalNoticeModal()">キャンセル</button>
          <button class="action-btn send" id="renewal-send-btn" onclick="sendRenewalNotices()" disabled>
            <i data-lucide="send" style="width:16px;height:16px;"></i>
            送信する（0名）
          </button>
        </div>
      </div>
    </div>
  `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
      lucide.createIcons();

      const currentMonthKey = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}`;
      selectRenewalMonth(currentMonthKey);
    }

    // ===== 月を選択 =====
    function selectRenewalMonth(monthKey) {
      document.querySelectorAll('.renewal-month-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.month === monthKey);
      });

      const targets = students.filter(s => {
        const renewalMonth = String(s.nextRenewalMonth || '').replace('-', '');
        return renewalMonth === monthKey && s.invoiceSent === '着金済';
      });

      const year = monthKey.slice(0, 4);
      const month = parseInt(monthKey.slice(4));

      const labelEl = document.getElementById('renewal-target-label');
      labelEl.innerHTML = `対象者一覧（${year}年${month}月更新: <strong>${targets.length}名</strong>）`;

      const listEl = document.getElementById('renewal-target-list');

      if (targets.length === 0) {
        listEl.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">この月に更新予定の生徒はいません</div>';
        updateRenewalSendButton();
        return;
      }

      listEl.innerHTML = targets.map(s => `
    <label style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #eee;cursor:pointer;">
      <input type="checkbox" class="renewal-target-checkbox" value="${s.studentId}" data-email="${s.parentEmail || s.studentEmail || ''}" data-name="${s.studentName || ''}">
      <span style="flex:1;">
        <strong>${s.studentName || '名前なし'}</strong>
        <span style="color:#888;font-size:12px;margin-left:8px;">#${s.studentId}</span>
      </span>
      <span style="font-size:12px;color:#666;">${s.parentEmail || s.studentEmail || 'メールなし'}</span>
    </label>
  `).join('');

      const selectAllCb = document.getElementById('renewal-select-all');
      if (selectAllCb) selectAllCb.checked = false;

      updateRenewalSendButton();
    }

    // ===== 更新案内を送信 =====
    async function sendRenewalNotices() {
      const checkedBoxes = document.querySelectorAll('.renewal-target-checkbox:checked');
      if (checkedBoxes.length === 0) return;

      const subject = document.getElementById('renewal-email-subject').value;
      const bodyTemplate = document.getElementById('renewal-email-body').value;

      const targets = [];
      checkedBoxes.forEach(cb => {
        targets.push({
          studentId: cb.value,
          email: cb.dataset.email,
          name: cb.dataset.name
        });
      });

      const noEmail = targets.filter(t => !t.email);
      if (noEmail.length > 0) {
        alert(`メールアドレスがない生徒が${noEmail.length}名います:\n${noEmail.map(t => t.name).join(', ')}`);
        return;
      }

      if (!confirm(`${targets.length}名に更新案内を送信します。よろしいですか？`)) return;

      try {
        showToast(`更新案内を送信中...`, 'info');
        closeRenewalNoticeModal();

        const response = await fetch(GAS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'sendRenewalNotices',
            subject: subject,
            bodyTemplate: bodyTemplate,
            targets: targets
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast(`更新案内を${result.sentCount}名に送信しました`, 'success');
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('送信エラー:', error);
        showToast('送信に失敗しました: ' + error.message, 'error');
      }
    }

  </script>
</body>

</html>