<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>授業ダッシュボード | EQAO スタッフポータル</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f5f6fa;
      min-height: 100vh;
      color: #333;
    }

    /* ヘッダー */
    .header {
      background: #134e4a;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #aaa;
      text-decoration: none;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .header-divider {
      width: 1px;
      height: 24px;
      background: #444;
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title i {
      color: #5eead4;
    }

    /* メイン */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* 生徒選択エリア */
    .student-selector {
      background: #fff;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .selector-label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .student-select {
      flex: 1;
      min-width: 200px;
      max-width: 350px;
      padding: 12px 16px;
      border: 2px solid #e5e5e5;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .student-select:hover {
      border-color: #115e59;
    }

    .student-select:focus {
      outline: none;
      border-color: #115e59;
      box-shadow: 0 0 0 3px rgba(17, 94, 89, 0.15);
    }

    .load-btn {
      padding: 12px 24px;
      background: #115e59;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .load-btn:hover {
      background: #134e4a;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(17, 94, 89, 0.3);
    }

    .load-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* 生徒情報カード */
    .student-info-card {
      background: linear-gradient(135deg, #134e4a 0%, #115e59 100%);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
      color: #fff;
      display: none;
    }

    .student-info-card.show {
      display: block;
    }

    .student-info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .student-info-main {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .student-avatar {
      width: 56px;
      height: 56px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .student-name-area h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .student-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      opacity: 0.9;
    }

    .student-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .student-stats {
      display: flex;
      gap: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
    }

    .stat-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
    }

    .student-school {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      font-size: 14px;
    }

    .student-school-label {
      opacity: 0.8;
      margin-right: 8px;
    }

    /* タブナビゲーション */
    .tab-nav {
      background: #fff;
      border-radius: 16px;
      padding: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      gap: 4px;
      overflow-x: auto;
    }

    .tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: all 0.2s;
      font-family: inherit;
    }

    .tab-btn:hover {
      background: #f5f5f5;
      color: #333;
    }

    .tab-btn.active {
      background: #115e59;
      color: #fff;
    }

    .tab-btn i {
      flex-shrink: 0;
    }

    /* タブコンテンツ */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* 共通カードスタイル */
    .content-card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #111;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: #0d9488;
    }

    /* 空状態 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state i {
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* プレースホルダー */
    .placeholder-message {
      text-align: center;
      padding: 80px 20px;
      color: #888;
    }

    .placeholder-message i {
      margin-bottom: 16px;
      color: #ddd;
    }

    .placeholder-message h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #666;
    }

    .placeholder-message p {
      font-size: 14px;
    }

    /* ========================================
       スケジュールタブ
       ======================================== */
    .schedule-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .grade-selector {
      display: flex;
      gap: 6px;
    }

    .grade-btn {
      padding: 8px 16px;
      border: 2px solid #e5e5e5;
      background: #fff;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .grade-btn:hover {
      border-color: #115e59;
      color: #115e59;
    }

    .grade-btn.active {
      background: #115e59;
      border-color: #115e59;
      color: #fff;
    }

    .month-select {
      padding: 8px 32px 8px 12px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      background: #fff;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      font-family: inherit;
    }

    .month-select:hover {
      border-color: #115e59;
    }

    .refresh-btn {
      padding: 8px 12px;
      background: #f5f5f5;
      border: none;
      border-radius: 8px;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .refresh-btn:hover {
      background: #e5e5e5;
      color: #333;
    }

    .refresh-btn.loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 2カラムレイアウト */
    .schedule-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .schedule-split {
        grid-template-columns: 1fr;
      }
    }

    .schedule-panel {
      background: #fafafa;
      border-radius: 12px;
      overflow: hidden;
    }

    .panel-header {
      background: linear-gradient(135deg, #00897B 0%, #26A69A 100%);
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-header.purple {
      background: linear-gradient(135deg, #7B1FA2 0%, #9C27B0 100%);
    }

    .panel-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-left: 8px;
    }

    .panel-actions {
      display: flex;
      gap: 8px;
    }

    .panel-btn {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
      font-family: inherit;
    }

    .panel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .panel-content {
      padding: 16px;
      min-height: 200px;
    }

    /* 目標テキスト */
    .goals-text {
      font-size: 14px;
      color: #333;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    .goals-empty {
      text-align: center;
      padding: 40px 20px;
      color: #aaa;
    }

    .goals-empty i {
      margin-bottom: 8px;
      opacity: 0.5;
    }

    /* 目標編集 */
    .goals-textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.8;
      resize: vertical;
    }

    .goals-textarea:focus {
      outline: none;
      border-color: #00897B;
    }

    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    .btn-save {
      padding: 10px 20px;
      background: #115e59;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }

    .btn-save:hover {
      background: #134e4a;
      box-shadow: 0 4px 12px rgba(17, 94, 89, 0.3);
    }

    .btn-cancel {
      padding: 10px 20px;
      background: #e5e5e5;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-cancel:hover {
      background: #d5d5d5;
    }

    /* 講師指示 */
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .note-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: #fff;
      border-radius: 10px;
      border-left: 3px solid #9C27B0;
    }

    .note-item.completed {
      opacity: 0.6;
    }

    .note-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #9C27B0;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .note-checkbox:hover {
      background: #f3e5f5;
    }

    .note-checkbox.checked {
      background: #9C27B0;
      border-color: #9C27B0;
    }

    .note-checkbox.checked i {
      color: #fff;
    }

    .note-checkbox i {
      display: none;
    }

    .note-checkbox.checked i {
      display: block;
    }

    .note-content {
      flex: 1;
      min-width: 0;
    }

    .note-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
    }

    .note-item.completed .note-text {
      text-decoration: line-through;
      color: #999;
    }

    .note-deadline {
      font-size: 12px;
      color: #9C27B0;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .note-actions {
      display: flex;
      gap: 4px;
    }

    .note-action-btn {
      padding: 6px;
      background: none;
      border: none;
      color: #bbb;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .note-action-btn:hover {
      background: #f0f0f0;
      color: #666;
    }

    .note-action-btn.delete:hover {
      background: #ffebee;
      color: #e53935;
    }

    .notes-empty {
      text-align: center;
      padding: 40px 20px;
      color: #ce93d8;
    }

    .notes-empty i {
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .add-note-btn {
      width: 100%;
      padding: 12px;
      background: #f3e5f5;
      border: 2px dashed #ce93d8;
      border-radius: 10px;
      color: #9C27B0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 12px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .add-note-btn:hover {
      background: #e1bee7;
      border-color: #9C27B0;
    }

    /* モーダル */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      background: linear-gradient(135deg, #7B1FA2 0%, #9C27B0 100%);
      color: #fff;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #9C27B0;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .modal-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .modal-btn.cancel {
      background: #e5e5e5;
      color: #666;
    }

    .modal-btn.cancel:hover {
      background: #d5d5d5;
    }

    .modal-btn.save {
      background: linear-gradient(135deg, #7B1FA2 0%, #9C27B0 100%);
      color: #fff;
    }

    .modal-btn.save:hover {
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }

    /* ========================================
       進捗タブ
       ======================================== */
    .progress-summary {
      margin-bottom: 24px;
    }

    .progress-bar-container {
      background: #e5e5e5;
      border-radius: 10px;
      height: 24px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #115e59 0%, #0d9488 100%);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .progress-percent {
      font-size: 28px;
      font-weight: 700;
      color: #115e59;
    }

    .progress-detail {
      display: flex;
      gap: 20px;
    }

    .progress-grade-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .progress-grade-label {
      font-weight: 600;
      color: #666;
    }

    .progress-grade-count {
      color: #0d9488;
      font-weight: 600;
    }

    .checklist-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checklist-tab {
      padding: 8px 16px;
      border: 2px solid #e5e5e5;
      background: #fff;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .checklist-tab:hover {
      border-color: #115e59;
      color: #115e59;
    }

    .checklist-tab.active {
      background: #115e59;
      border-color: #115e59;
      color: #fff;
    }

    .checklist-items {
      max-height: 500px;
      overflow-y: auto;
    }

    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .checklist-item:hover {
      background: #f5f5f5;
    }

    .checklist-item.checked {
      background: #f0fdfa;
    }

    .checklist-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #d5d5d5;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .checklist-item.checked .checklist-checkbox {
      background: #0d9488;
      border-color: #0d9488;
    }

    .checklist-checkbox i {
      color: #fff;
      opacity: 0;
    }

    .checklist-item.checked .checklist-checkbox i {
      opacity: 1;
    }

    .checklist-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
    }

    .checklist-number {
      font-weight: 600;
      color: #0d9488;
      margin-right: 6px;
    }

    /* ========================================
       志望校タブ
       ======================================== */
    .pattern-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .pattern-tab {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid #e5e5e5;
      background: #fff;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pattern-tab:hover {
      border-color: #115e59;
    }

    .pattern-tab.active {
      border-color: #115e59;
      background: #115e59;
      color: #fff;
    }

    .pattern-letter {
      font-size: 16px;
      font-weight: 700;
    }

    .pattern-icons {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 4px;
      font-size: 12px;
    }

    .pattern-icons .check {
      color: #4caf50;
    }

    .pattern-icons .cross {
      color: #ef5350;
    }

    .pattern-tab.active .pattern-icons .check {
      color: #a5d6a7;
    }

    .pattern-tab.active .pattern-icons .cross {
      color: #ffcdd2;
    }

    .pattern-description {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .school-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .school-item {
      background: #fafafa;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e5e5e5;
    }

    .school-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .school-rank {
      font-size: 12px;
      font-weight: 600;
      color: #115e59;
      background: #f0fdfa;
      padding: 4px 10px;
      border-radius: 12px;
    }

    .school-badges {
      display: flex;
      gap: 6px;
    }

    .school-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
    }

    .school-badge.sengan {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .school-badge.heigan {
      background: #fff3e0;
      color: #e65100;
    }

    .school-name {
      font-size: 16px;
      font-weight: 700;
      color: #111;
    }

    .school-faculty {
      font-size: 13px;
      color: #666;
      margin-top: 2px;
    }

    .school-info-row {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 13px;
    }

    .school-info-item {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #888;
    }

    .school-info-item span {
      color: #333;
      font-weight: 500;
    }

    .schools-empty {
      text-align: center;
      padding: 60px 20px;
      color: #aaa;
    }

    .schools-empty i {
      margin-bottom: 12px;
      opacity: 0.4;
    }

    /* ========================================
       授業履歴タブ
       ======================================== */
    .lesson-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lesson-item {
      background: #fafafa;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e5e5e5;
    }

    .lesson-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .lesson-date {
      font-size: 15px;
      font-weight: 700;
      color: #111;
    }

    .lesson-type {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
    }

    .lesson-type.english {
      background: #fce4ec;
      color: #880e4f;
    }

    .lesson-type.essay {
      background: #fff3e0;
      color: #e65100;
    }

    .lesson-type.interview {
      background: #e8f5e9;
      color: #1b5e20;
    }

    .lesson-teacher {
      font-size: 13px;
      color: #666;
      margin-left: auto;
    }

    .lesson-section {
      margin-top: 12px;
    }

    .lesson-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #0d9488;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .lesson-section-content {
      font-size: 14px;
      color: #444;
      line-height: 1.6;
      padding-left: 20px;
    }

    /* ========================================
       書類タブ
       ======================================== */
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .document-item {
      background: #fafafa;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .document-item:hover {
      border-color: #0d9488;
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.15);
    }

    .document-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      background: #f0fdfa;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0d9488;
    }

    .document-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .document-date {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    /* ========================================
       報告作成タブ
       ======================================== */
    .report-form {
      max-width: 700px;
    }

    .report-section {
      margin-bottom: 24px;
    }

    .report-section-title {
      font-size: 14px;
      font-weight: 700;
      color: #0d9488;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0fdfa;
    }

    .report-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .report-row {
        grid-template-columns: 1fr;
      }
    }

    .report-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .report-group.full {
      grid-column: span 2;
    }

    @media (max-width: 600px) {
      .report-group.full {
        grid-column: span 1;
      }
    }

    .report-label {
      font-size: 13px;
      font-weight: 600;
      color: #666;
    }

    .report-input,
    .report-select,
    .report-textarea {
      padding: 12px;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .report-input:focus,
    .report-select:focus,
    .report-textarea:focus {
      outline: none;
      border-color: #0d9488;
    }

    .report-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .report-submit {
      padding: 14px 32px;
      background: #115e59;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }

    .report-submit:hover {
      background: #134e4a;
      box-shadow: 0 4px 16px rgba(17, 94, 89, 0.3);
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e5e5;
      border-top-color: #0d9488;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      .main {
        padding: 16px;
      }

      .student-selector {
        flex-direction: column;
        align-items: stretch;
      }

      .student-select {
        max-width: none;
      }

      .student-info-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .student-stats {
        width: 100%;
        justify-content: space-around;
      }

      .tab-nav {
        padding: 6px;
      }

      .tab-btn {
        padding: 10px 14px;
        font-size: 13px;
      }

      .tab-btn span {
        display: none;
      }
    }

    /* 授業履歴追加スタイル */
    .lesson-item {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
      transition: all 0.2s;
    }

    .lesson-item:hover {
      border-color: #0d9488;
    }

    .lesson-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      gap: 14px;
      margin-bottom: 0;
      background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
      transition: all 0.2s;
    }

    .lesson-header:hover {
      background: linear-gradient(135deg, #f0fdfa 0%, #e6faf7 100%);
    }

    .lesson-item.open .lesson-header {
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
    }

    .lesson-toggle {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: #fff;
      color: #0d9488;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .lesson-item.open .lesson-toggle {
      transform: rotate(180deg);
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      box-shadow: none;
    }

    .lesson-date-wrapper {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .lesson-date {
      font-size: 15px;
      font-weight: 700;
      color: #111;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lesson-item.open .lesson-date {
      color: #fff;
    }

    .lesson-weekday {
      font-size: 12px;
      color: #888;
      font-weight: 500;
    }

    .lesson-item.open .lesson-weekday {
      color: rgba(255, 255, 255, 0.8);
    }

    .lesson-teacher {
      font-size: 13px;
      color: #0d9488;
      margin-left: auto;
      background: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lesson-item.open .lesson-teacher {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      box-shadow: none;
    }

    .lesson-count {
      font-size: 11px;
      color: #fff;
      background: #0d9488;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .lesson-item.open .lesson-count {
      background: rgba(255, 255, 255, 0.3);
    }

    .lesson-body {
      display: none;
      padding: 0 16px 16px;
      border-top: 1px solid #f0f0f0;
    }

    .lesson-item.open .lesson-body {
      display: block;
    }

    .lesson-section {
      padding: 12px 0;
      border-bottom: 1px dashed #eee;
    }

    .lesson-section:last-child {
      border-bottom: none;
    }

    .lesson-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #0d9488;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lesson-section-content {
      font-size: 14px;
      color: #333;
      line-height: 1.7;
      padding-left: 0;
    }

    .lesson-section-content.steps {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-left: 0;
    }

    .step-tag {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, #f0fdfa 0%, #e0f7f4 100%);
      color: #0d9488;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #ccfbf1;
    }

    .load-more-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed #e5e5e5;
      background: #fff;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      font-family: inherit;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }

    .load-more-btn:hover {
      border-color: #0d9488;
      color: #0d9488;
    }

    .lesson-section-content.steps {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding-left: 20px;
    }

    .step-tag {
      display: inline-block;
      padding: 4px 10px;
      background: #f0fdfa;
      color: #0d9488;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    /* ========================================
   志望校タブ（新UI）
   ======================================== */
    .school-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e5e5;
      margin-bottom: 16px;
    }

    .school-card:last-child {
      margin-bottom: 0;
    }

    .school-header {
      padding: 20px;
      background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
      border-bottom: 1px solid #eee;
    }

    .school-header-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .school-rank {
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
      padding: 6px 14px;
      border-radius: 20px;
    }

    .school-badges {
      display: flex;
      gap: 8px;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .school-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
    }

    .school-badge.sengan {
      background: #dcfce7;
      color: #166534;
    }

    .school-badge.heigan {
      background: #fef3c7;
      color: #b45309;
    }

    .school-badge.method {
      background: #e0e7ff;
      color: #4338ca;
    }

    .school-name {
      font-size: 20px;
      font-weight: 700;
      color: #111;
      margin-bottom: 4px;
    }

    .school-faculty {
      font-size: 14px;
      color: #666;
    }

    .school-main-info {
      padding: 16px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      background: #fff;
      border-bottom: 1px solid #f0f0f0;
    }

    .school-info-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .school-info-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .school-info-icon.english {
      background: #fef3c7;
      color: #b45309;
    }

    .school-info-icon.gpa {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .school-info-icon.date {
      background: #fce7f3;
      color: #be185d;
    }

    .school-info-icon.region {
      background: #e0e7ff;
      color: #4338ca;
    }

    .school-info-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .school-info-label {
      font-size: 11px;
      color: #888;
      font-weight: 500;
    }

    .school-info-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .school-info-value.highlight {
      color: #0d9488;
    }

    .school-accordion {
      border-top: 1px solid #f0f0f0;
    }

    .school-accordion-header {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      cursor: pointer;
      background: #fafafa;
      transition: background 0.2s;
      gap: 10px;
    }

    .school-accordion-header:hover {
      background: #f0f0f0;
    }

    .school-accordion-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0d9488;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .school-accordion-header.open .school-accordion-icon {
      transform: rotate(180deg);
    }

    .school-accordion-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }

    .school-accordion-body {
      display: none;
      padding: 16px 20px;
      background: #fff;
    }

    .school-accordion-header.open+.school-accordion-body {
      display: block;
    }

    .exam-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    .exam-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 13px;
    }

    .exam-item.yes {
      background: #dcfce7;
      color: #166534;
    }

    .exam-item.no {
      background: #f5f5f5;
      color: #999;
    }

    .documents-text {
      font-size: 14px;
      color: #333;
      line-height: 1.7;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .requirements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .requirement-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }

    .requirement-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .requirement-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
    }

    .data-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }

    .data-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .data-value {
      font-size: 16px;
      font-weight: 700;
      color: #0d9488;
    }

    .notes-section {
      margin-top: 12px;
      padding: 12px 16px;
      background: #fffbeb;
      border-radius: 8px;
      border-left: 3px solid #f59e0b;
    }

    .notes-label {
      font-size: 11px;
      font-weight: 600;
      color: #b45309;
      margin-bottom: 4px;
    }

    .notes-text {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    /* ========================================
       授業書類タブ
       ======================================== */
    .materials-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .materials-selector label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .theme-select {
      flex: 1;
      min-width: 250px;
      max-width: 400px;
      padding: 12px 16px;
      border: 2px solid #e5e5e5;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      cursor: pointer;
    }

    .theme-select:focus {
      outline: none;
      border-color: #1565c0;
    }

    .theme-load-btn {
      padding: 12px 20px;
      background: #0d9488;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .theme-load-btn:hover {
      background: #0f766e;
    }

    .theme-load-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 進捗サマリー */
    .materials-progress-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .materials-progress-summary {
        grid-template-columns: 1fr;
      }
    }

    .materials-progress-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .materials-progress-card.input {
      border-left: 4px solid #1565c0;
    }

    .materials-progress-card.quiz {
      border-left: 4px solid #7b1fa2;
    }

    .materials-progress-card.output {
      border-left: 4px solid #e65100;
    }

    .materials-progress-label {
      font-size: 12px;
      color: #888;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .materials-progress-value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    .materials-progress-value.passed {
      color: #2e7d32;
    }

    .materials-progress-value.failed {
      color: #c62828;
    }

    .materials-progress-bar {
      height: 6px;
      background: #e5e5e5;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }

    .materials-progress-bar-fill {
      height: 100%;
      border-radius: 3px;
    }

    .materials-progress-bar-fill.input {
      background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
    }

    .materials-progress-bar-fill.output {
      background: linear-gradient(90deg, #e65100 0%, #ff9800 100%);
    }

    /* 3カラムレイアウト */
    .output-viewer {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 20px;
      min-height: 500px;
    }

    @media (max-width: 1100px) {
      .output-viewer {
        grid-template-columns: 1fr;
      }
    }

    /* 質問リスト（左） */
    .output-questions-panel {
      background: #fafafa;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e5e5;
    }

    .output-questions-header {
      background: linear-gradient(135deg, #e65100 0%, #ff9800 100%);
      color: #fff;
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .output-questions-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .output-category {
      border-bottom: 1px solid #eee;
    }

    .output-category:last-child {
      border-bottom: none;
    }

    .output-category-header {
      padding: 12px 16px;
      background: #fff;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .output-category-header:hover {
      background: #f5f5f5;
    }

    .output-category-header i {
      color: #e65100;
      transition: transform 0.2s;
    }

    .output-category-header.collapsed i {
      transform: rotate(-90deg);
    }

    .output-category-items {
      display: block;
    }

    .output-category-header.collapsed+.output-category-items {
      display: none;
    }

    .output-question-item {
      padding: 10px 16px 10px 32px;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .output-question-item:hover {
      background: #fff3e0;
      color: #e65100;
    }

    .output-question-item.active {
      background: #fff3e0;
      color: #e65100;
      border-left-color: #e65100;
      font-weight: 600;
    }

    .output-question-item.answered {
      color: #333;
    }

    .output-question-item.answered::before {
      content: '✓';
      color: #4caf50;
      font-weight: 700;
      margin-right: 4px;
    }

    .output-question-number {
      font-weight: 600;
      color: #e65100;
      min-width: 28px;
    }

    .output-question-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 生徒回答（中央） */
    .output-answer-panel {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .output-answer-header {
      background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%);
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
    }

    .output-answer-question-num {
      font-size: 12px;
      color: #e65100;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .output-answer-question-text {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      line-height: 1.5;
    }

    .output-answer-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .output-answer-text {
      font-size: 14px;
      color: #333;
      line-height: 1.8;
      white-space: pre-wrap;
      min-height: 150px;
      padding: 16px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
    }

    .output-answer-empty {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }

    /* 生徒回答編集モード */
    .output-answer-edit-mode {
      display: none;
    }

    .output-answer-edit-mode.active {
      display: block;
    }

    .output-answer-display-mode.hidden {
      display: none;
    }

    .output-answer-textarea {
      width: 100%;
      min-height: 200px;
      padding: 14px;
      border: 2px solid #0d9488;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.8;
      resize: vertical;
      background: #f0fdfa;
    }

    .output-answer-textarea:focus {
      outline: none;
      border-color: #0f766e;
      box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15);
    }

    .output-answer-edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }

    .answer-edit-btn {
      padding: 8px 16px;
      background: #f0fdfa;
      border: 1px solid #0d9488;
      border-radius: 8px;
      color: #0d9488;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .answer-edit-btn:hover {
      background: #0d9488;
      color: #fff;
    }

    .answer-save-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .answer-save-btn:hover {
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }

    .answer-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .answer-cancel-btn {
      padding: 10px 20px;
      background: #e5e5e5;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .answer-cancel-btn:hover {
      background: #d5d5d5;
    }

    .answer-edit-status {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }

    .answer-edit-status.saved {
      color: #0d9488;
    }

    .output-answer-nav {
      display: flex;
      justify-content: space-between;
      padding: 16px 20px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .output-nav-btn {
      padding: 10px 16px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }

    .output-nav-btn:hover:not(:disabled) {
      border-color: #e65100;
      color: #e65100;
    }

    .output-nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* 講師コメント（右） */
    .output-comment-panel {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .output-comment-header {
      background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
      color: #fff;
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .output-comment-content {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .output-comment-textarea {
      flex: 1;
      width: 100%;
      min-height: 200px;
      padding: 14px;
      border: 2px solid #e5e5e5;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.7;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .output-comment-textarea:focus {
      outline: none;
      border-color: #9c27b0;
    }

    .output-comment-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    .comment-save-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .comment-save-btn:hover {
      box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    }

    .comment-save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .comment-status {
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    .comment-status.saved {
      color: #4caf50;
    }

    .materials-empty {
      text-align: center;
      padding: 80px 20px;
      color: #888;
    }

    .materials-empty i {
      margin-bottom: 16px;
      opacity: 0.4;
    }

    /* 総合進捗サマリー（目標・指示タブ内） */
    .progress-summary-mini {
      background: linear-gradient(135deg, #f0fdfa 0%, #e6faf7 100%);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      border: 1px solid #ccfbf1;
    }

    .progress-summary-mini-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .progress-summary-mini-title {
      font-size: 13px;
      font-weight: 600;
      color: #0d9488;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .progress-summary-mini-percent {
      font-size: 20px;
      font-weight: 700;
      color: #115e59;
    }

    .progress-bar-mini {
      height: 8px;
      background: #fff;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar-mini-fill {
      height: 100%;
      background: linear-gradient(90deg, #0d9488 0%, #14b8a6 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-summary-mini-detail {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #666;
    }

    .progress-summary-mini-detail strong {
      color: #0d9488;
    }

    /* チェックリスト進捗ヘッダー */
    .checklist-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .checklist-progress-text {
      font-size: 14px;
      color: #666;
    }

    .checklist-progress-text strong {
      color: #0d9488;
      font-size: 18px;
    }

    /* 学年別折りたたみ */
    .progress-grade-accordions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .progress-grade-accordion {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0f2f1;
    }

    .progress-grade-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      transition: background 0.2s;
    }

    .progress-grade-accordion-header:hover {
      background: #f0fdfa;
    }

    .progress-grade-accordion-header strong {
      color: #0d9488;
    }

    .progress-grade-accordion-header i {
      color: #0d9488;
      transition: transform 0.2s;
    }

    .progress-grade-accordion-header.open i {
      transform: rotate(180deg);
    }

    .progress-grade-accordion-body {
      border-top: 1px solid #e0f2f1;
      background: #fafffe;
      max-height: 300px;
      overflow-y: auto;
    }

    .progress-checked-list {
      padding: 12px;
    }

    .progress-checked-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
      font-size: 13px;
      color: #333;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 6px;
      border-left: 3px solid #0d9488;
    }

    .progress-checked-item:last-child {
      margin-bottom: 0;
    }

    .progress-checked-item i {
      color: #0d9488;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .progress-checked-empty {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 13px;
    }

    /* 全項目表示のチェックリスト */
    .progress-checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      font-size: 13px;
      color: #666;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .progress-checklist-item:last-child {
      border-bottom: none;
    }

    .progress-checklist-item:hover {
      background: #f8f9fa;
    }

    .progress-checklist-item.checked {
      background: #f0fdfa;
      color: #333;
    }

    .progress-checklist-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #d5d5d5;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .progress-checklist-item.checked .progress-checklist-checkbox {
      background: #0d9488;
      border-color: #0d9488;
    }

    .progress-checklist-checkbox i {
      color: #fff;
      opacity: 0;
    }

    .progress-checklist-item.checked .progress-checklist-checkbox i {
      opacity: 1;
    }

    .progress-checklist-text {
      line-height: 1.5;
      flex: 1;
    }

    /* ========================================
       旧チェックリストタブ（ティール系に統一）
       ======================================== */
    .old-checklist-summary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 48px;
      padding: 24px 32px;
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
      border-radius: 16px;
      margin-bottom: 20px;
      color: #134e4a;
      border: 1px solid #99f6e4;
    }

    .old-checklist-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: conic-gradient(#0d9488 0deg,
          #14b8a6 calc(var(--progress) * 3.6deg),
          #e5e5e5 calc(var(--progress) * 3.6deg));
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .old-checklist-circle-inner {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .old-checklist-percent {
      font-size: 22px;
      font-weight: 700;
      color: #0d9488;
    }

    .old-checklist-label {
      font-size: 10px;
      color: #666;
    }

    .old-checklist-stats-group {
      display: flex;
      gap: 60px;
    }

    .old-checklist-stats {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }

    .old-checklist-stats-title {
      font-size: 11px;
      font-weight: 600;
      color: #0d9488;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
    }

    .old-checklist-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #333;
    }

    .old-checklist-stat i {
      color: #0d9488;
      flex-shrink: 0;
    }

    .old-checklist-stat strong {
      font-size: 15px;
      color: #0d9488;
    }

    .old-checklist-empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .old-checklist-empty i {
      margin-bottom: 16px;
      opacity: 0.4;
    }

    @media (max-width: 768px) {
      .old-checklist-summary {
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      .old-checklist-stats-group {
        flex-direction: column;
        gap: 16px;
      }

      .old-checklist-stats {
        min-width: auto;
        align-items: center;
      }

      .old-checklist-stat {
        justify-content: center;
      }
    }

    /* 大カテゴリ */
    .old-parent-item {
      background: #fff;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
    }

    .old-parent-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .old-parent-header:hover {
      background: #f0fdfa;
    }

    .old-parent-item.open .old-parent-header {
      background: #f0fdfa;
      border-bottom: 1px solid #ccfbf1;
    }

    .old-parent-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: #fff;
    }

    /* アイコンカラー（濃淡で区別） */
    .old-parent-icon.blue {
      background: linear-gradient(135deg, #134e4a 0%, #115e59 100%);
    }

    .old-parent-icon.cyan {
      background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%);
    }

    .old-parent-icon.purple {
      background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
    }

    .old-parent-icon.amber {
      background: linear-gradient(135deg, #b45309 0%, #d97706 100%);
    }

    .old-parent-icon.orange {
      background: linear-gradient(135deg, #c2410c 0%, #ea580c 100%);
    }

    .old-parent-icon.green {
      background: linear-gradient(135deg, #047857 0%, #059669 100%);
    }

    .old-parent-icon.pink {
      background: linear-gradient(135deg, #be185d 0%, #db2777 100%);
    }

    .old-parent-icon.red {
      background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
    }

    .old-parent-icon.indigo {
      background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
    }

    .old-parent-icon.brown {
      background: linear-gradient(135deg, #57534e 0%, #78716c 100%);
    }

    .old-parent-icon.gray {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
    }

    .old-parent-info {
      flex: 1;
      min-width: 0;
    }

    .old-parent-name {
      font-size: 15px;
      font-weight: 700;
      color: #134e4a;
      margin-bottom: 4px;
    }

    .old-parent-meta {
      font-size: 12px;
      color: #888;
    }

    .old-parent-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .old-parent-progress-bar {
      width: 60px;
      height: 6px;
      background: #e5e5e5;
      border-radius: 3px;
      overflow: hidden;
    }

    .old-parent-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s;
    }

    .old-parent-progress-fill.low {
      background: linear-gradient(90deg, #f87171, #fca5a5);
    }

    .old-parent-progress-fill.mid {
      background: linear-gradient(90deg, #fbbf24, #fde047);
    }

    .old-parent-progress-fill.high {
      background: linear-gradient(90deg, #34d399, #6ee7b7);
    }

    .old-parent-progress-fill.complete {
      background: linear-gradient(90deg, #0d9488, #14b8a6);
    }

    .old-parent-percent {
      font-size: 14px;
      font-weight: 700;
      color: #0d9488;
      min-width: 40px;
      text-align: right;
    }

    .old-parent-arrow {
      color: #999;
      transition: transform 0.2s;
    }

    .old-parent-item.open .old-parent-arrow {
      transform: rotate(180deg);
    }

    .old-parent-content {
      display: none;
      background: #f8fffe;
      padding: 12px;
    }

    .old-parent-item.open .old-parent-content {
      display: block;
    }

    /* 中カテゴリ */
    .old-category-card {
      background: #fff;
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      border: 1px solid #e5e5e5;
      transition: all 0.2s;
    }

    .old-category-card:last-child {
      margin-bottom: 0;
    }

    .old-category-card:hover {
      border-color: #99f6e4;
      box-shadow: 0 2px 8px rgba(13, 148, 136, 0.1);
    }

    .old-category-card.completed {
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
      border-color: #99f6e4;
    }

    .old-category-check {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .old-category-card.completed .old-category-check {
      background: #0d9488;
      color: #fff;
    }

    .old-category-check i {
      color: #999;
    }

    .old-category-card.completed .old-category-check i {
      color: #fff;
    }

    .old-category-info {
      flex: 1;
      min-width: 0;
    }

    .old-category-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .old-category-card.completed .old-category-name {
      color: #115e59;
    }

    .old-category-count {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .old-category-progress {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .old-category-progress-bar {
      width: 50px;
      height: 5px;
      background: #e5e5e5;
      border-radius: 3px;
      overflow: hidden;
    }

    .old-category-progress-fill {
      height: 100%;
      border-radius: 3px;
    }

    .old-category-progress-fill.low {
      background: #f87171;
    }

    .old-category-progress-fill.mid {
      background: #fbbf24;
    }

    .old-category-progress-fill.high {
      background: #34d399;
    }

    .old-category-progress-fill.complete {
      background: #0d9488;
    }

    .old-category-percent {
      font-size: 12px;
      font-weight: 600;
      color: #0d9488;
      min-width: 32px;
      text-align: right;
    }

    /* 項目リスト */
    .old-items-panel {
      background: #fff;
      border-radius: 10px;
      margin-top: 8px;
      padding: 12px;
      border: 1px solid #ccfbf1;
      display: none;
    }

    .old-items-panel.show {
      display: block;
    }

    .old-item-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .old-item-row:last-child {
      border-bottom: none;
    }

    .old-item-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #d5d5d5;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .old-item-row.checked .old-item-checkbox {
      background: #0d9488;
      border-color: #0d9488;
    }

    .old-item-checkbox i {
      color: #fff;
      opacity: 0;
    }

    .old-item-row.checked .old-item-checkbox i {
      opacity: 1;
    }

    .old-item-text {
      font-size: 13px;
      color: #333;
      line-height: 1.5;
    }

    .old-item-row.checked .old-item-text {
      color: #115e59;
    }

    @media (max-width: 600px) {
      .old-checklist-summary {
        flex-direction: column;
        text-align: center;
      }
    }

    .old-checklist-summary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 60px;
      padding: 28px 48px;
      background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
      border-radius: 16px;
      margin-bottom: 20px;
      color: #134e4a;
      border: 1px solid #99f6e4;
    }

    .old-checklist-stats-title {
      font-size: 12px;
      font-weight: 600;
      color: #0d9488;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .old-checklist-status {
      flex-shrink: 0;
    }

    .old-checklist-status-row {
      display: flex;
      gap: 12px;
    }

    .old-checklist-status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-radius: 10px;
      min-width: 70px;
      border: 1px solid #e5e5e5;
    }

    .old-checklist-status-item.completed {
      border-color: #0d9488;
      background: linear-gradient(135deg, #f0fdfa 0%, #fff 100%);
    }

    .old-checklist-status-item.in-progress {
      border-color: #fbbf24;
      background: linear-gradient(135deg, #fefce8 0%, #fff 100%);
    }

    .old-checklist-status-item.not-started {
      border-color: #e5e5e5;
      background: #fff;
    }

    .old-checklist-status-count {
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }

    .old-checklist-status-item.completed .old-checklist-status-count {
      color: #0d9488;
    }

    .old-checklist-status-item.in-progress .old-checklist-status-count {
      color: #d97706;
    }

    .old-checklist-status-item.not-started .old-checklist-status-count {
      color: #9ca3af;
    }

    .old-checklist-status-label {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .old-checklist-summary {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }

      .old-checklist-status-row {
        justify-content: center;
      }
    }

    /* 確認テスト結果の詳細表示 */
    .quiz-result-main {
      font-size: 28px;
      font-weight: 700;
      color: #0d9488;
      line-height: 1;
    }

    .quiz-result-sub {
      font-size: 12px;
      color: #888;
      margin-top: 6px;
    }

    .quiz-not-taken {
      font-size: 28px;
      font-weight: 700;
      color: #999;
    }

    /* 合格・不合格のカード色 */
    .progress-card.passed {
      border-color: #0d9488;
      background: linear-gradient(135deg, #f0fdfa 0%, #fff 100%);
    }

    .progress-card.passed .progress-card-bar {
      background: #0d9488;
    }

    .progress-card.failed {
      border-color: #f87171;
      background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
    }

    .progress-card.failed .progress-card-bar {
      background: #f87171;
    }

    .output-category-header {
      cursor: pointer;
    }

    .output-category-header svg {
      transition: transform 0.2s;
    }

    .output-category-header:not(.collapsed) svg {
      transform: rotate(0deg);
    }

    .output-category-header.collapsed svg {
      transform: rotate(-90deg);
    }

    .output-answer-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .output-answer-question-text {
      flex: 1;
    }

    .answer-refresh-btn {
      background: none;
      border: none;
      color: #0d9488;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .answer-refresh-btn:hover {
      background: rgba(13, 148, 136, 0.1);
    }

    .answer-refresh-btn i {
      width: 18px;
      height: 18px;
    }

    .answer-refresh-btn.loading i,
    .answer-refresh-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    /* 複数コメント表示 */
    .comment-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .comment-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      border-left: 3px solid #9c27b0;
    }

    .comment-item.mine {
      border-left-color: #0d9488;
    }

    .comment-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .comment-item-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }

    .comment-item-teacher {
      font-weight: 600;
      color: #333;
    }

    .comment-item-date {
      color: #999;
    }

    .comment-item-actions {
      display: flex;
      gap: 4px;
    }

    .comment-action-btn {
      padding: 4px 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .comment-action-btn:hover {
      background: #e5e5e5;
      color: #333;
    }

    .comment-action-btn.delete:hover {
      background: #ffebee;
      color: #e53935;
    }

    .comment-item-text {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .comment-empty {
      text-align: center;
      padding: 24px;
      color: #999;
      font-size: 13px;
    }

    .comment-empty i {
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .new-comment-section {
      border-top: 1px solid #eee;
      padding-top: 12px;
    }

    .new-comment-label {
      font-size: 12px;
      font-weight: 600;
      color: #7b1fa2;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ヘッダーユーザー表示 */
    .header-user {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      font-size: 13px;
      color: white;
    }

    @media (max-width: 600px) {
      .header-user {
        padding: 6px 10px;
        font-size: 11px;
      }

      .header-user i {
        width: 14px !important;
        height: 14px !important;
      }
    }

    /* ユーザーメニュー */
    .user-menu {
      position: relative;
      margin-left: auto;
    }

    .user-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .user-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .user-name {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 200;
    }

    .user-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-header {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-name {
      font-size: 14px;
      font-weight: 600;
      color: #111;
      margin-bottom: 2px;
    }

    .dropdown-email {
      font-size: 12px;
      color: #888;
    }

    .dropdown-menu {
      padding: 8px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #555;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      font-family: inherit;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
      color: #111;
    }

    .dropdown-item.danger {
      color: #ef4444;
    }

    .dropdown-item.danger:hover {
      background: #fef2f2;
    }

    .dropdown-divider {
      height: 1px;
      background: #f0f0f0;
      margin: 4px 8px;
    }

    @media (max-width: 600px) {
      .user-name {
        display: none;
      }

      .user-btn {
        padding: 6px 8px;
      }
    }

    /* ========================================
   生徒情報カード内プロフィール
   ======================================== */
    .profile-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-toggle:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .profile-toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
    }

    .profile-toggle-action {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #5eead4;
      font-weight: 500;
    }

    .profile-toggle-action i {
      transition: transform 0.3s;
    }

    .student-info-card.profile-open .profile-toggle-action i {
      transform: rotate(180deg);
    }

    .profile-detail {
      display: none;
      margin-top: 16px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
    }

    .student-info-card.profile-open .profile-detail {
      display: block;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .profile-section {
      background: #f8fafc;
      border-radius: 10px;
      padding: 14px 16px;
      border: 1px solid #e2e8f0;
    }

    .profile-section-title {
      font-size: 11px;
      font-weight: 700;
      color: #0d9488;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .profile-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .profile-item:last-child {
      margin-bottom: 0;
    }

    .profile-item-label {
      color: #94a3b8;
      min-width: 65px;
      flex-shrink: 0;
      font-size: 12px;
    }

    .profile-item-value {
      color: #334155;
      font-weight: 600;
    }

    .profile-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .profile-tag {
      display: inline-block;
      padding: 4px 10px;
      background: #f0fdfa;
      color: #0d9488;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #ccfbf1;
    }

    .profile-tag.personality {
      background: #fef3c7;
      color: #b45309;
      border-color: #fde68a;
    }

    .profile-tag.teaching {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    .profile-tag.constraint {
      background: #fee2e2;
      color: #dc2626;
      border-color: #fecaca;
    }

    .profile-notes {
      grid-column: 1 / -1;
      background: #fffbeb;
      border-left: 3px solid #f59e0b;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
    }

    .profile-notes-label {
      font-size: 11px;
      font-weight: 600;
      color: #b45309;
      margin-bottom: 4px;
    }

    .profile-notes-text {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .profile-empty {
      text-align: center;
      padding: 30px 20px;
      color: #94a3b8;
      grid-column: 1 / -1;
    }

    .profile-empty i {
      margin-bottom: 8px;
      opacity: 0.5;
    }
  </style>
</head>

<body>
  <!-- ヘッダー -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="back-btn">
        <i data-lucide="arrow-left" style="width:18px;height:18px;"></i>
        戻る
      </a>
      <div class="header-divider"></div>
      <div class="header-title">
        <i data-lucide="layout-dashboard"></i>
        授業ダッシュボード
      </div>
      <!-- ユーザーメニュー -->
      <div class="user-menu">
        <button class="user-btn" id="userBtn" onclick="toggleUserMenu()">
          <div class="user-avatar" id="userAvatar">-</div>
          <span class="user-name" id="headerUserName">ログイン中</span>
          <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
        </button>
        <div class="user-dropdown" id="userDropdown">
          <div class="dropdown-header">
            <div class="dropdown-name" id="dropdownName">-</div>
            <div class="dropdown-email" id="dropdownEmail">-</div>
          </div>
          <div class="dropdown-menu">
            <a href="my-schedule.html" class="dropdown-item">
              <i data-lucide="calendar" style="width:16px;height:16px;"></i>
              マイスケジュール
            </a>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item danger" onclick="handleLogout()">
              <i data-lucide="log-out" style="width:16px;height:16px;"></i>
              ログアウト
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- メイン -->
  <main class="main">
    <!-- 生徒選択 -->
    <div class="student-selector">
      <div class="selector-label">
        <i data-lucide="user" style="width:18px;height:18px;"></i>
        生徒を選択
      </div>
      <select id="studentSelect" class="student-select" onchange="onStudentSelectChange()">
        <option value="">-- 生徒を選択してください --</option>
      </select>
      <button class="load-btn" onclick="loadStudentData()">
        <i data-lucide="refresh-cw" style="width:18px;height:18px;"></i>
        更新
      </button>
    </div>

    <!-- 生徒情報カード（プロフィール統合） -->
    <div class="student-info-card" id="studentInfoCard">
      <div class="student-info-header">
        <div class="student-info-main">
          <div class="student-avatar">
            <i data-lucide="user" style="width:28px;height:28px;"></i>
          </div>
          <div class="student-name-area">
            <h2 id="studentName">-</h2>
            <div class="student-meta">
              <span><i data-lucide="graduation-cap" style="width:14px;height:14px;"></i> <span
                  id="studentGrade">-</span></span>
              <span><i data-lucide="school" style="width:14px;height:14px;"></i> <span
                  id="studentSchool">-</span></span>
            </div>
          </div>
        </div>
        <div class="student-stats">
          <div class="stat-item">
            <div class="stat-label">評定平均</div>
            <div class="stat-value" id="studentGPA">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">英語資格</div>
            <div class="stat-value" id="studentEnglish">-</div>
          </div>
        </div>
      </div>
      <div class="student-school" id="studentFirstChoice" style="display:none;">
        <span class="student-school-label">第一志望:</span>
        <span id="firstChoiceText">-</span>
      </div>

      <!-- プロフィール展開トグル -->
      <div class="profile-toggle" onclick="toggleProfileAccordion()">
        <div class="profile-toggle-label">
          <i data-lucide="user-circle" style="width:16px;height:16px;"></i>
          <span>詳細プロフィール</span>
        </div>
        <div class="profile-toggle-action" id="profileToggleAction">
          <span>開く</span>
          <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
        </div>
      </div>

      <!-- プロフィール詳細（アコーディオン） -->
      <div class="profile-detail" id="profileDetail">
        <div class="profile-grid" id="profileContent">
          <!-- JSで描画 -->
        </div>
      </div>
    </div>

    <!-- タブナビゲーション -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('schedule')">
        <i data-lucide="target" style="width:18px;height:18px;"></i>
        <span>目標・指示</span>
      </button>
      <button class="tab-btn" onclick="switchTab('progress')">
        <i data-lucide="check-square" style="width:18px;height:18px;"></i>
        <span>チェックリスト</span>
      </button>
      <button class="tab-btn" onclick="switchTab('schools')">
        <i data-lucide="school" style="width:18px;height:18px;"></i>
        <span>志望校</span>
      </button>
      <button class="tab-btn" onclick="switchTab('materials')">
        <i data-lucide="book-open" style="width:18px;height:18px;"></i>
        <span>授業書類</span>
      </button>
      <button class="tab-btn" onclick="switchTab('history')">
        <i data-lucide="history" style="width:18px;height:18px;"></i>
        <span>授業履歴</span>
      </button>
      <button class="tab-btn" onclick="confirmNavigateToSchedule()">
        <i data-lucide="edit-3" style="width:18px;height:18px;"></i>
        <span>報告作成</span>
      </button>
    </div>

    <!-- タブコンテンツ -->
    <!-- 目標・指示タブ -->
    <div id="tab-schedule" class="tab-content active">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="target" style="width:20px;height:20px;"></i>
            目標・指示
          </div>
        </div>

        <!-- 総合進捗サマリー -->
        <!-- 総合進捗サマリー -->
        <div class="progress-summary-mini">
          <div class="progress-summary-mini-header">
            <div class="progress-summary-mini-title">
              <i data-lucide="trending-up" style="width:16px;height:16px;"></i>
              総合進捗状況
            </div>
            <div class="progress-summary-mini-percent" id="totalProgressPercentMini">0%</div>
          </div>
          <div class="progress-bar-mini">
            <div class="progress-bar-mini-fill" id="totalProgressBarMini" style="width:0%"></div>
          </div>

          <!-- 学年別の折りたたみ -->
          <div class="progress-grade-accordions">
            <div class="progress-grade-accordion">
              <div class="progress-grade-accordion-header" onclick="toggleProgressAccordion(this, '高1')">
                <span>高1: <strong id="progressMini1">0</strong>/30</span>
                <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
              </div>
              <div class="progress-grade-accordion-body" id="progressAccordion1" style="display:none;">
                <div class="progress-checked-list" id="progressCheckedList1">
                  <!-- JSで描画 -->
                </div>
              </div>
            </div>

            <div class="progress-grade-accordion">
              <div class="progress-grade-accordion-header" onclick="toggleProgressAccordion(this, '高2')">
                <span>高2: <strong id="progressMini2">0</strong>/29</span>
                <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
              </div>
              <div class="progress-grade-accordion-body" id="progressAccordion2" style="display:none;">
                <div class="progress-checked-list" id="progressCheckedList2">
                  <!-- JSで描画 -->
                </div>
              </div>
            </div>

            <div class="progress-grade-accordion">
              <div class="progress-grade-accordion-header" onclick="toggleProgressAccordion(this, '高3')">
                <span>高3: <strong id="progressMini3">0</strong>/50</span>
                <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
              </div>
              <div class="progress-grade-accordion-body" id="progressAccordion3" style="display:none;">
                <div class="progress-checked-list" id="progressCheckedList3">
                  <!-- JSで描画 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="schedule-controls">
          <div class="grade-selector">
            <button class="grade-btn active" data-grade="高1" onclick="selectScheduleGrade('高1')">高1</button>
            <button class="grade-btn" data-grade="高2" onclick="selectScheduleGrade('高2')">高2</button>
            <button class="grade-btn" data-grade="高3" onclick="selectScheduleGrade('高3')">高3</button>
          </div>
          <select class="month-select" id="monthSelect" onchange="selectScheduleMonth(this.value)">
            <option value="4">4月</option>
            <option value="5">5月</option>
            <option value="6">6月</option>
            <option value="7">7月</option>
            <option value="8">8月</option>
            <option value="9">9月</option>
            <option value="10">10月</option>
            <option value="11">11月</option>
            <option value="12" selected>12月</option>
            <option value="1">1月</option>
            <option value="2">2月</option>
            <option value="3">3月</option>
          </select>
          <button class="refresh-btn" onclick="refreshScheduleData()">
            <i data-lucide="refresh-cw" style="width:16px;height:16px;"></i>
            更新
          </button>
        </div>

        <div class="schedule-split">
          <!-- 今月やること -->
          <div class="schedule-panel">
            <div class="panel-header">
              <div class="panel-title">
                <i data-lucide="edit-3" style="width:18px;height:18px;"></i>
                <span id="goalsPanelTitle">高1<span style="margin:0 8px;">／</span>1月の目標</span>
                <span class="panel-subtitle">生徒が記入</span>
              </div>
              <div class="panel-actions">
                <button class="panel-btn" onclick="toggleGoalsEdit()" id="goalsEditBtn">
                  <i data-lucide="pencil" style="width:14px;height:14px;"></i>
                  編集
                </button>
              </div>
            </div>
            <div class="panel-content">
              <div id="goalsDisplay">
                <div class="goals-text" id="goalsText"></div>
                <div class="goals-empty" id="goalsEmpty">
                  <i data-lucide="edit-3" style="width:32px;height:32px;"></i>
                  <p>目標が設定されていません</p>
                </div>
              </div>
              <div id="goalsEdit" style="display:none;">
                <textarea class="goals-textarea" id="goalsTextarea" placeholder="この月にやることを入力..."></textarea>
                <div class="edit-actions">
                  <button class="btn-cancel" onclick="cancelGoalsEdit()">キャンセル</button>
                  <button class="btn-save" onclick="saveGoals()">
                    <i data-lucide="save" style="width:16px;height:16px;"></i>
                    保存
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 講師指示 -->
          <div class="schedule-panel">
            <div class="panel-header purple">
              <div class="panel-title">
                <i data-lucide="clipboard-list" style="width:18px;height:18px;"></i>
                <span id="notesPanelTitle">高1<span style="margin:0 8px;">／</span>1月の指示</span>
                <span class="panel-subtitle">講師が記入</span>
              </div>
            </div>
            <div class="panel-content">
              <div class="notes-list" id="notesList">
                <div class="notes-empty" id="notesEmpty">
                  <i data-lucide="clipboard-list" style="width:32px;height:32px;"></i>
                  <p>指示はありません</p>
                </div>
              </div>
              <button class="add-note-btn" onclick="openNoteModal()">
                <i data-lucide="plus" style="width:16px;height:16px;"></i>
                指示を追加
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- チェックリストタブ -->
    <div id="tab-progress" class="tab-content">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="check-square" style="width:20px;height:20px;"></i>
            チェックリスト（生徒の進捗確認）
          </div>
        </div>

        <!-- 全体進捗 -->
        <div class="old-checklist-summary" id="oldChecklistSummary" style="display:none;">
          <div class="old-checklist-circle" id="oldChecklistCircle" style="--progress: 0;">
            <div class="old-checklist-circle-inner">
              <span class="old-checklist-percent" id="oldChecklistPercent">0%</span>
              <span class="old-checklist-label">完了</span>
            </div>
          </div>
          <div class="old-checklist-stats-group">
            <div class="old-checklist-stats">
              <div class="old-checklist-stats-title">全体進捗</div>
              <div class="old-checklist-stat">
                <i data-lucide="check-circle" style="width:16px;height:16px;"></i>
                <span><strong id="oldChecklistCompleted">0</strong> / <span id="oldChecklistTotal">0</span>
                  カテゴリ完了</span>
              </div>
              <div class="old-checklist-stat">
                <i data-lucide="list-checks" style="width:16px;height:16px;"></i>
                <span><strong id="oldChecklistItems">0</strong> / <span id="oldChecklistItemsTotal">0</span>
                  項目チェック済</span>
              </div>
            </div>
            <div class="old-checklist-stats">
              <div class="old-checklist-stats-title">カテゴリ状況</div>
              <div class="old-checklist-stat">
                <i data-lucide="circle-check" style="width:16px;height:16px;color:#0d9488;"></i>
                <span>完了: <strong id="oldStatusCompleted">0</strong></span>
              </div>
              <div class="old-checklist-stat">
                <i data-lucide="loader" style="width:16px;height:16px;color:#d97706;"></i>
                <span>進行中: <strong id="oldStatusInProgress" style="color:#d97706;">0</strong></span>
              </div>
              <div class="old-checklist-stat">
                <i data-lucide="circle-dashed" style="width:16px;height:16px;color:#9ca3af;"></i>
                <span>未着手: <strong id="oldStatusNotStarted" style="color:#9ca3af;">0</strong></span>
              </div>
            </div>
          </div>
        </div>

        <!-- 大カテゴリアコーディオン -->
        <div class="old-checklist-accordion" id="oldChecklistAccordion">
          <div class="old-checklist-empty" id="oldChecklistEmpty">
            <i data-lucide="clipboard-list" style="width:48px;height:48px;"></i>
            <p>生徒を選択してデータを読み込んでください</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 志望校タブ -->
    <div id="tab-schools" class="tab-content">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="school" style="width:20px;height:20px;"></i>
            志望校／併願校
          </div>
        </div>

        <div class="pattern-tabs">
          <div class="pattern-tab active" data-pattern="A" onclick="selectPattern('A')">
            <div class="pattern-letter">A</div>
            <div class="pattern-icons">
              <i data-lucide="check-circle" class="check" style="width:14px;height:14px;"></i>
              <i data-lucide="check-circle" class="check" style="width:14px;height:14px;"></i>
            </div>
          </div>
          <div class="pattern-tab" data-pattern="B" onclick="selectPattern('B')">
            <div class="pattern-letter">B</div>
            <div class="pattern-icons">
              <i data-lucide="check-circle" class="check" style="width:14px;height:14px;"></i>
              <i data-lucide="x-circle" class="cross" style="width:14px;height:14px;"></i>
            </div>
          </div>
          <div class="pattern-tab" data-pattern="C" onclick="selectPattern('C')">
            <div class="pattern-letter">C</div>
            <div class="pattern-icons">
              <i data-lucide="x-circle" class="cross" style="width:14px;height:14px;"></i>
              <i data-lucide="check-circle" class="check" style="width:14px;height:14px;"></i>
            </div>
          </div>
          <div class="pattern-tab" data-pattern="D" onclick="selectPattern('D')">
            <div class="pattern-letter">D</div>
            <div class="pattern-icons">
              <i data-lucide="x-circle" class="cross" style="width:14px;height:14px;"></i>
              <i data-lucide="x-circle" class="cross" style="width:14px;height:14px;"></i>
            </div>
          </div>
        </div>

        <div class="pattern-description" id="patternDescription">
          <i data-lucide="info" style="width:18px;height:18px;"></i>
          <span id="patternDescText">パターンA：評定平均○・英語資格○（両方達成のベストケース）</span>
        </div>

        <div class="school-list" id="schoolList">
          <div class="schools-empty" id="schoolsEmpty">
            <i data-lucide="school" style="width:48px;height:48px;"></i>
            <p>志望校が登録されていません</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 授業書類タブ -->
    <div id="tab-materials" class="tab-content">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="book-open" style="width:20px;height:20px;"></i>
            授業書類
          </div>
        </div>

        <!-- テーマ選択 -->
        <div class="materials-selector">
          <label>テーマ選択:</label>
          <select id="themeSelect" class="theme-select">
            <option value="">-- テーマを選択 --</option>
            <option value="1" disabled>テーマ1: 総合型選抜の本質と基礎原則（準備中）</option>
            <option value="2">テーマ2: 「すき」を見つけ、伸ばし、学問に繋げる</option>
            <option value="3" disabled>テーマ3: 併願校／志望校戦略の本質理解（準備中）</option>
            <option value="4" disabled>テーマ4: 志望理由書の本質理解から実践（準備中）</option>
            <option value="5" disabled>テーマ5: 自己推薦書の本質理解から実践（準備中）</option>
            <option value="6" disabled>テーマ6: レポートの本質理解から実践（準備中）</option>
            <option value="7" disabled>テーマ7: 小論文の本質理解から実践（準備中）</option>
            <option value="8" disabled>テーマ8: 面接の本質理解から実践（準備中）</option>
            <option value="9" disabled>テーマ9: プレゼンテーションの本質理解から実践（準備中）</option>
          </select>
          <button class="theme-load-btn" onclick="loadThemeData()">
            <i data-lucide="download" style="width:16px;height:16px;"></i>
            読み込む
          </button>
        </div>

        <!-- 進捗サマリー（読み込み後に表示） -->
        <div class="materials-progress-summary" id="materialsProgressSummary" style="display:none;">
          <div class="materials-progress-card input">
            <div class="materials-progress-label">インプット進捗</div>
            <div class="materials-progress-value" id="inputProgressValue">0/31</div>
            <div class="materials-progress-bar">
              <div class="materials-progress-bar-fill input" id="inputProgressBar" style="width:0%"></div>
            </div>
          </div>
          <div class="materials-progress-card quiz">
            <div class="materials-progress-label">確認テスト</div>
            <div class="materials-progress-value" id="quizProgressValue">未受験</div>
          </div>
          <div class="materials-progress-card output">
            <div class="materials-progress-label">アウトプット進捗</div>
            <div class="materials-progress-value" id="outputProgressValue">0/50</div>
            <div class="materials-progress-bar">
              <div class="materials-progress-bar-fill output" id="outputProgressBar" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- アウトプットビューア（3カラム） -->
        <div class="output-viewer" id="outputViewer" style="display:none;">
          <!-- 左: 質問リスト -->
          <div class="output-questions-panel">
            <div class="output-questions-header">
              <i data-lucide="list" style="width:18px;height:18px;"></i>
              質問一覧
            </div>
            <div class="output-questions-list" id="outputQuestionsList">
              <!-- JSで描画 -->
            </div>
          </div>

          <!-- 中央: 生徒回答 -->
          <div class="output-answer-panel">
            <div class="output-answer-header">
              <div class="output-answer-question-num" id="currentQuestionNum">Q1</div>
              <div class="output-answer-question-text" id="currentQuestionText">質問を選択してください</div>
              <button class="answer-refresh-btn" onclick="refreshStudentAnswer()" title="生徒の回答を更新">
                <i data-lucide="refresh-cw" id="answerRefreshIcon"></i>
              </button>
            </div>
            <div class="output-answer-content">
              <!-- 表示モード -->
              <div class="output-answer-display-mode" id="answerDisplayMode">
                <div class="output-answer-text" id="currentAnswerText">
                  <div class="output-answer-empty">左の質問一覧から質問を選択してください</div>
                </div>
                <button class="answer-edit-btn" onclick="startEditAnswer()" id="answerEditBtn" style="margin-top:12px;">
                  <i data-lucide="pencil" style="width:14px;height:14px;"></i>
                  回答を編集・追記
                </button>
              </div>
              <!-- 編集モード -->
              <div class="output-answer-edit-mode" id="answerEditMode">
                <textarea class="output-answer-textarea" id="answerEditTextarea" placeholder="回答を入力..."></textarea>
                <div class="output-answer-edit-actions">
                  <button class="answer-cancel-btn" onclick="cancelEditAnswer()">キャンセル</button>
                  <button class="answer-save-btn" onclick="saveEditedAnswer()" id="answerSaveBtn">
                    <i data-lucide="save" style="width:14px;height:14px;"></i>
                    保存
                  </button>
                </div>
                <div class="answer-edit-status" id="answerEditStatus"></div>
              </div>
            </div>
            <div class="output-answer-nav">
              <button class="output-nav-btn" onclick="prevQuestion()" id="prevQuestionBtn" disabled>
                <i data-lucide="chevron-left" style="width:16px;height:16px;"></i>
                前へ
              </button>
              <button class="output-nav-btn" onclick="nextQuestion()" id="nextQuestionBtn" disabled>
                次へ
                <i data-lucide="chevron-right" style="width:16px;height:16px;"></i>
              </button>
            </div>
          </div>

          <!-- 右: 講師コメント -->
          <div class="output-comment-panel">
            <div class="output-comment-header">
              <i data-lucide="message-square" style="width:18px;height:18px;"></i>
              講師コメント
              <button class="answer-refresh-btn" onclick="refreshTeacherComments()" title="コメントを更新"
                style="margin-left:auto; color: #fff;">
                <i data-lucide="refresh-cw" id="commentRefreshIcon"></i>
              </button>
            </div>
            <div class="output-comment-content">
              <!-- コメント一覧 -->
              <div class="comment-list" id="commentList">
                <div class="comment-empty" id="commentEmpty">
                  <i data-lucide="message-circle" style="width:32px;height:32px;"></i>
                  <p>コメントはまだありません</p>
                </div>
              </div>

              <!-- 新規コメント入力 -->
              <div class="new-comment-section">
                <div class="new-comment-label">
                  <i data-lucide="plus-circle" style="width:14px;height:14px;"></i>
                  新しいコメントを追加
                </div>
                <textarea class="output-comment-textarea" id="teacherCommentTextarea"
                  placeholder="この回答へのコメント・改善点を入力..."></textarea>
                <div class="output-comment-actions">
                  <button class="comment-save-btn" onclick="saveTeacherComment()">
                    <i data-lucide="send" style="width:14px;height:14px;"></i>
                    投稿
                  </button>
                </div>
                <div class="comment-status" id="commentStatus"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 空状態（初期表示） -->
        <div class="materials-empty" id="materialsEmpty">
          <i data-lucide="book-open" style="width:48px;height:48px;"></i>
          <p>生徒を選択し、テーマを選んでデータを読み込んでください</p>
        </div>
      </div>
    </div>

    <!-- 授業履歴タブ -->
    <div id="tab-history" class="tab-content">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="history" style="width:20px;height:20px;"></i>
            授業履歴・宿題
          </div>
        </div>

        <div class="lesson-list" id="lessonList">
          <div class="empty-state" id="lessonEmpty">
            <i data-lucide="inbox" style="width:48px;height:48px;"></i>
            <p>授業履歴がありません</p>
          </div>
        </div>

        <button class="load-more-btn" id="loadMoreLessons" style="display:none;" onclick="loadMoreLessons()">
          さらに表示
        </button>
      </div>
    </div>

    <!-- 報告作成タブ -->
    <div id="tab-report" class="tab-content">
      <div class="content-card">
        <div class="card-header">
          <div class="card-title">
            <i data-lucide="edit-3" style="width:20px;height:20px;"></i>
            授業報告を作成
          </div>
        </div>

        <div style="padding:40px 20px;text-align:center;">
          <div style="margin-bottom:24px;">
            <i data-lucide="calendar-check" style="width:64px;height:64px;color:#0d9488;"></i>
          </div>
          <h3 style="margin:0 0 12px;color:#1f2937;font-size:1.25rem;">授業報告は「私のスケジュール」から</h3>
          <p style="margin:0 0 24px;color:#6b7280;line-height:1.6;">
            スケジュールページで授業を選択し、<br>報告を作成・送信できます。
          </p>
          <a href="my-schedule.html" class="btn-primary"
            style="display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:#0d9488;color:white;text-decoration:none;border-radius:8px;font-weight:500;transition:background 0.2s;">
            <i data-lucide="arrow-right" style="width:18px;height:18px;"></i>
            私のスケジュールを開く
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- コメント編集モーダル -->
  <div class="modal-overlay" id="commentEditModal">
    <div class="modal">
      <div class="modal-header" style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);">
        <div class="modal-title">
          <i data-lucide="pencil" style="width:20px;height:20px;"></i>
          コメントを編集
        </div>
        <button class="modal-close" onclick="closeCommentEditModal()">
          <i data-lucide="x" style="width:18px;height:18px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">コメント内容</label>
          <textarea class="form-textarea" id="editCommentText" placeholder="コメントを入力..."
            style="min-height:150px;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeCommentEditModal()">キャンセル</button>
        <button class="modal-btn save" onclick="submitCommentEdit()"
          style="background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);">保存</button>
      </div>
    </div>
  </div>

  <!-- 講師指示追加モーダル -->
  <div class="modal-overlay" id="noteModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <i data-lucide="plus-circle" style="width:20px;height:20px;"></i>
          講師の指示を追加
        </div>
        <button class="modal-close" onclick="closeNoteModal()">
          <i data-lucide="x" style="width:18px;height:18px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">指示内容 *</label>
          <textarea class="form-textarea" id="noteText" placeholder="指示内容を入力..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">期限日（任意）</label>
          <input type="date" class="form-input" id="noteDeadline">
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeNoteModal()">キャンセル</button>
        <button class="modal-btn save" onclick="saveNote()">保存</button>
      </div>
    </div>
  </div>

  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <script>
    // API設定
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';
    const ENROLLMENT_API_URL = 'https://script.google.com/macros/s/AKfycbyFJMfjgZzOw9v16PEoQQrRqqYe__oSn6zHdajEXdeXaUf6ACxwBhcMaGf449Qju-t-/exec';

    // 状態
    let selectedStudentId = null;
    let selectedStudentInfo = null;
    let selectedScheduleGrade = '高1';
    let selectedScheduleMonth = '12';
    let selectedChecklistGrade = '高1';
    let selectedPattern = 'A';
    let editingNoteId = null;

    // データ
    let studentData = {
      goals: {},
      instructorNotes: [],
      checklist: { "高1": [], "高2": [], "高3": [] },
      schools: { A: [], B: [], C: [], D: [] },
      lessons: []
    };

    // プロフィールデータ
    let studentProfileData = null;

    // プロフィールAPI URL（生徒ポータルと同じGAS）
    const PROFILE_API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';

    // チェックリストデータ
    const checklistData = {
      "高1": [
        "評定平均に力を入れ、4.0を目指す",
        "部活動に力を入れ、継続力や忍耐力をつける",
        "欠席や遅刻をしないよう心がけ、内申点を高得点に保つ",
        "多様なプログラムに積極的に参加し、視野を広げ、コミュニケーション能力を鍛える",
        "なぜ？を意識しながら行動し、思考力を鍛え研究テーマとなるきっかけを探る",
        "本や映画を積極的に視聴し視野を広げる",
        "基礎学力をおろそかにせず、特に英語、国語、数学、歴史には注力する",
        "英語資格（英検とIELTS）に力を入れて、２級獲得を目指す",
        "総合型選抜とは何かを理解する",
        "総合型選抜でやるべきことやスケジュールを理解する",
        "過去の人生を振り返り自分だからこその魅力や人間性、強み、経歴を客観視し、自分の武器を理解する",
        "現時点で将来つきたい職業、やりたいこと、目標を言語化する",
        "保護者や友人、メンターとディスカッションを重ね、自分の性格を知る",
        "チェックリストから志望理由書の基礎をインプットする",
        "チェックリストから自己推薦書の基礎をインプットする",
        "チェックリストから提出書類の基礎をインプットする",
        "チェックリストから出願資格の基礎をインプットする",
        "チェックリストから志望校/併願校決めの基礎をインプットする",
        "チェックリストから小論文の基礎をインプットする",
        "チェックリストからレポートの基礎をインプットする",
        "チェックリストから面接の基礎をインプットする",
        "チェックリストからプレゼンテーションの基礎をインプットする",
        "集団授業に全て参加し、過去の授業も視聴する",
        "チェックリストから考え方の基礎をインプットする",
        "EQAO生が読むべき本を購入し朗読を開始する",
        "すき見つけるテクニックをインプットする",
        "すきを伸ばすためのテクニックをインプットする",
        "EQAOのステップアップ動画教材を20%は視聴完了させる",
        "EQAO配信のコラムとYouTube動画を視聴して基礎を固める",
        "高校2年からの計画表、スケジュールを作成する"
      ],
      "高2": [
        "第一志望校を確定させる",
        "評定平均と英語資格など全ての条件を満たした時の併願校一覧を決める",
        "評定平均のみ満たした場合の併願校一覧を決める",
        "英語資格のみ満たした場合の併願校一覧を決める",
        "何も満たせなかった場合の併願校一覧を決める",
        "志望校や併願校を調べ、比較し、それぞれの特徴や特色、違いを踏まえる",
        "研究テーマをさらに深掘り、本質的かつ発展的なテーマにする",
        "志望校、併願校の教授の素性や経歴、専門分野などを指定ツールを使用して把握する",
        "土台となる第一志望校の志望理由書や自己推薦書を量を気にすることなく具体的に書き始める",
        "志望校の最も気になる教授の書籍や論文を読み始める",
        "評定平均と英語資格を継続的に取り組む",
        "志望校/併願校の過去問を請求する",
        "継続的に研究テーマに関連する支援活動を行う",
        "多様なプログラムや大会に参加し視野を広げ、経験を積む",
        "継続してEQAOのステップアップ動画教材を視聴して60%は視聴完了させる",
        "継続してEQAOのコラムとYouTube配信に目を通す",
        "志望校の志望理由書以外の書類にも着手する",
        "研究テーマの仮説検証行動に着手する",
        "時事問題をキャッチアップし始める",
        "関連するテーマの書籍や教授の書籍を視聴する",
        "志望する学部の関連テーマの小論文に着手する",
        "志望校の過去問に一度触れて小論文の癖や特徴を理解する",
        "志望校/併願校の過去問回収を行う",
        "オープンキャンパスや模擬講義に参加する",
        "留学や短期留学、スタディーツアーに参加する",
        "一般入試にも備えて基礎学力も上げておく",
        "英検準一級/IELTS5.5を狙う（EQAOではIELTSを推奨）",
        "継続して集団授業を受講する/過去の配信も全て閲覧する",
        "高校3年からの計画表、スケジュールを作成する"
      ],
      "高3": [
        "志望校／併願校ともに確定させる",
        "各志望校に向けた書類の転用と調整を行う",
        "新しく発行された募集要項を確認する",
        "最新版の過去問請求を行う",
        "評定平均／英語資格の基準を満たす",
        "英検準一級／IELTS5.5／評定平均4.0獲得",
        "課題レポート（書類）に着手する",
        "小論文の専門分野の演習を継続する",
        "過去問分析と過去問演習を行う",
        "時事問題のキャッチアップを継続する",
        "倍率の分析を行う",
        "出願サポートを受ける",
        "面接100問基礎は徹底する",
        "書類からの質問を100問想定する",
        "大学や社会・時事問題に関して50問を想定する",
        "研究テーマに関する仮説検証行動を行う",
        "研究テーマに関連する研究発表・プレゼン大会・課題解決系イベントに参加する",
        "要約問題のチェックリストを埋める",
        "出願2ヶ月前には推薦状を高校に依頼する",
        "調査書に書いてもらいたい内容・提出書類を担任の先生に共有し、リンクをおすすめる",
        "担任の先生とのコミュニケーションを増やす",
        "指定校推薦を出してもよいが妥協はしない",
        "英語資格の原本照合用コピーを複数作成しておく",
        "英語資格を複数回受験し、異なる種類も取得しておく",
        "賞状などはクリアファイルで徹底管理し、提出しやすくする",
        "オープンキャンパスに行く",
        "研究テーマ以外の本を一冊読む",
        "研究テーマ以外の映画を見る",
        "漢字の基礎を徹底する",
        "志望理由書を複数パターン作成し、最適なものを選んで提出する",
        "志願票のためのプロフィールを整理しておく",
        "活動報告書のためのプロフィールを整理しておく（学校内外問わず）",
        "研究テーマ以外の活動にも積極的に参加する",
        "スタディツアーに参加する",
        "専願か併願かを確認する",
        "Web出願・登録の有無を確認する",
        "併願スケジュールを学校に提出し、調査書発行願いを早めに出す",
        "分からないことがあれば大学に直接確認する",
        "集団授業に参加する",
        "小論文の練習のために口頭試問にも触れる",
        "小論文ネタ・事例ノートを作成する",
        "グラフ問題が出題される場合の対策を行う",
        "関連する他大学の同分野過去問にも触れる",
        "「しないことリスト」を作成する",
        "自分の弱点・癖・懸念を認知し、段階的に払拭していく",
        "保護者への伝達を怠らない",
        "進捗管理・スケジュール管理を徹底する",
        "三者面談・塾長面談を受けて方向性を確認する",
        "EQAO模試を受験する",
        "授業外学習を徹底すること"
      ]
    };

    const patternDescriptions = {
      A: 'パターンA：評定平均○・英語資格○（両方達成のベストケース）',
      B: 'パターンB：評定平均○・英語資格×（評定のみ達成）',
      C: 'パターンC：評定平均×・英語資格○（英語のみ達成）',
      D: 'パターンD：評定平均×・英語資格×（両方未達のセーフティプラン）'
    };

    // 初期化
    document.addEventListener('DOMContentLoaded', async function () {
      lucide.createIcons();

      await loadStudentList();

      // ヘッダーに講師名を表示
      const teacher = getCurrentTeacher();
      const headerUserName = document.getElementById('headerUserName');
      const userAvatar = document.getElementById('userAvatar');
      const dropdownName = document.getElementById('dropdownName');
      const dropdownEmail = document.getElementById('dropdownEmail');

      if (teacher.teacherName) {
        const initial = teacher.teacherName.charAt(0);
        if (headerUserName) headerUserName.textContent = teacher.teacherName;
        if (userAvatar) userAvatar.textContent = initial;
        if (dropdownName) dropdownName.textContent = teacher.teacherName;
      }

      // メールアドレスも取得して表示
      try {
        const sessionStr = localStorage.getItem('eqao_staff_session');
        if (sessionStr) {
          const session = JSON.parse(sessionStr);
          if (dropdownEmail && session.email) {
            dropdownEmail.textContent = session.email;
          }
        }
      } catch (e) { }

      // 現在の月を設定
      const currentMonth = String(new Date().getMonth() + 1);
      selectedScheduleMonth = currentMonth;
      document.getElementById('monthSelect').value = currentMonth;

      // パネルタイトルの初期表示を更新
      document.getElementById('goalsPanelTitle').innerHTML = `${selectedScheduleGrade}<span style="margin:0 8px;">／</span>${selectedScheduleMonth}月の目標`;
      document.getElementById('notesPanelTitle').innerHTML = `${selectedScheduleGrade}<span style="margin:0 8px;">／</span>${selectedScheduleMonth}月の指示`;

      // URLパラメータから生徒IDを取得して自動選択
      const urlParams = new URLSearchParams(window.location.search);
      const studentIdFromUrl = urlParams.get('studentId');
      if (studentIdFromUrl) {
        const select = document.getElementById('studentSelect');
        select.value = studentIdFromUrl;
        if (select.value === studentIdFromUrl) {
          loadStudentData();
        }
      }
    });

    // 生徒リストを読み込み（入塾データGASから取得）
    async function loadStudentList() {
      try {
        const response = await fetch(`${ENROLLMENT_API_URL}?action=getStudents`);
        const result = await response.json();

        if (!result.success || !result.data) {
          console.error('生徒データ取得失敗:', result);
          return [];
        }

        const students = result.data;
        const select = document.getElementById('studentSelect');

        students.forEach(student => {
          // 現在の学年を計算
          const currentGrade = calculateCurrentGrade(student.grade, student.enrolledDate);

          const option = document.createElement('option');
          option.value = student.studentId;
          option.textContent = `${student.studentId} - ${student.name}（${currentGrade}）`;
          option.dataset.info = JSON.stringify({
            id: student.studentId,
            name: student.name,
            grade: currentGrade,
            school: student.school,
            gpa: student.currentGpa,
            english: '',
            firstChoice: student.firstChoiceUniv
          });
          select.appendChild(option);
        });

        return students;
      } catch (error) {
        console.error('Error loading students:', error);
        return [];
      }
    }

    // 入塾時の学年から現在の学年を計算（4月切り替え）
    function calculateCurrentGrade(enrolledGrade, enrolledDate) {
      if (!enrolledGrade) return '-';

      // 学年を数値に変換（高校1年生 → 1, 高2 → 2 など）
      let gradeNum = 0;
      if (enrolledGrade.includes('1') || enrolledGrade.includes('１')) {
        gradeNum = 1;
      } else if (enrolledGrade.includes('2') || enrolledGrade.includes('２')) {
        gradeNum = 2;
      } else if (enrolledGrade.includes('3') || enrolledGrade.includes('３')) {
        gradeNum = 3;
      } else {
        return enrolledGrade; // パースできなければそのまま返す
      }

      // 入塾時の年度を計算（4月始まり: 1-3月は前年度扱い）
      let enrollYear;
      if (enrolledDate) {
        const enrollDate = new Date(enrolledDate);
        enrollYear = enrollDate.getMonth() >= 3 ? enrollDate.getFullYear() : enrollDate.getFullYear() - 1;
      } else {
        // 申込日時がない場合は現在年度とみなす
        const now = new Date();
        enrollYear = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;
      }

      // 現在の年度を計算（4月始まり: 1-3月は前年度扱い）
      const now = new Date();
      const currentYear = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;

      // 年度差分を加算
      const yearsElapsed = currentYear - enrollYear;
      const newGradeNum = gradeNum + yearsElapsed;

      // 卒業判定（高3を超えたら「卒業」）
      if (newGradeNum > 3) {
        return '卒業';
      }

      // 0以下になることはないはずだが念のため
      if (newGradeNum < 1) {
        return `高${gradeNum}`;
      }

      return `高${newGradeNum}`;
    }

    // プルダウン選択時の処理
    function onStudentSelectChange() {
      const select = document.getElementById('studentSelect');
      if (select.value) {
        loadStudentData();
      }
    }

    // 生徒データを読み込み
    async function loadStudentData() {
      const select = document.getElementById('studentSelect');
      const studentId = select.value;

      if (!studentId) {
        alert('生徒を選択してください');
        return;
      }

      selectedStudentId = studentId;

      // 選択された生徒の情報を取得
      const selectedOption = select.options[select.selectedIndex];
      selectedStudentInfo = JSON.parse(selectedOption.dataset.info || '{}');

      // 生徒の学年を取得して設定（高1、高2、高3 のみ）
      const studentGrade = selectedStudentInfo.grade;
      if (studentGrade && ['高1', '高2', '高3'].includes(studentGrade)) {
        selectedScheduleGrade = studentGrade;
        selectedChecklistGrade = studentGrade;
        // 学年ボタンのUIを更新
        document.querySelectorAll('.grade-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.grade === studentGrade);
        });
        document.querySelectorAll('.checklist-grade-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.grade === studentGrade);
        });
      }

      // 現在の月を設定
      const currentMonth = String(new Date().getMonth() + 1);
      selectedScheduleMonth = currentMonth;
      document.getElementById('monthSelect').value = currentMonth;

      showLoading(true);

      try {
        // 並列でデータを取得
        await Promise.all([
          loadGoals(),
          loadInstructorNotes(),
          loadChecklist(),
          loadSchools(),
          loadLessonHistory(),
          loadStudentProfile()
        ]);

        // 生徒情報カードを表示
        displayStudentInfo();

        // UIを更新
        updateScheduleUI();
        renderChecklist();
        renderSchools();
        updateTotalProgress();
        loadOldChecklist();

      } catch (error) {
        console.error('Error loading student data:', error);
        alert('データの読み込みに失敗しました');
      } finally {
        showLoading(false);
      }
    }

    // 生徒情報を表示
    function displayStudentInfo() {
      const card = document.getElementById('studentInfoCard');

      document.getElementById('studentName').textContent = selectedStudentInfo.name || '-';
      document.getElementById('studentGrade').textContent = selectedStudentInfo.grade || '-';
      document.getElementById('studentSchool').textContent = selectedStudentInfo.school || '-';
      document.getElementById('studentGPA').textContent = selectedStudentInfo.gpa || '-';
      document.getElementById('studentEnglish').textContent = selectedStudentInfo.english || '-';

      // 第一志望
      const firstChoice = document.getElementById('studentFirstChoice');
      if (studentData.schools.A && studentData.schools.A.length > 0) {
        const school = studentData.schools.A[0];
        document.getElementById('firstChoiceText').textContent = `${school.universityName} ${school.faculty}`;
        firstChoice.style.display = 'block';
      } else {
        firstChoice.style.display = 'none';
      }

      card.classList.add('show');
      lucide.createIcons();
    }

    // 目標を読み込み
    async function loadGoals() {
      try {
        const url = `${API_URL}?action=getGoals&studentId=${selectedStudentId}&grade=${selectedScheduleGrade}&month=${selectedScheduleMonth}`;
        const response = await fetch(url);
        const data = await response.json();

        const key = `${selectedScheduleGrade}_${selectedScheduleMonth}`;
        studentData.goals[key] = data.content || '';
      } catch (error) {
        console.error('Error loading goals:', error);
      }
    }

    // 講師指示を読み込み
    async function loadInstructorNotes() {
      try {
        const url = `${API_URL}?action=getInstructorNotes&studentId=${selectedStudentId}&grade=${selectedScheduleGrade}&month=${selectedScheduleMonth}`;
        const response = await fetch(url);
        const data = await response.json();

        studentData.instructorNotes = Array.isArray(data) ? data : [];
      } catch (error) {
        console.error('Error loading notes:', error);
        studentData.instructorNotes = [];
      }
    }

    // チェックリストを読み込み
    async function loadChecklist() {
      try {
        const url = `${API_URL}?action=getChecklistState&studentId=${selectedStudentId}`;
        console.log('Loading checklist:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Checklist response:', data);

        if (data && data.checkState) {
          studentData.checklist = {
            "高1": data.checkState["高1"] || [],
            "高2": data.checkState["高2"] || [],
            "高3": data.checkState["高3"] || []
          };
        } else if (data && (data["高1"] || data["高2"] || data["高3"])) {
          // checkStateがなく直接データが来る場合
          studentData.checklist = {
            "高1": data["高1"] || [],
            "高2": data["高2"] || [],
            "高3": data["高3"] || []
          };
        }
        console.log('Parsed checklist:', studentData.checklist);
      } catch (error) {
        console.error('Error loading checklist:', error);
      }
    }

    // 志望校を読み込み
    async function loadSchools() {
      try {
        const url = `${API_URL}?action=getSchoolData&studentId=${selectedStudentId}`;
        console.log('Loading schools:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('Schools response:', data);

        if (data) {
          studentData.schools = {
            A: data.A || [],
            B: data.B || [],
            C: data.C || [],
            D: data.D || []
          };
        }
        console.log('Parsed schools:', studentData.schools);
      } catch (error) {
        console.error('Error loading schools:', error);
      }
    }

    // タブ切り替え
    function switchTab(tabId) {
      // タブボタンの状態を更新
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // タブコンテンツの表示を切り替え
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    // スケジュール: 学年選択
    function selectScheduleGrade(grade) {
      selectedScheduleGrade = grade;

      document.querySelectorAll('.grade-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.grade === grade);
      });

      if (selectedStudentId) {
        refreshScheduleData();
      }
    }

    // スケジュール: 月選択
    function selectScheduleMonth(month) {
      selectedScheduleMonth = month;

      if (selectedStudentId) {
        refreshScheduleData();
      }
    }

    // スケジュールデータを更新
    async function refreshScheduleData() {
      if (!selectedStudentId) return;

      const btn = document.querySelector('.refresh-btn');
      btn.classList.add('loading');

      try {
        await Promise.all([loadGoals(), loadInstructorNotes()]);
        updateScheduleUI();
      } catch (error) {
        console.error('Error refreshing:', error);
      } finally {
        btn.classList.remove('loading');
      }
    }

    // スケジュールUIを更新
    function updateScheduleUI() {
      // パネルタイトル更新（学年 + 月）
      document.getElementById('goalsPanelTitle').innerHTML = `${selectedScheduleGrade}<span style="margin:0 8px;">／</span>${selectedScheduleMonth}月の目標`;
      document.getElementById('notesPanelTitle').innerHTML = `${selectedScheduleGrade}<span style="margin:0 8px;">／</span>${selectedScheduleMonth}月の指示`;

      // 目標を表示
      const key = `${selectedScheduleGrade}_${selectedScheduleMonth}`;
      const goals = studentData.goals[key] || '';
      const goalsText = document.getElementById('goalsText');
      const goalsEmpty = document.getElementById('goalsEmpty');

      if (goals) {
        goalsText.textContent = goals;
        goalsText.style.display = 'block';
        goalsEmpty.style.display = 'none';
      } else {
        goalsText.style.display = 'none';
        goalsEmpty.style.display = 'block';
      }

      // 講師指示を表示
      renderNotes();

      lucide.createIcons();
    }

    // 講師指示を描画
    function renderNotes() {
      const container = document.getElementById('notesList');
      const empty = document.getElementById('notesEmpty');
      const notes = studentData.instructorNotes;

      if (!notes || notes.length === 0) {
        container.innerHTML = '';
        container.appendChild(empty);
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      let html = '';
      notes.forEach((note, index) => {
        const completedClass = note.completed ? 'completed' : '';
        const checkedClass = note.completed ? 'checked' : '';

        html += `
          <div class="note-item ${completedClass}">
            <div class="note-checkbox ${checkedClass}" onclick="toggleNoteComplete(${index})">
              <i data-lucide="check" style="width:14px;height:14px;"></i>
            </div>
            <div class="note-content">
              <div class="note-text">${escapeHtml(note.text || '')}</div>
              ${note.deadline ? `<div class="note-deadline"><i data-lucide="clock" style="width:12px;height:12px;"></i>${note.deadline}</div>` : ''}
            </div>
            <div class="note-actions">
              <button class="note-action-btn" onclick="editNote(${index})">
                <i data-lucide="pencil" style="width:14px;height:14px;"></i>
              </button>
              <button class="note-action-btn delete" onclick="deleteNote(${index})">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // 目標編集モード切り替え
    function toggleGoalsEdit() {
      const display = document.getElementById('goalsDisplay');
      const edit = document.getElementById('goalsEdit');
      const btn = document.getElementById('goalsEditBtn');
      const textarea = document.getElementById('goalsTextarea');

      if (edit.style.display === 'none') {
        const key = `${selectedScheduleGrade}_${selectedScheduleMonth}`;
        textarea.value = studentData.goals[key] || '';
        display.style.display = 'none';
        edit.style.display = 'block';
        btn.innerHTML = '<i data-lucide="x" style="width:14px;height:14px;"></i>閉じる';
        textarea.focus();
      } else {
        display.style.display = 'block';
        edit.style.display = 'none';
        btn.innerHTML = '<i data-lucide="pencil" style="width:14px;height:14px;"></i>編集';
      }
      lucide.createIcons();
    }

    // 目標保存
    async function saveGoals() {
      const textarea = document.getElementById('goalsTextarea');
      const content = textarea.value.trim();

      try {
        const url = `${API_URL}?action=saveGoals&studentId=${selectedStudentId}&grade=${selectedScheduleGrade}&month=${selectedScheduleMonth}&content=${encodeURIComponent(content)}`;
        await fetch(url);

        const key = `${selectedScheduleGrade}_${selectedScheduleMonth}`;
        studentData.goals[key] = content;

        toggleGoalsEdit();
        updateScheduleUI();
      } catch (error) {
        console.error('Error saving goals:', error);
        alert('保存に失敗しました');
      }
    }

    // 目標編集キャンセル
    function cancelGoalsEdit() {
      toggleGoalsEdit();
    }

    // 講師指示モーダルを開く
    function openNoteModal() {
      editingNoteId = null;
      document.getElementById('noteText').value = '';
      document.getElementById('noteDeadline').value = '';
      document.querySelector('#noteModal .modal-title').innerHTML = '<i data-lucide="plus-circle" style="width:20px;height:20px;"></i>講師の指示を追加';
      document.getElementById('noteModal').classList.add('show');
      lucide.createIcons();
    }

    // 講師指示モーダルを閉じる
    function closeNoteModal() {
      document.getElementById('noteModal').classList.remove('show');
      editingNoteId = null;
    }

    // 講師指示を保存
    async function saveNote() {
      const text = document.getElementById('noteText').value.trim();
      const deadline = document.getElementById('noteDeadline').value;

      if (!text) {
        alert('指示内容を入力してください');
        return;
      }

      try {
        showLoading(true);

        let url;
        if (editingNoteId !== null) {
          url = `${API_URL}?action=updateInstructorNote&noteId=${encodeURIComponent(editingNoteId)}&text=${encodeURIComponent(text)}&deadline=${encodeURIComponent(deadline)}&completed=false`;
        } else {
          url = `${API_URL}?action=saveInstructorNote&studentId=${selectedStudentId}&grade=${encodeURIComponent(selectedScheduleGrade)}&month=${encodeURIComponent(selectedScheduleMonth)}&text=${encodeURIComponent(text)}&deadline=${encodeURIComponent(deadline)}`;
        }

        await fetch(url);

        closeNoteModal();
        await loadInstructorNotes();
        renderNotes();

      } catch (error) {
        console.error('Error saving note:', error);
        alert('保存に失敗しました');
      } finally {
        showLoading(false);
      }
    }

    // 講師指示を編集
    function editNote(index) {
      const note = studentData.instructorNotes[index];
      if (!note) return;

      editingNoteId = note.id;
      document.getElementById('noteText').value = note.text || '';
      document.getElementById('noteDeadline').value = '';
      document.querySelector('#noteModal .modal-title').innerHTML = '<i data-lucide="pencil" style="width:20px;height:20px;"></i>講師の指示を編集';
      document.getElementById('noteModal').classList.add('show');
      lucide.createIcons();
    }

    // 講師指示を削除
    async function deleteNote(index) {
      const note = studentData.instructorNotes[index];
      if (!note || !note.id) return;

      if (!confirm('この指示を削除しますか？')) return;

      try {
        showLoading(true);
        await fetch(`${API_URL}?action=deleteInstructorNote&noteId=${encodeURIComponent(note.id)}`);
        await loadInstructorNotes();
        renderNotes();
      } catch (error) {
        console.error('Error deleting note:', error);
        alert('削除に失敗しました');
      } finally {
        showLoading(false);
      }
    }

    // 講師指示の完了状態を切り替え
    async function toggleNoteComplete(index) {
      const note = studentData.instructorNotes[index];
      if (!note || !note.id) return;

      try {
        const newCompleted = !note.completed;
        await fetch(`${API_URL}?action=updateInstructorNote&noteId=${encodeURIComponent(note.id)}&text=${encodeURIComponent(note.text)}&deadline=${encodeURIComponent(note.deadline || '')}&completed=${newCompleted}`);

        note.completed = newCompleted;
        renderNotes();
      } catch (error) {
        console.error('Error toggling note:', error);
      }
    }

    // チェックリスト: 学年選択
    function selectChecklistGrade(grade) {
      selectedChecklistGrade = grade;

      document.querySelectorAll('.checklist-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.grade === grade);
      });

      renderChecklist();
    }

    // チェックリストを描画
    function renderChecklist() {
      const container = document.getElementById('checklistItems');
      if (!container) return;

      const items = checklistData[selectedChecklistGrade] || [];
      const checked = studentData.checklist[selectedChecklistGrade] || [];

      let html = '';
      items.forEach((item, index) => {
        const isChecked = checked.includes(index);
        html += `
          <div class="checklist-item ${isChecked ? 'checked' : ''}">
            <div class="checklist-checkbox">
              <i data-lucide="check" style="width:14px;height:14px;"></i>
            </div>
            <div class="checklist-text">
              <span class="checklist-number">${index + 1}.</span>
              ${escapeHtml(item)}
            </div>
          </div>
        `;
      });

      container.innerHTML = html || '<p style="color:#999;text-align:center;padding:20px;">項目がありません</p>';
      updateProgressDisplay();
      lucide.createIcons();
    }

    // 進捗表示を更新
    function updateProgressDisplay() {
      // updateTotalProgress に統合したので、そちらを呼び出す
      updateTotalProgress();
    }

    // 志望校: パターン選択
    function selectPattern(pattern) {
      selectedPattern = pattern;

      document.querySelectorAll('.pattern-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.pattern === pattern);
      });

      document.getElementById('patternDescText').textContent = patternDescriptions[pattern];

      renderSchools();
      lucide.createIcons();
    }

    // 志望校を描画
    function renderSchools() {
      const container = document.getElementById('schoolList');
      const schools = studentData.schools[selectedPattern] || [];

      if (!container) {
        console.warn('School container not found');
        return;
      }

      if (schools.length === 0) {
        container.innerHTML = `
      <div class="schools-empty">
        <i data-lucide="school" style="width:48px;height:48px;"></i>
        <p>志望校が登録されていません</p>
      </div>
    `;
        lucide.createIcons();
        return;
      }

      let html = '';
      schools.forEach((school, index) => {
        // 試験内容の項目をカウント
        const examItems = [
          { key: 'essay', label: '小論文' },
          { key: 'interview', label: '面接' },
          { key: 'oral', label: '口頭試問' },
          { key: 'groupDiscussion', label: 'GD' },
          { key: 'englishInterview', label: '英語面接' },
          { key: 'present', label: 'プレゼン' },
          { key: 'secondExam', label: '二次試験' },
          { key: 'material', label: '資料作成' },
          { key: 'video', label: '動画資料' }
        ];
        const examYesCount = examItems.filter(item => school[item.key] === 'あり').length;

        html += `
      <div class="school-card">
        <!-- ヘッダー -->
        <div class="school-header">
          <div class="school-header-top">
            <span class="school-rank">第${index + 1}志望</span>
            <div class="school-badges">
              ${school.applicationType ? `<span class="school-badge ${school.applicationType === '専願' ? 'sengan' : 'heigan'}">${escapeHtml(school.applicationType)}</span>` : ''}
              ${school.examType ? `<span class="school-badge method">${escapeHtml(school.examType)}</span>` : ''}
            </div>
          </div>
          <div class="school-name">${escapeHtml(school.universityName)}</div>
          <div class="school-faculty">${escapeHtml(school.faculty)}${school.department ? ' ' + escapeHtml(school.department) : ''}</div>
        </div>

        <!-- 主要情報 -->
        <div class="school-main-info">
          <div class="school-info-item">
            <div class="school-info-icon english">
              <i data-lucide="globe" style="width:18px;height:18px;"></i>
            </div>
            <div class="school-info-content">
              <span class="school-info-label">英語資格</span>
              <span class="school-info-value">${escapeHtml(school.englishReq) || '指定なし'}</span>
            </div>
          </div>
          <div class="school-info-item">
            <div class="school-info-icon gpa">
              <i data-lucide="star" style="width:18px;height:18px;"></i>
            </div>
            <div class="school-info-content">
              <span class="school-info-label">評定条件</span>
              <span class="school-info-value">${escapeHtml(school.gpaReq) || '指定なし'}</span>
            </div>
          </div>
          <div class="school-info-item">
            <div class="school-info-icon date">
              <i data-lucide="calendar" style="width:18px;height:18px;"></i>
            </div>
            <div class="school-info-content">
              <span class="school-info-label">入試日程</span>
              <span class="school-info-value highlight">${escapeHtml(school.examDate) || '未定'}</span>
            </div>
          </div>
          <div class="school-info-item">
            <div class="school-info-icon region">
              <i data-lucide="map-pin" style="width:18px;height:18px;"></i>
            </div>
            <div class="school-info-content">
              <span class="school-info-label">地域</span>
              <span class="school-info-value">${escapeHtml(school.region) || '-'}</span>
            </div>
          </div>
        </div>

        <!-- 試験内容アコーディオン -->
        <div class="school-accordion">
          <div class="school-accordion-header" onclick="toggleSchoolAccordion(this)">
            <div class="school-accordion-icon">
              <i data-lucide="chevron-down" style="width:14px;height:14px;"></i>
            </div>
            <span class="school-accordion-title">試験内容</span>
            <span class="accordion-count">${examYesCount}項目</span>
          </div>
          <div class="school-accordion-body">
            <div class="exam-grid">
              ${examItems.map(item => {
          const isYes = school[item.key] === 'あり';
          return `
                  <div class="exam-item ${isYes ? 'yes' : 'no'}">
                    <i data-lucide="${isYes ? 'check' : 'x'}" style="width:14px;height:14px;"></i>
                    ${item.label}
                  </div>
                `;
        }).join('')}
            </div>
          </div>
        </div>

        <!-- 出願書類アコーディオン -->
        <div class="school-accordion">
          <div class="school-accordion-header" onclick="toggleSchoolAccordion(this)">
            <div class="school-accordion-icon">
              <i data-lucide="chevron-down" style="width:14px;height:14px;"></i>
            </div>
            <span class="school-accordion-title">出願書類・要件</span>
          </div>
          <div class="school-accordion-body">
            ${school.documents ? `<div class="documents-text">${escapeHtml(school.documents)}</div>` : '<p style="color:#999;">書類情報なし</p>'}
            <div class="requirements-grid">
              <div class="requirement-item">
                <div class="requirement-label">推薦状</div>
                <div class="requirement-value">${escapeHtml(school.recommendation) || '-'}</div>
              </div>
              <div class="requirement-item">
                <div class="requirement-label">英語証明</div>
                <div class="requirement-value">${escapeHtml(school.englishCert) || '-'}</div>
              </div>
              <div class="requirement-item">
                <div class="requirement-label">賞状等</div>
                <div class="requirement-value">${escapeHtml(school.awards) || '-'}</div>
              </div>
              <div class="requirement-item">
                <div class="requirement-label">締切扱い</div>
                <div class="requirement-value">${escapeHtml(school.deadlineType) || '-'}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 日程・データアコーディオン -->
        <div class="school-accordion">
          <div class="school-accordion-header" onclick="toggleSchoolAccordion(this)">
            <div class="school-accordion-icon">
              <i data-lucide="chevron-down" style="width:14px;height:14px;"></i>
            </div>
            <span class="school-accordion-title">日程・データ</span>
          </div>
          <div class="school-accordion-body">
            <div class="data-grid">
              ${school.firstResultDate ? `
              <div class="data-item">
                <div class="data-label">一次合格発表</div>
                <div class="data-value">${escapeHtml(school.firstResultDate)}</div>
              </div>
              ` : ''}
              ${school.secondApplicationPeriod ? `
              <div class="data-item">
                <div class="data-label">二次出願期間</div>
                <div class="data-value">${escapeHtml(school.secondApplicationPeriod)}</div>
              </div>
              ` : ''}
              ${school.deviation ? `
              <div class="data-item">
                <div class="data-label">偏差値</div>
                <div class="data-value">${escapeHtml(school.deviation)}</div>
              </div>
              ` : ''}
              ${school.ratio ? `
              <div class="data-item">
                <div class="data-label">倍率</div>
                <div class="data-value">${escapeHtml(school.ratio)}倍</div>
              </div>
              ` : ''}
              ${school.applicants ? `
              <div class="data-item">
                <div class="data-label">志願者数</div>
                <div class="data-value">${escapeHtml(school.applicants)}人</div>
              </div>
              ` : ''}
            </div>
            ${school.notes ? `
            <div class="notes-section">
              <div class="notes-label">備考</div>
              <div class="notes-text">${escapeHtml(school.notes)}</div>
            </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // ローディング表示
    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    // HTMLエスケープ
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    // ===== 授業履歴機能 =====
    let lessonHistoryData = [];
    let lessonDisplayCount = 5;

    // 授業履歴を読み込み
    async function loadLessonHistory() {
      if (!selectedStudentId) return;

      const container = document.getElementById('lessonList');
      const empty = document.getElementById('lessonEmpty');

      container.innerHTML = `
    <div style="text-align:center;padding:40px;">
      <div class="loading-spinner" style="margin:0 auto 16px;"></div>
      <p style="color:#888;">読み込み中...</p>
    </div>
  `;

      try {
        const url = `${ENROLLMENT_API_URL}?action=getStudentHistory&studentId=${encodeURIComponent(selectedStudentId)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          lessonHistoryData = result.data || [];
          lessonDisplayCount = 5;
          renderLessonHistory();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('履歴取得エラー:', error);
        container.innerHTML = '';
        empty.innerHTML = `
      <i data-lucide="alert-circle" style="width:48px;height:48px;"></i>
      <p>履歴を取得できませんでした</p>
    `;
        empty.style.display = 'block';
        lucide.createIcons();
      }
    }
    // ===== 生徒プロフィール機能 =====

    // プロフィールを読み込み
    async function loadStudentProfile() {
      if (!selectedStudentId) return;

      try {
        const url = `${PROFILE_API_URL}?action=getProfile&studentId=${selectedStudentId}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success && result.profile) {
          studentProfileData = result.profile;
          renderStudentProfile();
          // プロフィールトグルを表示
          document.querySelector('.profile-toggle').style.display = 'flex';
        } else {
          studentProfileData = null;
          // プロフィールがない場合はトグルを非表示
          document.querySelector('.profile-toggle').style.display = 'none';
        }
      } catch (error) {
        console.error('プロフィール取得エラー:', error);
        studentProfileData = null;
        document.querySelector('.profile-toggle').style.display = 'none';
      }
    }

    // プロフィールを描画
    function renderStudentProfile() {
      const container = document.getElementById('profileContent');

      if (!studentProfileData) {
        container.innerHTML = `
      <div class="profile-empty">
        <i data-lucide="user-x" style="width:48px;height:48px;"></i>
        <p>プロフィールが登録されていません</p>
      </div>
    `;
        lucide.createIcons();
        return;
      }

      const p = studentProfileData;

      // 配列データの処理（文字列の場合はカンマ区切りで分割、配列ならそのまま使用）
      const personalities = Array.isArray(p.personality)
        ? p.personality.filter(s => s)
        : (p.personality ? p.personality.split(',').map(s => s.trim()).filter(s => s) : []);

      const teachingStyles = Array.isArray(p.teachingStyle)
        ? p.teachingStyle.filter(s => s)
        : (p.teachingStyle ? p.teachingStyle.split(',').map(s => s.trim()).filter(s => s) : []);

      const constraints = Array.isArray(p.constraints)
        ? p.constraints.filter(s => s)
        : (p.constraints ? p.constraints.split(',').map(s => s.trim()).filter(s => s) : []);

      let html = `
    <!-- 基本情報 -->
    <div class="profile-section">
      <div class="profile-section-title">
        <i data-lucide="info" style="width:14px;height:14px;"></i>
        基本情報
      </div>
      <div class="profile-item">
        <span class="profile-item-label">学年</span>
        <span class="profile-item-value">${escapeHtml(p.grade) || '-'}</span>
      </div>
      <div class="profile-item">
        <span class="profile-item-label">高校名</span>
        <span class="profile-item-value">${escapeHtml(p.school) || '-'}</span>
      </div>
      <div class="profile-item">
        <span class="profile-item-label">志望系統</span>
        <span class="profile-item-value">${escapeHtml(p.major) || '-'}</span>
      </div>
      <div class="profile-item">
        <span class="profile-item-label">英語資格</span>
        <span class="profile-item-value">${escapeHtml(p.english) || '-'}</span>
      </div>
    </div>

    <!-- 部活動 -->
    <div class="profile-section">
      <div class="profile-section-title">
        <i data-lucide="trophy" style="width:14px;height:14px;"></i>
        部活動
      </div>
      <div class="profile-item">
        <span class="profile-item-label">部活動</span>
        <span class="profile-item-value">${escapeHtml(p.club) || '-'}</span>
      </div>
      <div class="profile-item">
        <span class="profile-item-label">活動量</span>
        <span class="profile-item-value">${escapeHtml(p.clubLevel) || '-'}</span>
      </div>
    </div>

    <!-- 性格タイプ -->
    <div class="profile-section">
      <div class="profile-section-title">
        <i data-lucide="smile" style="width:14px;height:14px;"></i>
        性格タイプ
      </div>
      ${personalities.length > 0 ? `
        <div class="profile-tags">
          ${personalities.map(t => `<span class="profile-tag personality">${escapeHtml(t)}</span>`).join('')}
        </div>
      ` : '<span class="profile-item-value">-</span>'}
    </div>

    <!-- 指導希望 -->
    <div class="profile-section">
      <div class="profile-section-title">
        <i data-lucide="message-circle" style="width:14px;height:14px;"></i>
        指導希望
      </div>
      ${teachingStyles.length > 0 ? `
        <div class="profile-tags">
          ${teachingStyles.map(t => `<span class="profile-tag teaching">${escapeHtml(t)}</span>`).join('')}
        </div>
      ` : '<span class="profile-item-value">-</span>'}
    </div>

    <!-- 生活制約 -->
    <div class="profile-section">
      <div class="profile-section-title">
        <i data-lucide="alert-circle" style="width:14px;height:14px;"></i>
        生活制約
      </div>
      ${constraints.length > 0 ? `
        <div class="profile-tags">
          ${constraints.map(t => `<span class="profile-tag constraint">${escapeHtml(t)}</span>`).join('')}
        </div>
      ` : '<span class="profile-item-value">-</span>'}
    </div>
  `;

      // 備考がある場合
      if (p.notes && p.notes.trim()) {
        html += `
      <div class="profile-notes" style="grid-column: 1 / -1;">
        <div class="profile-notes-label">備考・メモ</div>
        <div class="profile-notes-text">${escapeHtml(p.notes)}</div>
      </div>
    `;
      }

      container.innerHTML = html;
      lucide.createIcons();
    }

    // プロフィールアコーディオン開閉
    function toggleProfileAccordion() {
      const card = document.getElementById('studentInfoCard');
      const toggleAction = document.getElementById('profileToggleAction');

      card.classList.toggle('profile-open');

      // トグルテキストを変更
      const isOpen = card.classList.contains('profile-open');
      toggleAction.innerHTML = isOpen
        ? '<span>閉じる</span><i data-lucide="chevron-down" style="width:16px;height:16px;"></i>'
        : '<span>開く</span><i data-lucide="chevron-down" style="width:16px;height:16px;"></i>';

      lucide.createIcons();
    }

    // 授業履歴を描画
    function renderLessonHistory() {
      const container = document.getElementById('lessonList');
      const loadMoreBtn = document.getElementById('loadMoreLessons');

      if (!container) return;

      if (lessonHistoryData.length === 0) {
        container.innerHTML = `
      <div class="empty-state">
        <i data-lucide="inbox" style="width:48px;height:48px;"></i>
        <p>授業履歴がありません</p>
      </div>
    `;
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        lucide.createIcons();
        return;
      }

      const displayData = lessonHistoryData.slice(0, lessonDisplayCount);

      let html = '';
      displayData.forEach(item => {
        // 取り組み内容をタグとして表示
        let stepsHtml = '';
        if (item.steps) {
          const stepsArray = item.steps.split(',').map(s => s.trim()).filter(s => s);
          stepsHtml = stepsArray.map(step => `<span class="step-tag">${escapeHtml(step)}</span>`).join('');
        }

        // 詳細データがあるかチェック
        const hasContent = item.steps || item.homework || item.futurePlan || item.message;

        html += `
    <div class="lesson-item">
      <div class="lesson-header" onclick="toggleLesson(this)">
        <div class="lesson-toggle">
          <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
        </div>
        <div class="lesson-date-wrapper">
          <div class="lesson-date">
            <i data-lucide="calendar" style="width:16px;height:16px;"></i>
            ${escapeHtml(item.lessonDate || '-')}
          </div>
          <div class="lesson-weekday">${escapeHtml(item.lessonTime || '')}</div>
        </div>
        <div class="lesson-teacher">
          <i data-lucide="user" style="width:14px;height:14px;"></i>
          ${escapeHtml(item.teacherName || '-')}
        </div>
      </div>
      <div class="lesson-body">
        ${hasContent ? `
          ${stepsHtml ? `
          <div class="lesson-section">
            <div class="lesson-section-title">
              <i data-lucide="check-circle" style="width:14px;height:14px;"></i>
              取り組み内容
            </div>
            <div class="lesson-section-content steps">${stepsHtml}</div>
          </div>
          ` : ''}
          
          ${item.homework ? `
          <div class="lesson-section">
            <div class="lesson-section-title">
              <i data-lucide="clipboard" style="width:14px;height:14px;"></i>
              宿題
            </div>
            <div class="lesson-section-content">${escapeHtml(item.homework)}</div>
          </div>
          ` : ''}
          
          ${item.futurePlan ? `
          <div class="lesson-section">
            <div class="lesson-section-title">
              <i data-lucide="calendar" style="width:14px;height:14px;"></i>
              今後の予定
            </div>
            <div class="lesson-section-content">${escapeHtml(item.futurePlan)}</div>
          </div>
          ` : ''}
          
          ${item.message ? `
          <div class="lesson-section">
            <div class="lesson-section-title">
              <i data-lucide="message-circle" style="width:14px;height:14px;"></i>
              次回への伝達
            </div>
            <div class="lesson-section-content">${escapeHtml(item.message)}</div>
          </div>
          ` : ''}
        ` : `
          <div class="lesson-section">
            <div class="lesson-section-content" style="color: #aaa; font-style: italic; padding: 20px; text-align: center;">
              詳細データなし（旧システム）
            </div>
          </div>
        `}
      </div>
    </div>
  `;
      });

      container.innerHTML = html;

      // もっと見るボタン
      if (loadMoreBtn) {
        if (lessonHistoryData.length > lessonDisplayCount) {
          const remaining = lessonHistoryData.length - lessonDisplayCount;
          loadMoreBtn.textContent = `さらに表示（残り${remaining}件）`;
          loadMoreBtn.style.display = 'block';
        } else {
          loadMoreBtn.style.display = 'none';
        }
      }

      lucide.createIcons();
    }

    // もっと読み込む
    function loadMoreLessons() {
      lessonDisplayCount += 5;
      renderLessonHistory();
    }

    // アコーディオン開閉
    function toggleLesson(header) {
      const item = header.closest('.lesson-item');
      item.classList.toggle('open');
      lucide.createIcons();
    }

    // 志望校アコーディオン開閉
    function toggleSchoolAccordion(header) {
      header.classList.toggle('open');
      lucide.createIcons();
    }

    // 各自のスケジュールへ移動確認
    function confirmNavigateToSchedule() {
      if (confirm('各自のスケジュールページに移動します。よろしいですか？')) {
        location.href = 'my-schedule.html';
      }
    }

    // ========================================
    // 旧チェックリスト機能
    // ========================================

    let oldChecklistMaster = null;
    let oldChecklistState = {};

    // 大カテゴリのアイコン設定
    const OLD_PARENT_ICONS = {
      '基礎理解・マインドセット': { icon: 'lightbulb', color: 'blue' },
      '自己分析・研究テーマ': { icon: 'brain', color: 'cyan' },
      '書類作成': { icon: 'file-edit', color: 'purple' },
      '出願・試験当日': { icon: 'send', color: 'amber' },
      '小論文対策': { icon: 'file-text', color: 'orange' },
      '面接対策': { icon: 'mic', color: 'green' },
      'レポート作成': { icon: 'clipboard', color: 'pink' },
      'プレゼンテーション・GD対策': { icon: 'presentation', color: 'red' },
      '志望校・併願校戦略': { icon: 'school', color: 'indigo' },
      '日常学習・保護者向け': { icon: 'users', color: 'brown' },
      'default': { icon: 'list', color: 'gray' }
    };

    // 旧チェックリストを読み込み
    async function loadOldChecklist() {
      if (!selectedStudentId) {
        return; // エラーを出さずに終了
      }

      try {
        // マスターデータを取得（キャッシュがなければ）
        if (!oldChecklistMaster) {
          const masterRes = await fetch('checklist_master.json?t=' + Date.now());
          if (!masterRes.ok) {
            console.error('checklist_master.json の読み込みに失敗');
            return;
          }
          oldChecklistMaster = await masterRes.json();
        }

        // 生徒のチェック状態を取得
        const stateRes = await fetch(`${API_URL}?action=getChecklistStateOld&studentId=${selectedStudentId}`);
        const stateData = await stateRes.json();

        if (stateData.success) {
          oldChecklistState = stateData.checkState || {};
        } else {
          oldChecklistState = {};
        }

        // UIを描画
        renderOldChecklist();

        // DOM要素が存在するか確認してから表示
        const summaryEl = document.getElementById('oldChecklistSummary');
        const emptyEl = document.getElementById('oldChecklistEmpty');

        if (summaryEl) summaryEl.style.display = 'flex';
        if (emptyEl) emptyEl.style.display = 'none';

      } catch (error) {
        console.error('Error loading old checklist:', error);
      }
    }

    // 旧チェックリストを描画
    function renderOldChecklist() {
      if (!oldChecklistMaster) return;

      // 大カテゴリごとに集計
      const parentMap = {};
      let totalItems = 0;
      let totalChecked = 0;

      for (const categoryName in oldChecklistMaster) {
        const categoryData = oldChecklistMaster[categoryName];
        const items = categoryData.items || [];
        const parent = categoryData.parent || '未分類';
        const categoryState = oldChecklistState[categoryName] || {};

        if (!parentMap[parent]) {
          parentMap[parent] = {
            name: parent,
            categories: [],
            totalItems: 0,
            checkedItems: 0
          };
        }

        let checked = 0;
        items.forEach(item => {
          if (categoryState[item.no]) {
            checked++;
          }
        });

        totalItems += items.length;
        totalChecked += checked;
        parentMap[parent].totalItems += items.length;
        parentMap[parent].checkedItems += checked;

        const percent = items.length > 0 ? Math.round((checked / items.length) * 100) : 0;

        parentMap[parent].categories.push({
          name: categoryName,
          items: items,
          checked: checked,
          total: items.length,
          percent: percent
        });
      }

      // 全体進捗を更新
      const totalPercent = totalItems > 0 ? Math.round((totalChecked / totalItems) * 100) : 0;
      document.getElementById('oldChecklistCircle').style.setProperty('--progress', totalPercent);
      document.getElementById('oldChecklistPercent').textContent = totalPercent + '%';

      // カテゴリ状況を計算
      let completedCategories = 0;
      let inProgressCategories = 0;
      let notStartedCategories = 0;
      let totalCategories = 0;

      for (const parent in parentMap) {
        parentMap[parent].categories.forEach(cat => {
          totalCategories++;
          if (cat.percent >= 100) {
            completedCategories++;
          } else if (cat.percent > 0) {
            inProgressCategories++;
          } else {
            notStartedCategories++;
          }
        });
        parentMap[parent].percent = parentMap[parent].totalItems > 0
          ? Math.round((parentMap[parent].checkedItems / parentMap[parent].totalItems) * 100)
          : 0;
      }

      // 全体進捗を更新
      document.getElementById('oldChecklistCompleted').textContent = completedCategories;
      document.getElementById('oldChecklistTotal').textContent = totalCategories;
      document.getElementById('oldChecklistItems').textContent = totalChecked;
      document.getElementById('oldChecklistItemsTotal').textContent = totalItems;

      // カテゴリ状況を更新
      document.getElementById('oldStatusCompleted').textContent = completedCategories;
      document.getElementById('oldStatusInProgress').textContent = inProgressCategories;
      document.getElementById('oldStatusNotStarted').textContent = notStartedCategories;

      // 大カテゴリを描画
      const container = document.getElementById('oldChecklistAccordion');
      let html = '';

      for (const parentName in parentMap) {
        const parent = parentMap[parentName];
        const iconConfig = OLD_PARENT_ICONS[parentName] || OLD_PARENT_ICONS['default'];
        const fillClass = getFillClass(parent.percent);

        html += `
          <div class="old-parent-item" data-parent="${escapeHtml(parentName)}">
            <div class="old-parent-header" onclick="toggleOldParent(this)">
              <div class="old-parent-icon ${iconConfig.color}">
                <i data-lucide="${iconConfig.icon}" style="width:20px;height:20px;"></i>
              </div>
              <div class="old-parent-info">
                <div class="old-parent-name">${escapeHtml(parentName)}</div>
                <div class="old-parent-meta">${parent.categories.filter(c => c.percent >= 100).length}/${parent.categories.length} カテゴリ完了</div>
              </div>
              <div class="old-parent-progress">
                <div class="old-parent-progress-bar">
                  <div class="old-parent-progress-fill ${fillClass}" style="width:${parent.percent}%"></div>
                </div>
                <span class="old-parent-percent">${parent.percent}%</span>
              </div>
              <i data-lucide="chevron-down" class="old-parent-arrow" style="width:20px;height:20px;"></i>
            </div>
            <div class="old-parent-content">
              ${renderOldCategories(parent.categories)}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
      lucide.createIcons();
    }

    // 中カテゴリを描画
    function renderOldCategories(categories) {
      let html = '';

      categories.forEach((cat, index) => {
        const fillClass = getFillClass(cat.percent);
        const isCompleted = cat.percent >= 100;

        html += `
          <div class="old-category-card ${isCompleted ? 'completed' : ''}" onclick="toggleOldItems(this, '${escapeHtml(cat.name)}')">
            <div class="old-category-check">
              <i data-lucide="${isCompleted ? 'check' : 'circle'}" style="width:14px;height:14px;"></i>
            </div>
            <div class="old-category-info">
              <div class="old-category-name">${escapeHtml(cat.name)}</div>
              <div class="old-category-count">${cat.checked}/${cat.total} 項目完了</div>
            </div>
            <div class="old-category-progress">
              <div class="old-category-progress-bar">
                <div class="old-category-progress-fill ${fillClass}" style="width:${cat.percent}%"></div>
              </div>
              <span class="old-category-percent">${cat.percent}%</span>
            </div>
          </div>
          <div class="old-items-panel" id="oldItems_${index}">
            ${renderOldItems(cat.name, cat.items)}
          </div>
        `;
      });

      return html;
    }

    // 項目を描画
    function renderOldItems(categoryName, items) {
      const categoryState = oldChecklistState[categoryName] || {};
      let html = '';

      items.forEach(item => {
        const isChecked = categoryState[item.no] === true;
        html += `
          <div class="old-item-row ${isChecked ? 'checked' : ''}">
            <div class="old-item-checkbox">
              <i data-lucide="check" style="width:12px;height:12px;"></i>
            </div>
            <div class="old-item-text">${escapeHtml(item.name)}</div>
          </div>
        `;
      });

      return html;
    }

    // 進捗バーのクラスを取得
    function getFillClass(percent) {
      if (percent >= 100) return 'complete';
      if (percent >= 70) return 'high';
      if (percent >= 30) return 'mid';
      return 'low';
    }

    // 大カテゴリの開閉
    function toggleOldParent(header) {
      const item = header.closest('.old-parent-item');
      item.classList.toggle('open');
      lucide.createIcons();
    }

    // 中カテゴリの項目表示切り替え
    function toggleOldItems(card, categoryName) {
      const panel = card.nextElementSibling;
      if (panel && panel.classList.contains('old-items-panel')) {
        panel.classList.toggle('show');
        lucide.createIcons();
      }
    }

    // 総合進捗の折りたたみ開閉
    function toggleProgressAccordion(header, grade) {
      header.classList.toggle('open');

      const gradeNum = grade.replace('高', '');
      const body = document.getElementById('progressAccordion' + gradeNum);

      if (body.style.display === 'none') {
        body.style.display = 'block';
        renderProgressCheckedList(grade);
      } else {
        body.style.display = 'none';
      }

      lucide.createIcons();
    }

    // チェックリスト全項目を描画（チェック状態付き）
    function renderProgressCheckedList(grade) {
      const gradeNum = grade.replace('高', '');
      const container = document.getElementById('progressCheckedList' + gradeNum);

      if (!container) return;

      const checkedIndexes = studentData.checklist[grade] || [];
      const items = checklistData[grade] || [];

      if (items.length === 0) {
        container.innerHTML = '<div class="progress-checked-empty">項目がありません</div>';
        return;
      }

      let html = '';
      items.forEach((itemText, index) => {
        const isChecked = checkedIndexes.includes(index);
        html += `
          <div class="progress-checklist-item ${isChecked ? 'checked' : ''}">
            <div class="progress-checklist-checkbox">
              <i data-lucide="check" style="width:14px;height:14px;"></i>
            </div>
            <span class="progress-checklist-text">${index + 1}. ${escapeHtml(itemText)}</span>
          </div>
        `;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // 総合進捗更新
    function updateTotalProgress() {
      const count1 = (studentData.checklist["高1"] || []).length;
      const count2 = (studentData.checklist["高2"] || []).length;
      const count3 = (studentData.checklist["高3"] || []).length;
      const total = 109;
      const totalChecked = count1 + count2 + count3;
      const percent = Math.round((totalChecked / total) * 100);

      // 進捗バー更新
      const barMini = document.getElementById('totalProgressBarMini');
      const percentMini = document.getElementById('totalProgressPercentMini');
      if (barMini) barMini.style.width = percent + '%';
      if (percentMini) percentMini.textContent = percent + '%';

      // 各学年の数値更新
      const mini1 = document.getElementById('progressMini1');
      const mini2 = document.getElementById('progressMini2');
      const mini3 = document.getElementById('progressMini3');
      if (mini1) mini1.textContent = count1;
      if (mini2) mini2.textContent = count2;
      if (mini3) mini3.textContent = count3;
    }

    // ========================================
    // 授業書類機能
    // ========================================

    let selectedThemeId = null;
    let currentQuestionIndex = 1;

    // 授業書類データ
    let materialsData = {
      inputProgress: { checked: 0, total: 31 },
      quizResult: null,
      outputAnswers: {},
      teacherComments: {}
    };

    // テーマ2のアウトプット質問データ（50問）
    const theme2OutputQuestions = [
      { id: 1, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "長く続けている趣味、または今ハマっていることはありますか？" },
      { id: 2, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "本を読むのは好きですか？" },
      { id: 3, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "どんなジャンルの本をよく読みますか？" },
      { id: 4, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "なぜ、その本・ジャンルが好きなのだと思いますか？" },
      { id: 5, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "漫画・アニメ・ゲーム・映画・音楽などで、強く影響を受けたものはありますか？" },
      { id: 6, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "「時間を忘れて没頭してしまうこと」は何ですか？" },
      { id: 7, category: "Ⅰ．興味・関心・好きなことの棚卸し", question: "気づいたら調べてしまう分野はありますか？" },
      { id: 8, category: "Ⅱ．心が動いた経験（原体験・感情）", question: "過去を振り返って、強く心が動いた経験はありますか？" },
      { id: 9, category: "Ⅱ．心が動いた経験（原体験・感情）", question: "その出来事は、今でも少し心に残っていますか？なぜ忘れていないのだと思いますか？" },
      { id: 10, category: "Ⅱ．心が動いた経験（原体験・感情）", question: "過去のトラウマ的な経験はありますか？" },
      { id: 11, category: "Ⅱ．心が動いた経験（原体験・感情）", question: "その経験は、あなたの考え方や行動にどんな影響を与えていますか？" },
      { id: 12, category: "Ⅱ．心が動いた経験（原体験・感情）", question: "「おかしい」「納得できない」と強く感じた出来事はありますか？" },
      { id: 13, category: "Ⅲ．性格・強み・弱みの理解", question: "周囲の人から、どのような性格だと言われることが多いですか？" },
      { id: 14, category: "Ⅲ．性格・強み・弱みの理解", question: "自分では、自分をどのような性格だと思いますか？" },
      { id: 15, category: "Ⅲ．性格・強み・弱みの理解", question: "自分の長所だと思う点を、具体例とともに挙げてください。" },
      { id: 16, category: "Ⅲ．性格・強み・弱みの理解", question: "逆に、短所・苦手な点は何だと思いますか？" },
      { id: 17, category: "Ⅲ．性格・強み・弱みの理解", question: "周囲と比べて「ここは優れている」「ここは明らかに違う」と感じる点はありますか？" },
      { id: 18, category: "Ⅲ．性格・強み・弱みの理解", question: "失敗したとき、あなたはどう立て直すタイプですか？" },
      { id: 19, category: "Ⅳ．環境・バックグラウンド", question: "家庭環境で、周囲と異なる点はありますか？" },
      { id: 20, category: "Ⅳ．環境・バックグラウンド", question: "「自分だからこそ語れる」と思える背景はありますか？" },
      { id: 21, category: "Ⅳ．環境・バックグラウンド", question: "家族・身近な人の生き方で、影響を受けたものはありますか？" },
      { id: 22, category: "Ⅳ．環境・バックグラウンド", question: "身の回りで起きた、大きな出来事（事故・病気・別れ・感動）はありますか？" },
      { id: 23, category: "Ⅴ．活動経験・評価された経験", question: "これまでの活動で、社会的に評価された経験はありますか？" },
      { id: 24, category: "Ⅴ．活動経験・評価された経験", question: "結果が出なかったが、強く印象に残っている活動はありますか？" },
      { id: 25, category: "Ⅴ．活動経験・評価された経験", question: "学校の総合探究で取り組んでいる（取り組んだ）テーマは何ですか？" },
      { id: 26, category: "Ⅴ．活動経験・評価された経験", question: "そのテーマを選んだ理由は何ですか？" },
      { id: 27, category: "Ⅴ．活動経験・評価された経験", question: "活動を通して、自分の限界を感じた経験はありますか？" },
      { id: 28, category: "Ⅵ．社会への問題意識", question: "ニュース・新聞・テレビを見ていて、強い違和感や怒りを覚えた問題はありますか？" },
      { id: 29, category: "Ⅵ．社会への問題意識", question: "「自分が何とかしたい」と感じた社会問題はありますか？" },
      { id: 30, category: "Ⅵ．社会への問題意識", question: "助けたいと思う対象はいますか？" },
      { id: 31, category: "Ⅵ．社会への問題意識", question: "なぜ、その対象に関心を持ったのだと思いますか？" },
      { id: 32, category: "Ⅵ．社会への問題意識", question: "社会問題に関わりたいと思いますか？それとも距離を取りたいですか？" },
      { id: 33, category: "Ⅶ．国際性・文化・地域", question: "海外に行った経験、または特別な地域体験はありますか？" },
      { id: 34, category: "Ⅶ．国際性・文化・地域", question: "自分しかあまり訪れていない、または珍しい場所の経験はありますか？" },
      { id: 35, category: "Ⅶ．国際性・文化・地域", question: "特定の国・地域にルーツがありますか？その国について語る「当事者性」はありますか？" },
      { id: 36, category: "Ⅶ．国際性・文化・地域", question: "将来、海外で生活することを考えていますか？" },
      { id: 37, category: "Ⅶ．国際性・文化・地域", question: "英語を使った仕事に興味はありますか？" },
      { id: 38, category: "Ⅶ．国際性・文化・地域", question: "日本で暮らすなら、都市部と地方、どちらを選びたいですか？" },
      { id: 39, category: "Ⅷ．仕事観・将来像", question: "将来、どのような仕事に関わりたいですか？" },
      { id: 40, category: "Ⅷ．仕事観・将来像", question: "現場で手を動かしたいですか？それとも全体を動かす立場ですか？" },
      { id: 41, category: "Ⅷ．仕事観・将来像", question: "リーダーとして前に立ちたいですか？それとも支える役割が合っていますか？" },
      { id: 42, category: "Ⅷ．仕事観・将来像", question: "起業や大きな挑戦に興味はありますか？" },
      { id: 43, category: "Ⅷ．仕事観・将来像", question: "安定を重視する生き方と、挑戦を重視する生き方、どちらに近いですか？" },
      { id: 44, category: "Ⅷ．仕事観・将来像", question: "最先端技術と、文学・教育・伝統文化、どちらに惹かれますか？" },
      { id: 45, category: "Ⅸ．人物像・ロールモデル", question: "憧れの人、尊敬する人、ロールモデルはいますか？" },
      { id: 46, category: "Ⅹ．総合整理・次のステップ", question: "ここまでの回答を見返して、何度も出てきたキーワードは何ですか？" },
      { id: 47, category: "Ⅹ．総合整理・次のステップ", question: "自分の中で「一貫しているテーマ」は何だと思いますか？" },
      { id: 48, category: "Ⅹ．総合整理・次のステップ", question: "これは他の人にはあまり語れない、自分だけの視点だと思えるものは何ですか？" },
      { id: 49, category: "Ⅹ．総合整理・次のステップ", question: "そのテーマは、どの学問分野と結びつきそうですか？" },
      { id: 50, category: "Ⅹ．総合整理・次のステップ", question: "その学問を通して、社会とどのように関わりたいですか？" }
    ];

    // テーマデータを読み込み
    async function loadThemeData() {
      const themeId = document.getElementById('themeSelect').value;

      if (!themeId) {
        alert('テーマを選択してください');
        return;
      }

      if (!selectedStudentId) {
        alert('先に生徒を選択してください');
        return;
      }

      selectedThemeId = themeId;
      showLoading(true);

      try {
        // インプット進捗を取得
        const inputUrl = `${API_URL}?action=getInputProgress&studentId=${selectedStudentId}&themeId=${themeId}`;
        const inputRes = await fetch(inputUrl);
        const inputData = await inputRes.json();

        materialsData.inputProgress = {
          checked: inputData.checkedCount || 0,
          total: inputData.totalItems || 31
        };

        // 小テスト結果を取得
        const quizUrl = `${API_URL}?action=getQuizResults&studentId=${selectedStudentId}&themeId=${themeId}`;
        const quizRes = await fetch(quizUrl);
        const quizData = await quizRes.json();

        if (quizData.success && quizData.results && quizData.results.length > 0) {
          const results = quizData.results;
          const latestQuiz = results[results.length - 1];

          // 最高スコアを計算
          let bestScore = 0;
          let bestTotal = 10;
          results.forEach(r => {
            if (r.score > bestScore) {
              bestScore = r.score;
              bestTotal = r.total;
            }
          });

          materialsData.quizResult = {
            attempts: results.length,
            bestScore: bestScore,
            bestTotal: bestTotal,
            latestScore: latestQuiz.score,
            latestTotal: latestQuiz.total,
            passed: results.some(r => r.passed)
          };
        } else {
          materialsData.quizResult = null;
        }

        // アウトプット回答を取得
        const outputUrl = `${API_URL}?action=getOutputAnswers&studentId=${selectedStudentId}&themeId=${themeId}`;
        console.log('Output URL:', outputUrl);
        const outputRes = await fetch(outputUrl);
        const outputData = await outputRes.json();
        console.log('Output API Response:', outputData);

        materialsData.outputAnswers = outputData.answers || {};
        console.log('Stored answers:', materialsData.outputAnswers);

        // 講師コメントを取得
        const commentUrl = `${API_URL}?action=getTeacherComments&studentId=${selectedStudentId}&themeId=${themeId}`;
        const commentRes = await fetch(commentUrl);
        const commentData = await commentRes.json();

        materialsData.teacherComments = commentData.comments || {};

        // UIを更新
        renderMaterialsProgress();
        renderOutputViewer();

        document.getElementById('materialsProgressSummary').style.display = 'grid';
        document.getElementById('outputViewer').style.display = 'grid';
        document.getElementById('materialsEmpty').style.display = 'none';

      } catch (error) {
        console.error('Error loading theme data:', error);
        alert('データの読み込みに失敗しました');
      } finally {
        showLoading(false);
      }
    }

    // 進捗サマリーを描画
    function renderMaterialsProgress() {
      // インプット進捗
      const inputPercent = Math.round((materialsData.inputProgress.checked / materialsData.inputProgress.total) * 100);
      document.getElementById('inputProgressValue').textContent = `${materialsData.inputProgress.checked}/${materialsData.inputProgress.total}`;
      document.getElementById('inputProgressBar').style.width = inputPercent + '%';

      // 確認テスト
      const quizCard = document.getElementById('quizProgressCard');
      const quizValue = document.getElementById('quizProgressValue');
      const quizBar = document.getElementById('quizProgressBar');

      if (materialsData.quizResult) {
        const q = materialsData.quizResult;

        // 表示: 受験回数 / 最高 / 最新
        let quizHtml = `
          <div class="quiz-result-main">${q.bestScore}/${q.bestTotal}</div>
          <div class="quiz-result-sub">受験${q.attempts}回 / 最新${q.latestScore}/${q.latestTotal}</div>
        `;
        quizValue.innerHTML = quizHtml;

        // 合格判定でカードの色を変更
        if (quizCard) {
          if (q.passed) {
            quizCard.classList.add('passed');
            quizCard.classList.remove('failed');
          } else {
            quizCard.classList.add('failed');
            quizCard.classList.remove('passed');
          }
        }

        // プログレスバー（最高スコア基準）
        const percent = Math.round((q.bestScore / q.bestTotal) * 100);
        if (quizBar) quizBar.style.width = percent + '%';
      } else {
        quizValue.innerHTML = '<span class="quiz-not-taken">未受験</span>';
        if (quizCard) quizCard.classList.remove('passed', 'failed');
        if (quizBar) quizBar.style.width = '0%';
      }

      // アウトプット進捗
      const answeredCount = Object.keys(materialsData.outputAnswers).filter(k => materialsData.outputAnswers[k] && materialsData.outputAnswers[k].trim()).length;
      const totalQuestions = 50;
      const outputPercent = Math.round((answeredCount / totalQuestions) * 100);
      document.getElementById('outputProgressValue').textContent = `${answeredCount}/${totalQuestions}`;
      document.getElementById('outputProgressBar').style.width = outputPercent + '%';
    }

    // アウトプットビューアを描画
    function renderOutputViewer() {
      const listContainer = document.getElementById('outputQuestionsList');

      // カテゴリごとにグループ化
      const categories = [];
      const categoryMap = {};

      theme2OutputQuestions.forEach(q => {
        if (!categoryMap[q.category]) {
          categoryMap[q.category] = { category: q.category, questions: [] };
          categories.push(categoryMap[q.category]);
        }
        categoryMap[q.category].questions.push({ id: q.id, text: q.question });
      });

      let html = '';
      categories.forEach(category => {
        html += `
          <div class="output-category">
            <div class="output-category-header collapsed" onclick="toggleCategory(this)">
              <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
              ${escapeHtml(category.category)}
            </div>
            <div class="output-category-items" style="display:none;">
        `;

        category.questions.forEach(q => {
          const hasAnswer = materialsData.outputAnswers[`q${q.id}`] && materialsData.outputAnswers[`q${q.id}`].trim();
          html += `
            <div class="output-question-item ${hasAnswer ? 'answered' : ''}" data-qid="${q.id}" onclick="selectQuestion(${q.id})">
              <span class="output-question-number">Q${q.id}</span>
              <span class="output-question-text">${escapeHtml(q.text)}</span>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      listContainer.innerHTML = html;
      lucide.createIcons();

      // 最初の質問を選択
      selectQuestion(1);

      lucide.createIcons();
    }

    // カテゴリの折りたたみ
    function toggleCategory(header) {
      const items = header.nextElementSibling;

      if (!items) {
        console.error('items not found');
        return;
      }

      const isCollapsed = items.style.display === 'none';

      if (isCollapsed) {
        // 開く
        header.classList.remove('collapsed');
        items.style.display = 'block';
      } else {
        // 閉じる
        header.classList.add('collapsed');
        items.style.display = 'none';
      }
    }

    // 質問を選択
    function selectQuestion(qid) {
      currentQuestionIndex = qid;

      // アクティブ状態を更新
      document.querySelectorAll('.output-question-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.qid) === qid);
      });

      // 質問を探す
      const questionObj = theme2OutputQuestions.find(q => q.id === qid);
      const questionText = questionObj ? questionObj.question : '';

      // 中央パネルを更新
      document.getElementById('currentQuestionNum').textContent = `Q${qid}`;
      document.getElementById('currentQuestionText').textContent = questionText;

      // 生徒の回答を表示
      const answer = materialsData.outputAnswers[`q${qid}`] || '';
      const answerEl = document.getElementById('currentAnswerText');
      if (answer.trim()) {
        answerEl.innerHTML = escapeHtml(answer);
      } else {
        answerEl.innerHTML = '<div class="output-answer-empty">未回答</div>';
      }

      // 編集モードをリセット
      cancelEditAnswer();

      // 講師コメント一覧を表示
      renderCommentList();

      // 新規コメント欄をクリア
      document.getElementById('teacherCommentTextarea').value = '';

      // ナビボタンの状態を更新
      document.getElementById('prevQuestionBtn').disabled = qid <= 1;
      document.getElementById('nextQuestionBtn').disabled = qid >= 50;

      // コメントステータスをクリア
      document.getElementById('commentStatus').textContent = '';
    }

    // 前の質問
    function prevQuestion() {
      if (currentQuestionIndex > 1) {
        selectQuestion(currentQuestionIndex - 1);
      }
    }

    // 次の質問
    function nextQuestion() {
      if (currentQuestionIndex < 50) {
        selectQuestion(currentQuestionIndex + 1);
      }
    }

    // ログイン中の講師情報を取得
    function getCurrentTeacher() {
      try {
        const sessionStr = localStorage.getItem('eqao_staff_session');
        if (sessionStr) {
          const session = JSON.parse(sessionStr);
          return {
            teacherId: session.employeeId || '',
            teacherName: session.name || ''
          };
        }
      } catch (e) {
        console.error('講師セッション取得エラー:', e);
      }
      return { teacherId: '', teacherName: '' };
    }

    // 講師コメントを保存（新規追加）
    async function saveTeacherComment() {
      if (!selectedStudentId || !selectedThemeId) return;

      const comment = document.getElementById('teacherCommentTextarea').value.trim();
      if (!comment) {
        alert('コメントを入力してください');
        return;
      }

      const btn = document.querySelector('.comment-save-btn');
      const status = document.getElementById('commentStatus');
      const teacher = getCurrentTeacher();

      if (!teacher.teacherId || !teacher.teacherName) {
        alert('講師情報が取得できません。再ログインしてください。');
        return;
      }

      btn.disabled = true;

      try {
        const url = `${API_URL}?action=saveTeacherComment&studentId=${selectedStudentId}&themeId=${selectedThemeId}&questionId=${currentQuestionIndex}&comment=${encodeURIComponent(comment)}&teacherName=${encodeURIComponent(teacher.teacherName)}&teacherId=${encodeURIComponent(teacher.teacherId)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          // テキストエリアをクリア
          document.getElementById('teacherCommentTextarea').value = '';

          // コメント一覧を再読み込み
          await refreshTeacherComments();

          status.textContent = '✓ 投稿しました';
          status.classList.add('saved');
        } else {
          throw new Error(result.error);
        }

        setTimeout(() => {
          status.textContent = '';
          status.classList.remove('saved');
        }, 3000);

      } catch (error) {
        console.error('Error saving comment:', error);
        status.textContent = '投稿に失敗しました';
      } finally {
        btn.disabled = false;
      }
    }

    // 編集中のコメントID
    let editingCommentId = null;

    // コメント編集モーダルを開く
    function editTeacherComment(commentId, currentText) {
      editingCommentId = commentId;
      document.getElementById('editCommentText').value = currentText;
      document.getElementById('commentEditModal').classList.add('show');
      lucide.createIcons();
    }

    // コメント編集モーダルを閉じる
    function closeCommentEditModal() {
      document.getElementById('commentEditModal').classList.remove('show');
      editingCommentId = null;
    }

    // コメント編集を送信
    async function submitCommentEdit() {
      if (!editingCommentId) return;

      const newText = document.getElementById('editCommentText').value.trim();
      if (!newText) {
        alert('コメントを入力してください');
        return;
      }

      const teacher = getCurrentTeacher();

      try {
        const url = `${API_URL}?action=updateTeacherComment&commentId=${encodeURIComponent(editingCommentId)}&comment=${encodeURIComponent(newText)}&teacherId=${encodeURIComponent(teacher.teacherId)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          closeCommentEditModal();
          await refreshTeacherComments();
        } else {
          alert(result.error || '編集に失敗しました');
        }
      } catch (error) {
        console.error('Error editing comment:', error);
        alert('編集に失敗しました');
      }
    }

    // 講師コメントを削除
    async function deleteTeacherComment(commentId) {
      if (!confirm('このコメントを削除しますか？')) return;

      const teacher = getCurrentTeacher();

      try {
        const url = `${API_URL}?action=deleteTeacherComment&commentId=${encodeURIComponent(commentId)}&teacherId=${encodeURIComponent(teacher.teacherId)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          await refreshTeacherComments();
        } else {
          alert(result.error || '削除に失敗しました');
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        alert('削除に失敗しました');
      }
    }

    // 講師コメントを再読み込み
    async function refreshTeacherComments() {
      if (!selectedStudentId || !selectedThemeId) return;

      try {
        const url = `${API_URL}?action=getTeacherComments&studentId=${selectedStudentId}&themeId=${selectedThemeId}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          materialsData.teacherComments = result.comments || {};
          renderCommentList();
        }
      } catch (error) {
        console.error('Error refreshing comments:', error);
      }
    }

    // コメント一覧を描画
    function renderCommentList() {
      const container = document.getElementById('commentList');
      const key = `q${currentQuestionIndex}`;
      const comments = materialsData.teacherComments[key] || [];
      const teacher = getCurrentTeacher();

      if (comments.length === 0) {
        container.innerHTML = `
          <div class="comment-empty">
            <i data-lucide="message-circle" style="width:32px;height:32px;"></i>
            <p>コメントはまだありません</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      let html = '';
      comments.forEach(c => {
        const isMine = String(c.teacherId) === String(teacher.teacherId);
        const date = new Date(c.createdAt);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

        html += `
          <div class="comment-item ${isMine ? 'mine' : ''}">
            <div class="comment-item-header">
              <div class="comment-item-meta">
                <span class="comment-item-teacher">${escapeHtml(c.teacherName)}</span>
                <span class="comment-item-date">${dateStr}</span>
              </div>
              ${isMine ? `
              <div class="comment-item-actions">
                <button class="comment-action-btn" onclick="editTeacherComment('${c.commentId}', decodeURIComponent('${encodeURIComponent(c.comment)}'))">
                  <i data-lucide="pencil" style="width:12px;height:12px;"></i>
                  編集
                </button>
                <button class="comment-action-btn delete" onclick="deleteTeacherComment('${c.commentId}')">
                  <i data-lucide="trash-2" style="width:12px;height:12px;"></i>
                  削除
                </button>
              </div>
              ` : ''}
            </div>
            <div class="comment-item-text">${escapeHtml(c.comment)}</div>
          </div>
        `;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // 生徒回答を更新
    async function refreshStudentAnswer() {
      const btn = document.querySelector('.answer-refresh-btn');
      if (btn) btn.classList.add('loading');

      try {
        // 現在のテーマの回答を再取得
        const themeId = document.getElementById('themeSelect')?.value || '2';
        const outputUrl = `${API_URL}?action=getOutputAnswers&studentId=${selectedStudentId}&themeId=${themeId}`;
        const outputRes = await fetch(outputUrl);
        const outputData = await outputRes.json();

        if (outputData.success && outputData.answers) {
          materialsData.outputAnswers = outputData.answers;

          // 質問一覧の回答済みマークを更新
          document.querySelectorAll('.output-question-item').forEach(item => {
            const qid = parseInt(item.dataset.qid);
            const hasAnswer = materialsData.outputAnswers[`q${qid}`] && materialsData.outputAnswers[`q${qid}`].trim();
            item.classList.toggle('answered', !!hasAnswer);
          });

          // 進捗サマリーを更新
          renderMaterialsProgress();

          // 現在表示中の質問を再描画
          if (currentQuestionIndex) {
            selectQuestion(currentQuestionIndex);
          }
        }

        // 成功フィードバック
        if (btn) {
          btn.classList.remove('loading');
          const icon = btn.querySelector('i');
          if (icon) {
            icon.setAttribute('data-lucide', 'check');
            lucide.createIcons();
            setTimeout(() => {
              icon.setAttribute('data-lucide', 'refresh-cw');
              lucide.createIcons();
            }, 1500);
          }
        }
      } catch (error) {
        console.error('回答更新エラー:', error);
        if (btn) btn.classList.remove('loading');
      }
    }

    // ===== 生徒回答編集機能 =====

    // 編集モード開始
    function startEditAnswer() {
      const displayMode = document.getElementById('answerDisplayMode');
      const editMode = document.getElementById('answerEditMode');
      const textarea = document.getElementById('answerEditTextarea');

      // 現在の回答をテキストエリアにセット
      const currentAnswer = materialsData.outputAnswers[`q${currentQuestionIndex}`] || '';
      textarea.value = currentAnswer;

      // モード切り替え
      displayMode.classList.add('hidden');
      editMode.classList.add('active');

      // ステータスクリア
      document.getElementById('answerEditStatus').textContent = '';

      textarea.focus();
      lucide.createIcons();
    }

    // 編集キャンセル
    function cancelEditAnswer() {
      const displayMode = document.getElementById('answerDisplayMode');
      const editMode = document.getElementById('answerEditMode');

      displayMode.classList.remove('hidden');
      editMode.classList.remove('active');

      document.getElementById('answerEditStatus').textContent = '';
    }

    // 編集した回答を保存
    async function saveEditedAnswer() {
      if (!selectedStudentId || !selectedThemeId) {
        alert('生徒とテーマを選択してください');
        return;
      }

      const textarea = document.getElementById('answerEditTextarea');
      const newAnswer = textarea.value.trim();
      const btn = document.getElementById('answerSaveBtn');
      const status = document.getElementById('answerEditStatus');
      const teacher = getCurrentTeacher();

      btn.disabled = true;
      status.textContent = '保存中...';
      status.classList.remove('saved');

      try {
        const url = `${API_URL}?action=saveOutputAnswer&studentId=${selectedStudentId}&themeId=${selectedThemeId}&questionId=${currentQuestionIndex}&answer=${encodeURIComponent(newAnswer)}&editorName=${encodeURIComponent(teacher.teacherName)}&editorId=${encodeURIComponent(teacher.teacherId)}`;

        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          // ローカルデータを更新
          materialsData.outputAnswers[`q${currentQuestionIndex}`] = newAnswer;

          // 表示を更新
          const answerEl = document.getElementById('currentAnswerText');
          if (newAnswer) {
            answerEl.innerHTML = escapeHtml(newAnswer);
          } else {
            answerEl.innerHTML = '<div class="output-answer-empty">未回答</div>';
          }

          // 質問リストの回答済みマークを更新
          document.querySelectorAll('.output-question-item').forEach(item => {
            const qid = parseInt(item.dataset.qid);
            if (qid === currentQuestionIndex) {
              item.classList.toggle('answered', !!newAnswer);
            }
          });

          // 進捗サマリーを更新
          renderMaterialsProgress();

          // 編集モードを終了
          cancelEditAnswer();

          status.textContent = '✓ 保存しました';
          status.classList.add('saved');
        } else {
          throw new Error(result.error || '保存に失敗しました');
        }

      } catch (error) {
        console.error('回答保存エラー:', error);
        status.textContent = '保存に失敗しました';
        status.classList.remove('saved');
      } finally {
        btn.disabled = false;

        setTimeout(() => {
          status.textContent = '';
          status.classList.remove('saved');
        }, 3000);
      }
    }

    // ===== ユーザーメニュー開閉 =====
    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('show');
    }

    // メニュー外クリックで閉じる
    document.addEventListener('click', (e) => {
      const userMenu = document.querySelector('.user-menu');
      const dropdown = document.getElementById('userDropdown');

      if (userMenu && dropdown && !userMenu.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    // ===== ログアウト =====
    function handleLogout() {
      if (confirm('ログアウトしますか？')) {
        localStorage.removeItem('eqao_staff_session');
        window.location.href = 'login.html';
      }
    }
  </script>
</body>

</html>