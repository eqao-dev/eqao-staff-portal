<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>授業確定 | EQAO スタッフポータル</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
        }

        /* ヘッダー */
        .header {
            background: #111;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #aaa;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .header-divider {
            width: 1px;
            height: 20px;
            background: #444;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        /* ユーザーメニュー */
        .user-menu {
            position: relative;
        }

        .user-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .user-name {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 200;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-name {
            font-size: 14px;
            font-weight: 600;
            color: #111;
            margin-bottom: 2px;
        }

        .dropdown-id {
            font-size: 12px;
            color: #888;
        }

        .dropdown-menu {
            padding: 8px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            font-family: inherit;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
            color: #111;
        }

        .dropdown-item.danger {
            color: #ef4444;
        }

        .dropdown-item.danger:hover {
            background: #fef2f2;
        }

        .dropdown-divider {
            height: 1px;
            background: #f0f0f0;
            margin: 4px 8px;
        }

        /* メインコンテンツ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* ページヘッダー */
        .page-header {
            margin-bottom: 24px;
        }

        .page-header-top {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .page-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            color: #111;
        }

        .page-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }

        .target-month {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 14px 20px;
            text-align: center;
        }

        .stat-card .label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
        }

        .stat-card .value-row {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #111;
        }

        .stat-card .unit {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border: none;
            color: white;
        }

        .stat-card.highlight .label {
            color: rgba(255, 255, 255, 0.8);
        }

        .stat-card.highlight .value {
            color: white;
        }

        .stat-card.highlight .unit {
            color: rgba(255, 255, 255, 0.8);
        }

        /* 生徒一覧 */
        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: #111;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .student-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-card:hover {
            border-color: #0ea5e9;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
            transform: translateY(-2px);
        }

        .student-card.selected {
            border-color: #0ea5e9;
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .student-name {
            font-weight: 700;
            font-size: 15px;
            color: #111;
        }

        .student-id {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-badge.complete {
            background: #e0f2fe;
            color: #0284c7;
        }

        .status-badge.partial {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.pending {
            background: #fee2e2;
            color: #dc2626;
        }

        .progress-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .progress-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-label {
            font-size: 12px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-fill.normal {
            background: linear-gradient(90deg, #0ea5e9, #0284c7);
        }

        .progress-fill.english {
            background: linear-gradient(90deg, #8b5cf6, #6d28d9);
        }

        /* モーダル */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #111;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        /* 確定済み授業セクション */
        .confirmed-section {
            margin-bottom: 24px;
        }

        .confirmed-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #111;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cancel-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .cancel-btn:hover {
            opacity: 1;
        }

        /* 授業追加フォーム */
        .add-lesson-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #111;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-lesson-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e5e5;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #334155;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0ea5e9;
        }

        .add-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .add-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 生徒希望日時 */
        .availability-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        .availability-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #111;
            margin-bottom: 12px;
        }

        .availability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .availability-slot {
            padding: 10px 12px;
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .availability-slot:hover {
            background: #bae6fd;
        }

        .availability-slot.used {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .availability-slot .slot-date {
            font-weight: 600;
            color: #0369a1;
        }

        .availability-slot.used .slot-date {
            color: #64748b;
        }

        .availability-slot .slot-time {
            font-size: 12px;
            color: #0284c7;
        }

        .availability-slot.used .slot-time {
            color: #94a3b8;
        }

        /* 警告メッセージ */
        .warning-message {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #92400e;
        }

        /* 空状態 */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state i {
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ローディング */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* トースト */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #111;
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 300;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.success {
            background: #0284c7;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* フッター */
        .footer {
            text-align: center;
            padding: 32px 24px;
            margin-top: 20px;
        }

        .footer-text {
            font-size: 13px;
            color: #999;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-card {
                padding: 10px 8px;
            }

            .stat-card .label {
                font-size: 10px;
                margin-bottom: 4px;
            }

            .stat-card .value {
                font-size: 20px;
            }

            .stat-card .unit {
                font-size: 11px;
            }

            .progress-section {
                grid-template-columns: 1fr;
            }

            .user-name {
                display: none;
            }

            /* モーダル */
            .modal-overlay {
                padding: 10px;
            }

            .modal {
                max-height: 95vh;
                border-radius: 12px;
            }

            .modal-header {
                padding: 14px 16px;
            }

            .modal-header h2 {
                font-size: 14px;
            }

            .modal-body {
                padding: 16px;
            }

            /* サマリーバッジ */
            .confirmed-section>div[style*="display:flex"] {
                flex-direction: column;
                gap: 8px;
            }

            /* テーブル */
            .confirmed-section table {
                font-size: 12px;
            }

            .confirmed-section th,
            .confirmed-section td {
                padding: 6px 8px !important;
            }

            /* 形態・種類列を非表示 */
            .confirmed-section th:nth-child(4),
            .confirmed-section td:nth-child(4),
            .confirmed-section th:nth-child(5),
            .confirmed-section td:nth-child(5) {
                display: none;
            }

            /* フォーム */
            .form-row {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .add-lesson-form {
                padding: 14px;
            }

            .add-btn {
                width: 100%;
                justify-content: center;
            }

            /* 希望日時グリッド */
            .availability-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .availability-slot {
                padding: 8px 10px;
                font-size: 12px;
            }

            /* 警告メッセージ */
            .warning-message {
                font-size: 12px;
                padding: 10px 12px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="category-schedule.html" class="back-btn">
                    <i data-lucide="arrow-left" style="width:16px;height:16px;"></i>
                    戻る
                </a>
                <div class="header-divider"></div>
                <span class="header-title">授業確定</span>
            </div>
            <!-- ユーザーメニュー -->
            <div class="user-menu">
                <button class="user-btn" id="userBtn" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">-</div>
                    <span class="user-name" id="userName">ログイン中</span>
                    <i data-lucide="chevron-down" style="width:16px;height:16px;"></i>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-name" id="dropdownName">-</div>
                        <div class="dropdown-id" id="dropdownId">-</div>
                    </div>
                    <div class="dropdown-menu">
                        <a href="my-schedule.html" class="dropdown-item">
                            <i data-lucide="calendar" style="width:16px;height:16px;"></i>
                            マイスケジュール
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item danger" onclick="handleLogout()">
                            <i data-lucide="log-out" style="width:16px;height:16px;"></i>
                            ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- ページヘッダー -->
        <div class="page-header">
            <div class="page-header-top">
                <div class="page-icon">
                    <i data-lucide="calendar-check" style="width:24px;height:24px;"></i>
                </div>
                <h1 class="page-title">授業確定</h1>
            </div>
            <div class="page-meta">
                <span class="target-month" id="monthDisplay">2026年2月</span>
            </div>
        </div>
        <!-- 統計カード -->
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="label">担当生徒数</div>
                <div class="value-row"><span class="value" id="totalStudents">-</span><span class="unit">名</span></div>
            </div>
            <div class="stat-card">
                <div class="label">確定済み / 総コマ数</div>
                <div class="value-row"><span class="value"><span id="confirmedLessons">-</span> / <span
                            id="totalLessons">-</span></span><span class="unit">コマ</span></div>
            </div>
            <div class="stat-card">
                <div class="label">未確定コマ数</div>
                <div class="value-row"><span class="value" id="remainingLessons">-</span><span class="unit">コマ</span>
                </div>
            </div>
        </div>

        <!-- 生徒一覧 -->
        <div class="section-title">
            <i data-lucide="users" style="width:20px;height:20px;"></i>
            担当生徒一覧
        </div>

        <div id="studentListContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p class="footer-text">© 2026 EQAO Education Group.</p>
    </footer>

    <!-- 授業確定モーダル -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">授業確定</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i data-lucide="x" style="width:24px;height:24px;"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>

    <!-- トースト -->
    <div class="toast" id="toast">
        <i data-lucide="check-circle" style="width:20px;height:20px;"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        // 定数
        const API_URL = 'https://script.google.com/macros/s/AKfycbyFJMfjgZzOw9v16PEoQQrRqqYe__oSn6zHdajEXdeXaUf6ACxwBhcMaGf449Qju-t-/exec';

        // グローバル変数
        let currentUser = null;
        let yearMonth = '';
        let assignments = [];
        let confirmedLessons = [];
        let selectedStudent = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
        });

        // 認証チェック
        function checkAuth() {
            const session = localStorage.getItem('eqao_staff_session');

            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const data = JSON.parse(session);

                // 有効期限チェック
                if (Date.now() > data.expiresAt) {
                    localStorage.removeItem('eqao_staff_session');
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = {
                    employeeId: data.employeeId,
                    name: data.name,
                    email: data.email
                };

                displayUserInfo();
                initPage();

            } catch (error) {
                console.error('認証エラー:', error);
                localStorage.removeItem('eqao_staff_session');
                window.location.href = 'login.html';
            }
        }

        // ユーザー情報表示
        function displayUserInfo() {
            const name = currentUser.name || currentUser.employeeId || '-';
            const initial = name.charAt(0).toUpperCase();

            document.getElementById('userAvatar').textContent = initial;
            document.getElementById('userName').textContent = name;
            document.getElementById('dropdownName').textContent = name;
            document.getElementById('dropdownId').textContent = `ID: ${currentUser.employeeId}`;
        }

        // ユーザーメニュー開閉
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // メニュー外クリックで閉じる
        document.addEventListener('click', (e) => {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');

            if (userMenu && !userMenu.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // ログアウト
        function handleLogout() {
            if (confirm('ログアウトしますか？')) {
                localStorage.removeItem('eqao_staff_session');
                window.location.href = 'login.html';
            }
        }

        // ページ初期化
        async function initPage() {
            // 対象年月を取得
            const settingsRes = await fetch(`${API_URL}?action=getScheduleSettings`);
            const settingsData = await settingsRes.json();

            if (settingsData.success && settingsData.data) {
                yearMonth = settingsData.data['対象年月'] || getDefaultYearMonth();
            } else {
                yearMonth = getDefaultYearMonth();
            }

            // 年月表示を更新
            updateMonthDisplay();

            // データ読み込み
            await loadData();
        }

        // デフォルト年月（翌月）
        function getDefaultYearMonth() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 2;
            if (month > 12) {
                month = 1;
                year++;
            }
            return `${year}-${String(month).padStart(2, '0')}`;
        }

        // 年月表示更新
        function updateMonthDisplay() {
            const [year, month] = yearMonth.split('-');
            document.getElementById('monthDisplay').textContent = `${year}年${parseInt(month)}月`;
        }

        // データ読み込み
        async function loadData() {
            try {
                // 講師の割当一覧を取得
                const assignRes = await fetch(`${API_URL}?action=getMyAssignmentsForConfirmation&instructorId=${currentUser.employeeId}&yearMonth=${yearMonth}`);
                const assignData = await assignRes.json();

                console.log('=== デバッグ情報 ===');
                console.log('employeeId:', currentUser.employeeId);
                console.log('yearMonth:', yearMonth);
                console.log('assignData:', assignData);

                if (assignData.success) {
                    assignments = assignData.data;
                }

                // 確定済み授業を取得
                const confirmedRes = await fetch(`${API_URL}?action=getConfirmedLessons&yearMonth=${yearMonth}&instructorId=${currentUser.employeeId}`);
                const confirmedData = await confirmedRes.json();

                if (confirmedData.success) {
                    confirmedLessons = confirmedData.data;
                }

                // 画面更新
                updateStats();
                renderStudentList();

            } catch (error) {
                console.error('データ取得エラー:', error);
                showToast('データの取得に失敗しました', 'error');
            }
        }

        // 統計更新
        function updateStats() {
            let totalNormal = 0;
            let totalEnglish = 0;
            let confirmedNormal = 0;
            let confirmedEnglish = 0;

            assignments.forEach(a => {
                totalNormal += a.normalAssigned || 0;
                totalEnglish += a.englishAssigned || 0;
                confirmedNormal += a.normalConfirmed || 0;
                confirmedEnglish += a.englishConfirmed || 0;
            });

            const total = totalNormal + totalEnglish;
            const confirmed = confirmedNormal + confirmedEnglish;

            document.getElementById('totalStudents').textContent = assignments.length;
            document.getElementById('totalLessons').textContent = total;
            document.getElementById('confirmedLessons').textContent = confirmed;
            document.getElementById('remainingLessons').textContent = total - confirmed;
        }

        // 生徒一覧描画
        function renderStudentList() {
            const container = document.getElementById('studentListContainer');

            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="inbox" style="width:48px;height:48px;"></i>
                        <p>今月の割当はありません</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            let html = '<div class="student-list">';

            assignments.forEach(student => {
                const totalAssigned = (student.normalAssigned || 0) + (student.englishAssigned || 0);
                const totalConfirmed = (student.normalConfirmed || 0) + (student.englishConfirmed || 0);

                let statusClass = 'pending';
                let statusText = '未確定';
                if (totalConfirmed >= totalAssigned && totalAssigned > 0) {
                    statusClass = 'complete';
                    statusText = '完了';
                } else if (totalConfirmed > 0) {
                    statusClass = 'partial';
                    statusText = '確定中';
                }

                const normalPercent = student.normalAssigned > 0
                    ? Math.min(100, (student.normalConfirmed / student.normalAssigned) * 100)
                    : 0;
                const englishPercent = student.englishAssigned > 0
                    ? Math.min(100, (student.englishConfirmed / student.englishAssigned) * 100)
                    : 0;

                html += `
                    <div class="student-card" onclick="openStudentModal('${student.studentId}')">
                        <div class="student-card-header">
                            <div>
                                <div class="student-name">${student.studentName}</div>
                                <div class="student-id">ID: ${student.studentId}</div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="progress-section">
                            ${student.normalAssigned > 0 ? `
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span>通常</span>
                                    <span>${student.normalConfirmed || 0} / ${student.normalAssigned}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill normal" style="width: ${normalPercent}%"></div>
                                </div>
                            </div>
                            ` : ''}
                            ${student.englishAssigned > 0 ? `
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span>英語</span>
                                    <span>${student.englishConfirmed || 0} / ${student.englishAssigned}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill english" style="width: ${englishPercent}%"></div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            lucide.createIcons();
        }

        // 生徒モーダルを開く
        async function openStudentModal(studentId) {
            selectedStudent = assignments.find(a => a.studentId === studentId);
            if (!selectedStudent) return;

            document.getElementById('modalTitle').textContent = `${selectedStudent.studentName} の授業確定`;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            document.getElementById('confirmModal').classList.add('active');

            // 生徒の希望日時を取得
            let availability = [];
            try {
                const res = await fetch(`${API_URL}?action=getStudentAvailabilityForConfirmation&studentId=${studentId}&yearMonth=${yearMonth}`);
                const data = await res.json();
                if (data.success) {
                    availability = data.data;
                }
            } catch (error) {
                console.error('希望日時取得エラー:', error);
            }

            // この生徒の確定済み授業
            const studentConfirmed = confirmedLessons.filter(l => l.studentId === studentId && l.isMyLesson);

            renderModalContent(availability, studentConfirmed);
        }

        // モーダル内容描画
        function renderModalContent(availability, studentConfirmed) {
            const modalBody = document.getElementById('modalBody');

            // 残りコマ数計算
            const normalRemaining = (selectedStudent.normalAssigned || 0) - (selectedStudent.normalConfirmed || 0);
            const englishRemaining = (selectedStudent.englishAssigned || 0) - (selectedStudent.englishConfirmed || 0);
            const totalRemaining = normalRemaining + englishRemaining;

            let html = '';

            // 警告メッセージ（残りコマがある場合）
            if (totalRemaining > 0) {
                html += `
                    <div class="warning-message">
                        <i data-lucide="alert-triangle" style="width:20px;height:20px;"></i>
                        残り ${totalRemaining} コマの授業日程を確定してください
                        ${normalRemaining > 0 ? `（通常: ${normalRemaining}）` : ''}
                        ${englishRemaining > 0 ? `（英語: ${englishRemaining}）` : ''}
                    </div>
                `;
            }

            // あなたの月間スケジュール（統合版）
            const myAllConfirmed = confirmedLessons.filter(l => l.isMyLesson);
            const thisStudentCount = studentConfirmed.length;

            html += `
                <div class="confirmed-section">
                    <h3>
                        <i data-lucide="calendar" style="width:18px;height:18px;color:#0284c7;"></i>
                        あなたの月間スケジュール
                    </h3>
                    <div style="display:flex;gap:16px;margin:12px 0;">
                        <div style="background:#dbeafe;padding:8px 16px;border-radius:8px;font-size:0.85rem;">
                            <span style="color:#1d4ed8;font-weight:600;">${selectedStudent.studentName}</span>: ${thisStudentCount}コマ確定済み
                        </div>
                        <div style="background:#f1f5f9;padding:8px 16px;border-radius:8px;font-size:0.85rem;">
                            全体: ${myAllConfirmed.length}コマ確定済み
                        </div>
                    </div>
            `;

            if (myAllConfirmed.length === 0) {
                html += '<p style="color:#64748b;font-size:0.85rem;">まだ確定した授業はありません</p>';
            } else {
                html += `
                    <div style="max-height:250px;overflow-y:auto;">
                        <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f1f5f9;text-align:left;position:sticky;top:0;">
                                    <th style="padding:8px 12px;font-weight:600;">日付</th>
                                    <th style="padding:8px 12px;font-weight:600;">時間</th>
                                    <th style="padding:8px 12px;font-weight:600;">生徒</th>
                                    <th style="padding:8px 12px;font-weight:600;">形態</th>
                                    <th style="padding:8px 12px;font-weight:600;">種類</th>
                                    <th style="padding:8px 12px;font-weight:600;"></th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // 日付順にソート
                const sortedLessons = [...myAllConfirmed].sort((a, b) => {
                    const dateCompare = a.date.localeCompare(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.startTime.localeCompare(b.startTime);
                });

                sortedLessons.forEach(lesson => {
                    const isCurrentStudent = lesson.studentId === selectedStudent.studentId;
                    const rowStyle = isCurrentStudent ? 'background:#dbeafe;' : '';
                    html += `
                        <tr style="${rowStyle}border-bottom:1px solid #e2e8f0;">
                            <td style="padding:8px 12px;">${formatDate(lesson.date)} (${lesson.weekday})</td>
                            <td style="padding:8px 12px;">${lesson.startTime}〜${lesson.endTime}</td>
                            <td style="padding:8px 12px;">
                                ${lesson.studentName}
                                ${isCurrentStudent ? '<span style="color:#1d4ed8;font-size:0.7rem;margin-left:4px;">●</span>' : ''}
                            </td>
                            <td style="padding:8px 12px;">${lesson.style || '-'}</td>
                            <td style="padding:8px 12px;">${lesson.courseType || '-'}</td>
                            <td style="padding:8px 12px;">
                                ${isCurrentStudent ? `<button class="cancel-btn" onclick="cancelLesson('${lesson.lessonId}')">取消</button>` : ''}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <p style="font-size:0.75rem;color:#64748b;margin-top:8px;">
                        <span style="color:#1d4ed8;">●</span> 青い行は現在選択中の生徒（${selectedStudent.studentName}）の授業です。取消は選択中の生徒のみ可能です。
                    </p>
                `;
            }

            html += '</div>';

            // 授業追加フォーム
            if (totalRemaining > 0) {
                html += `
                    <div class="add-lesson-section">
                        <h3>
                            <i data-lucide="plus-circle" style="width:18px;height:18px;color:#1e3a5f;"></i>
                            授業を追加
                        </h3>
                        <div class="add-lesson-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>日付</label>
                                    <input type="date" id="lessonDate" min="${yearMonth}-01" max="${getLastDayOfMonth()}">
                                </div>
                        <div class="form-group">
                            <label>開始時間</label>
                                <div style="display:flex;gap:8px;align-items:center;">
                                  <select id="lessonHour" style="flex:1;">
                                   <option value="">時</option>
                                   ${generateHourOptions()}
                                  </select>
                                 <span>:</span>
                        <select id="lessonMinute" style="flex:1;">
                            <option value="">分</option>
                            ${generateMinuteOptions()}
                        </select>
                    </div>
                </div>
                                <div class="form-group">
                                 <label>授業種類</label>
                                 <select id="lessonType">
                                  <option value="通常授業">通常授業</option>
                                  <option value="英語対策">英語対策</option>
                                  <option value="海外コンサル">海外コンサル</option>
                                  <option value="小論文講座">小論文講座</option>
                                 </select>
                                </div>
                                <div class="form-group">
                                    <label>授業形態</label>
                                    <select id="lessonStyle">
                                        <option value="オンライン">オンライン</option>
                                        <option value="校舎">校舎</option>
                                    </select>
                                </div>
                            </div>
                            <button class="add-btn" onclick="confirmLesson()">
                                <i data-lucide="check" style="width:18px;height:18px;"></i>
                                授業を確定する
                            </button>
                        </div>
                    </div>
                `;
            }

            // 生徒の希望日時
            if (availability.length > 0) {
                html += `
                    <div class="availability-section">
                        <h3>
                            <i data-lucide="clock" style="width:18px;height:18px;color:#0284c7;"></i>
                            生徒の希望日時
                        </h3>
                        <div class="availability-grid">
                `;

                availability.forEach(slot => {
                    const isUsed = slot.isAssigned;
                    html += `
                        <div class="availability-slot ${isUsed ? 'used' : ''}" 
                             ${!isUsed && totalRemaining > 0 ? `onclick="fillFromSlot('${slot.date}', '${slot.startTime}', '${slot.style || ''}')"` : ''}>
                            <div class="slot-date">${formatDate(slot.date)} (${slot.weekday})</div>
                            <div class="slot-time">${slot.startTime}〜${slot.endTime}</div>
                            <div style="font-size:0.75rem;color:${slot.style === '校舎' ? '#dc2626' : '#0284c7'};margin-top:2px;">${slot.style || ''}</div>
                            ${isUsed ? '<div style="font-size:0.7rem;color:#94a3b8;">割当済</div>' : ''}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            modalBody.innerHTML = html;
            lucide.createIcons();
        }

        // 希望日時からフォームに入力
        function fillFromSlot(date, time, style) {
            document.getElementById('lessonDate').value = date;

            // 時間を分割して設定
            if (time) {
                const [hour, minute] = time.split(':');
                document.getElementById('lessonHour').value = hour;
                document.getElementById('lessonMinute').value = minute;
            }

            if (style) {
                document.getElementById('lessonStyle').value = style;
            }
        }

        // 日付フォーマット
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
            }
            return dateStr;
        }

        // 月末日を取得
        function getLastDayOfMonth() {
            const [year, month] = yearMonth.split('-').map(Number);
            const lastDay = new Date(year, month, 0).getDate();
            return `${yearMonth}-${String(lastDay).padStart(2, '0')}`;
        }

        // 時間オプション生成（9〜21時）
        function generateHourOptions() {
            let options = '';
            for (let h = 9; h <= 21; h++) {
                const hour = String(h).padStart(2, '0');
                options += `<option value="${hour}">${hour}</option>`;
            }
            return options;
        }

        // 分オプション生成（5分刻み）
        function generateMinuteOptions() {
            let options = '';
            for (let m = 0; m < 60; m += 5) {
                const min = String(m).padStart(2, '0');
                options += `<option value="${min}">${min}</option>`;
            }
            return options;
        }

        // 授業確定
        async function confirmLesson() {
            const date = document.getElementById('lessonDate').value;
            const hour = document.getElementById('lessonHour').value;
            const minute = document.getElementById('lessonMinute').value;
            const courseType = document.getElementById('lessonType').value;
            const style = document.getElementById('lessonStyle').value;

            if (!date || !hour || !minute || !courseType) {
                showToast('日付、時間、授業種類を選択してください', 'error');
                return;
            }

            const startTime = `${hour}:${minute}`;

            const btn = document.querySelector('.add-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> 確定中...';

            try {
                // GETパラメータとして送信（CORS対策）
                const params = new URLSearchParams({
                    action: 'confirmLesson',
                    yearMonth: yearMonth,
                    studentId: selectedStudent.studentId,
                    studentName: selectedStudent.studentName,
                    instructorId: currentUser.employeeId,
                    instructorName: currentUser.name,
                    date: date,
                    startTime: startTime,
                    style: style,
                    courseType: courseType
                });

                const res = await fetch(`${API_URL}?${params.toString()}`);
                const data = await res.json();

                if (data.success) {
                    showToast('授業を確定しました', 'success');
                    await loadData();
                    openStudentModal(selectedStudent.studentId);
                } else {
                    showToast(data.message || '確定に失敗しました', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="check" style="width:18px;height:18px;"></i> 授業を確定する';
                    lucide.createIcons();
                }

            } catch (error) {
                console.error('確定エラー:', error);
                showToast('エラーが発生しました', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="check" style="width:18px;height:18px;"></i> 授業を確定する';
                lucide.createIcons();
            }
        }

        // 授業取消
        async function cancelLesson(lessonId) {
            if (!confirm('この授業を取り消しますか？')) return;

            try {
                const params = new URLSearchParams({
                    action: 'cancelLesson',
                    lessonId: lessonId
                });

                const res = await fetch(`${API_URL}?${params.toString()}`);

                const data = await res.json();

                if (data.success) {
                    showToast('授業を取り消しました', 'success');
                    await loadData();
                    openStudentModal(selectedStudent.studentId);
                } else {
                    showToast(data.message || '取消に失敗しました', 'error');
                }

            } catch (error) {
                console.error('取消エラー:', error);
                showToast('エラーが発生しました', 'error');
            }
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            selectedStudent = null;
        }

        // モーダル外クリックで閉じる
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // トースト表示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>